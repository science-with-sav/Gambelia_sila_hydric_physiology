---
title: "BNLL hydrophysiology analyses"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
```



**Reflection**
Okay, so I have a few different datasets basically. I have a subset of lizards who WERE measured more than once. I think anytime I look at trends over time, to be the most robust, I need to limit the dataset to only those lizards, who were measured more than once. I'm worried that it may be BEST, better than just keeping all the lizards with >1 measurement, to only look at trends over time with only the lizards measured at one time point. I should probably ask Rory. :)

Overall, this very much feels like a mess. There are some very slight trends with different things, but IDK how much truth there is to any of them. 

I think I have most of the water-balance-related things here... And I think for everything over time, Ineed to go back and make it only for the repeat measure lizards. *Then, what do I use the widespread lizard data for, except for the species comparison?*

I still have to do the female reproductive effort stuff.

Then, I will use the radiocollared lizards for phy vs behavior analyses.



# Load in Data

This data was collected during fieldwork with Blunt-nosed Leopard Lizards (*Gambelia sila*) in the Elkhorn Plain of the Carrizo Plain National Monument in California, USA during the 2021 active season (April-August). See published paper (doi) for complete methods and discussion of these analyses. 


```{r}
dat <- read_rds("./data/G_sila_clean_full_dat.RDS")
```



## Variable Explanation









# Does SVL change over time?

I want to know whether SVL changed over time for the individuals who had more than one measurement taken. If it does, then body condition is certainly more informative than mass.

```{r}
# subset
dat_repeats <- dat %>%
  group_by(individual_ID) %>%
  mutate(n = n()) %>%
  dplyr::filter(n>1)
# model
summary(lme4::lmer(data = dat_repeats, 
                   SVL_mm ~ week_num + (1|individual_ID)))
```


There is no meaningful change in SVL for the individuals we were able to measure, so I could use either mass or body condition to estimate body size.



# Check CEWL Covariates

How much is CEWL impacted by the body temperature, ambient temperature, and ambient VPD at the time of CEWL measurement?

It's possible that I may find a relationship between ambient temp and CEWL but not body temp and CEWL because the body temp measurements we took were unfortunately only to the nearest degree...


## Plot

First, make a simple plot of each to look for relationships visually.

```{r}
ggplot(dat) +
  aes(x = cloacal_temp_C,
      y = CEWL_g_m2h,
      color = week
      #color = tmt
        ) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
ggplot(dat) +
  aes(x = msmt_temp_C,
      y = CEWL_g_m2h,
      color = week
      #color = tmt
        ) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
ggplot(dat) +
  aes(x = msmt_VPD_kPa,
      y = CEWL_g_m2h,
      color = week
      #color = tmt
        ) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
```


Across dates, CEWL had no relationship with body temp, ambient temp, or ambient VPD at the time of capture. However, when separated by date, there were relationships. There were no relationships when separated by treatment group. 


## Models

Now, check linear models of the effect of each of body temp, ambient temp, and ambient VPD with the interaction of date on CEWL.

```{r}
summary(lm(data = dat,
           CEWL_g_m2h ~ cloacal_temp_C*week))
summary(lm(data = dat,
           CEWL_g_m2h ~ msmt_temp_C*week))
summary(lm(data = dat,
           CEWL_g_m2h ~ msmt_VPD_kPa*week))
```

CEWL had a positive relationship with each of body temp, ambient temp, and ambient VPD, *but* only for the measurements taken in May (week 3).


## Variance

Let's also check the distribution/range of these covariates, because based on the figures, week 3 had a pretty small range of temperatures and VPDs.

```{r}
dat %>%
  group_by(week) %>%
  summarise(min(cloacal_temp_C, na.rm = T), max(cloacal_temp_C, na.rm = T),
            min(msmt_temp_C, na.rm = T), max(msmt_temp_C, na.rm = T),
            min(msmt_VPD_kPa, na.rm = T), max(msmt_VPD_kPa, na.rm = T))
```

Well... these ranges are not small enough to be meaningless. So, we will have to keep in mind that temperature and VPD should be retained in CEWL models as a covariate.




# Water Balance Metrics

What is the interrelation among water balance metrics CEWL, osmolality, and mass/SMI?

## Models

Check a simple linear model between each set of paired measurements:

```{r}
summary(lm(data = dat,
           CEWL_g_m2h ~ osmolality_mmol_kg_mean))
summary(lm(data = dat,
           CEWL_g_m2h ~ mass_g))
summary(lm(data = dat,
           osmolality_mmol_kg_mean ~ mass_g))
```

There is a small negative correlation between CEWL and osmolality. Neither CEWL or osmolality have a relationship with body mass.


## Plot CEWL ~ Osmolality

Look at a figure of CEWL ~ osmolality:

```{r CEWL osml fig}
ggplot(dat) + 
  aes(x = osmolality_mmol_kg_mean,
      y = CEWL_g_m2h,
      #color = tmt
      color = week
      ) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Plasma Osmolality (mmol/kg)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim(300, 450) +
  #annotate(geom = "text", x = 430, y = 24, label = bquote(''*R^2*'=0.033'), 
   #        size = 7) +
  #ylim(0, 25) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "right"
        ) -> CEWL_osml_fig
CEWL_osml_fig

# export figure
#ggsave(filename = "CEWL_osml_fig.jpeg",
 #      plot = CEWL_osml_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## Week Interaction

Redo CEWL ~ osmolality model with an interaction of date:

```{r}
summary(lm(data = dat, CEWL_g_m2h ~ osmolality_mmol_kg_mean*week))
```


Once again, the relationship is only significant for week 3...


## Lag Effect?

What if I tested week 3 CEWL ~ week 1 osml, or visa versa? This is to look for a lag effect on their relationship, although the time period is likely too long.

First, organize the data:

```{r}
w3_CEWL <- dat %>%
  dplyr::filter(week == 3) %>%
  dplyr::select(individual_ID, CEWL_g_m2h)
w1_osml <- dat %>%
  dplyr::filter(week == 1) %>%
  dplyr::select(individual_ID, osmolality_mmol_kg_mean)
w3_vs_w1 <- w1_osml %>%
  left_join(w3_CEWL, by = 'individual_ID') %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean, CEWL_g_m2h))
w1_CEWL <- dat %>%
  dplyr::filter(week == 1) %>%
  dplyr::select(individual_ID, CEWL_g_m2h)
w3_osml <- dat %>%
  dplyr::filter(week == 3) %>%
  dplyr::select(individual_ID, osmolality_mmol_kg_mean) 
w1_vs_w3 <- w3_osml %>%
  left_join(w1_CEWL, by = 'individual_ID') %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean, CEWL_g_m2h))
```


Next, run models:

```{r}
summary(lm(data = w3_vs_w1, CEWL_g_m2h ~ osmolality_mmol_kg_mean))
summary(lm(data = w1_vs_w3, CEWL_g_m2h ~ osmolality_mmol_kg_mean))
```

It seems very unlikely there is a lag effect, at least at this time scale.



# Supplemental Hydration Treatment Effects


## Calculate Deltas

First, calculate the change in CEWL, osmolality, and mass for each treatment individual that was recaptured between April and May.

```{r}
starting_values <- dat %>%
  #dplyr::filter(tmt != "No Tmt") %>%
  dplyr::filter(month == "April") %>%
  dplyr::select(individual_ID,
                CEWL_April = CEWL_g_m2h,
                osml_April = osmolality_mmol_kg_mean,
                mass_April = mass_g)
dat_tmt_change <- dat %>%
  left_join(starting_values, by = 'individual_ID') %>%
  dplyr::filter(complete.cases(mass_April, CEWL_April)) %>%
  mutate(mass_change_from_April = mass_g - mass_April,
         CEWL_change_from_April = CEWL_g_m2h - CEWL_April,
         osml_change_from_April = osmolality_mmol_kg_mean - osml_April)
dat_tmt_change_May_only <- dat_tmt_change %>%
  dplyr::filter(month == "May")
```



## Plot Change by Tmt

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = mass_change_from_April,
      group = individual_ID,
      #color = sex_M_F
      color = tmt
      ) +
  geom_point() +
  geom_line() +
  theme_bw()
ggplot(dat_tmt_change) +
  aes(x = month,
      y = CEWL_change_from_April,
      group = individual_ID,
      #color = sex_M_F
      color = tmt
      ) +
  geom_point() +
  geom_line() +
  theme_bw()
ggplot(dat_tmt_change) +
  aes(x = month,
      y = osml_change_from_April,
      group = individual_ID,
      #color = sex_M_F
      color = tmt
      ) +
  geom_point() +
  geom_line() +
  theme_bw()
```


It does *not* look like treatment led to any differences in the amount or direction of change in lizard mass, CEWL, or osmolality. Changes were also not consistent by sex.




## Stat Tests of Change

These lm's are doing the same thing as a two-sample t-test, checking whether the means are statistically different. 

```{r}
summary(lm(data = dat_tmt_change_May_only, mass_change_from_April ~ tmt))
summary(lm(data = dat_tmt_change_May_only, CEWL_change_from_April ~ tmt))
summary(lm(data = dat_tmt_change_May_only, osml_change_from_April ~ tmt))
```

Change was not significantly different between treatments for any of the variables. 


Was change overall (across tmts) different from zero?

```{r}
t.test(dat_tmt_change_May_only$mass_change_from_April)
t.test(dat_tmt_change_May_only$CEWL_change_from_April)
t.test(dat_tmt_change_May_only$osml_change_from_April)
```

On average, lizards who were measured in both April and May increased mass, but did not experience a change in osmolality or CEWL. 

What about mass change *during* treatment, when we either gave lizards water to drink or a sham treatment. 

```{r tmt mass change stats}
summary(lm(data = dat, tmt_mass_change_g ~ tmt))
```

So, it did result in a significant change in mass within the same-day water supplementation tmt (vs sham), but only ~1.4g difference, on average.




# Population Change Over Time


## Marginal Means

I want to know whether the average values for all the lizards we measured changes over time. To test this, I can run a linear model, then use emmeans to get the marginal means and confidence intervals for each time point. 

Do this only for lizards with repeat measurements.

info for using emmeans with interactions:
https://cran.r-project.org/web/packages/emmeans/vignettes/interactions.html

```{r}
# CEWL
time_diffs_CEWL <- lm(data = dat_repeats, CEWL_g_m2h ~ month*sex_M_F)
emmeans_CEWL <- data.frame(emmeans(time_diffs_CEWL, 
                                   pairwise ~ month | sex_M_F)$emmean) %>%
  mutate(measurement = "CEWL (g/m2h)")
# osmolality
time_diffs_osml <- lm(data = dat_repeats, osmolality_mmol_kg_mean ~ month*sex_M_F)
emmeans_osml <- data.frame(emmeans(time_diffs_osml, 
                                   pairwise ~ month | sex_M_F)$emmean) %>%
  mutate(measurement = "Plasma Osmolality (mmol/kg)")
# CEWL
time_diffs_mass <- lm(data = dat_repeats, mass_g ~ month*sex_M_F)
emmeans_mass <- data.frame(emmeans(time_diffs_mass, 
                                   pairwise ~ month | sex_M_F)$emmean) %>%
  mutate(measurement = "Mass (g)")

emmeans_all <- emmeans_CEWL %>%
  rbind(emmeans_osml) %>%
  rbind(emmeans_mass)
```


## Plot

```{r}
# CEWL
ggplot() +
  geom_jitter(data = dat_repeats,
             aes(x = month,
                 y = CEWL_g_m2h,
                 color = sex_M_F,
                 shape = tmt),
             alpha = 0.5,
              position = position_jitter(height = 0, width = 0.2)) +
  #geom_line(data = dat,
   #          aes(x = month,
    ##             y = CEWL_g_m2h,
      #           color = tmt,
       #          group = individual_ID),
        #     alpha = 0.7) +
  geom_point(data = emmeans_CEWL,
             aes(x = month,
                 y = emmean,
                 color = sex_M_F)) +
  geom_errorbar(data = emmeans_CEWL,
                aes(x = month,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                 color = sex_M_F),
                width = .3) +
  theme_bw() +
  guides(guide_legend(nrow = 3)) + # why is this not working?! UGHHHHH
  facet_wrap(~sex_M_F) +
  theme(legend.position = "bottom")  -> CEWL_emmean_plot
CEWL_emmean_plot
# osml
ggplot() +
  geom_jitter(data = dat_repeats,
             aes(x = month,
                 y = osmolality_mmol_kg_mean,
                 color = sex_M_F,
                 shape = tmt),
             alpha = 0.5,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_point(data = emmeans_osml,
             aes(x = month,
                 y = emmean,
                 color = sex_M_F)) +
  geom_errorbar(data = emmeans_osml,
                aes(x = month,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                 color = sex_M_F),
                width = .3) +
  guides(guide_legend(nrow = 3)) +
  theme(legend.position = "bottom") +
  facet_wrap(~sex_M_F) +
  theme_bw() -> osml_emmean_plot
osml_emmean_plot
# mass
ggplot() +
  geom_jitter(data = dat_repeats,
             aes(x = month,
                 y = mass_g,
                 color = sex_M_F,
                 shape = tmt),
             alpha = 0.5,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_point(data = emmeans_mass,
             aes(x = month,
                 y = emmean,
                 color = sex_M_F)) +
  geom_errorbar(data = emmeans_mass,
                aes(x = month,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                 color = sex_M_F),
                width = .3) +
  guides(guide_legend(nrow = 3)) +
  theme(legend.position = "bottom") +
  facet_wrap(~sex_M_F) +
  theme_bw() -> mass_emmean_plot
mass_emmean_plot
```


This is **only** for lizards that were recaptured and measured more than once, so I think these changes may reflect true seasonality in their water balance.

Put in one plot together:

```{r}
ggarrange(CEWL_emmean_plot, 
          osml_emmean_plot, 
          mass_emmean_plot,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> szn_change_multi_fig
#szn_change_multi_fig

ggsave(filename = "szn_change_multi_fig.pdf",
       plot = szn_change_multi_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 210)
```







# Look for Potential Correlations

first, load function to format correlation stats:

```{r func to format}
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```

```{r corr}
num_only <- lizards_all_SMI %>%
  dplyr::select(SVL_mm, mass_g, SMI,
                hematocrit_percent, osmolality_mmol_kg_mean, 
                CEWL_g_m2h, cloacal_temp_C, msmt_temp_C, msmt_RH_percent,
                capture_to_msmt)
corr <- rcorr(as.matrix(num_only))
flattenCorrMatrix(corr$r, corr$P)
```

significant correlations to look into:
- CEWL / hct
- osml / hct
- SMI / osml
- SMI / hct
- cloacal temp /msmt temp/ msmt RH/ capture to msmst time
- CEWL / osml

somewhat meaningful:
- SMI / CEWL

surprising/sig NON correlations:
- CEWL / cloacal temp
- CEWL / msmt RH
- CEWL / msmt temp






# Time Stats

```{r change over time only}
# only do for individuals measured at time points 1 and 2
indiv_over_time <- lizards_all_SMI %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  dplyr::filter(n > 1)
lizards_over_time <- lizards_all_SMI %>%
  dplyr::filter(individual_ID %in% indiv_over_time$individual_ID)

# now the following stats will be "for lizards measured at >1 time pt..."

# osmolality
osml_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       osmolality_mmol_kg_mean ~ time_pt + (1|individual_ID)))
summary(osml_time_mod)

# hematocrit
hct_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       hematocrit_percent ~ time_pt + (1|individual_ID)))
summary(hct_time_mod)

# mass
mass_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       mass_g ~ time_pt + (1|individual_ID)))
summary(mass_time_mod)

#SMI
SMI_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       SMI ~ time_pt + (1|individual_ID)))
summary(SMI_time_mod)

# CEWL
CEWL_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       CEWL_g_m2h ~ time_pt + (1|individual_ID)))
summary(CEWL_time_mod)
```


# Time + Sex Stats

```{r diffs by sex + time}
# osmolality
osml_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       osmolality_mmol_kg_mean ~ time_pt + sex_M_F + (1|individual_ID)))
summary(osml_sex_mod)

# hematocrit
hct_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       hematocrit_percent ~ time_pt + sex_M_F + (1|individual_ID)))
summary(hct_sex_mod)

# mass
mass_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       mass_g ~ time_pt + sex_M_F + (1|individual_ID)))
summary(mass_sex_mod)

#SMI
SMI_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       SMI ~ time_pt + sex_M_F + (1|individual_ID)))
summary(SMI_sex_mod)

# CEWL
CEWL_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       CEWL_g_m2h ~ time_pt + sex_M_F + (1|individual_ID)))
summary(CEWL_sex_mod)
```
On average, with individual variation accounted for, osmolality and hematocrit both increased from April to May (but not for July). CEWL decreased from April to May, with no change for July. Mass increased from April to May, then decreased in July. 
...... AND, there are differences between the sexes! :O

Export those stats:

```{r export time stats}
osml_stats <- broom.mixed::tidy(osml_time_mod) %>%
  mutate(response = "Plasma Osmolality (mmol/kg)")
hct_stats <- broom.mixed::tidy(hct_time_mod) %>%
  mutate(response = "Hematocrit (%)")
SMI_stats <- broom.mixed::tidy(SMI_time_mod) %>%
  mutate(response = "Body Condition (g)")
CEWL_stats <- broom.mixed::tidy(CEWL_time_mod) %>%
  mutate(response = "CEWL (g/m2h)")

# aggregate and export
time_mod_stats <- osml_stats %>%
  rbind(hct_stats) %>%
  rbind(SMI_stats) %>%
  rbind(CEWL_stats)
write.csv(time_mod_stats, "./results_statistics/phys_change_over_time.csv")
```

```{r export time*sex stats}
osml_stats_ts <- broom.mixed::tidy(osml_sex_mod) %>%
  mutate(response = "Plasma Osmolality (mmol/kg)")
hct_stats_ts <- broom.mixed::tidy(hct_sex_mod) %>%
  mutate(response = "Hematocrit (%)")
SMI_stats_ts <- broom.mixed::tidy(SMI_sex_mod) %>%
  mutate(response = "Body Condition (g)")
CEWL_stats_ts <- broom.mixed::tidy(CEWL_sex_mod) %>%
  mutate(response = "CEWL (g/m2h)")

# aggregate and export
time_sex_mod_stats <- osml_stats_ts %>%
  rbind(hct_stats_ts) %>%
  rbind(SMI_stats_ts) %>%
  rbind(CEWL_stats_ts)
write.csv(time_sex_mod_stats,
          "./results_statistics/phys_change_over_time_by_sex.csv")
```




# Figures: Raw Values ~ Time

## Osmolality

```{r osml ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = osmolality_mmol_kg_mean, 
                group = individual_ID,
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = osmolality_mmol_kg_mean, 
                group = individual_ID,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Osmolality (mmol/kg)") + 
  #xlim(c("April", "May")) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> osml_over_time
osml_over_time

# export figure
#ggsave(filename = "osml_over_time.jpeg",
 #      plot = osml_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## Hct

```{r hct ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = hematocrit_percent, 
                group = individual_ID,
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = hematocrit_percent, 
                group = individual_ID,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Hematocrit (%)") + 
  #xlim(c("April", "May")) +
  ylim(20, 45) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> hct_over_time
hct_over_time

# export figure
#ggsave(filename = "hct_over_time.jpeg",
 #      plot = hct_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


Right now, I have the y-scale limited to exclude a few outliers.












## Scaled Mass

```{r mass ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = SMI, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = SMI, 
                group = individual_ID,
                color = individual_ID),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Body Condition (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> SMI_over_time
SMI_over_time

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL

```{r CEWL ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("CEWL (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_over_time
CEWL_over_time

# export figure
#ggsave(filename = "CEWL_over_time.jpeg",
 #      plot = CEWL_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```




















# Figures: Mean Values ~ Time

First, I need to calculate the mean values.

```{r get means}
means_by_date_sex <- lizards_over_time %>%
  group_by(time_pt, sex_M_F) %>%
  summarise(hct_mean = mean(hematocrit_percent, na.rm = T),
            osml_mean = mean(osmolality_mmol_kg_mean, na.rm = T),
            mass_mean = mean(mass_g, na.rm = T),
            SMI_mean = mean(SMI, na.rm = T),
            CEWL_mean = mean(CEWL_g_m2h, na.rm = T))
means_by_date_sex
```



## Osmolality

```{r osml mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = osml_mean, 
                color = sex_M_F), 
               size = 3,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = osml_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 1,
            size = 1) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Osmolality (mmol/kg)") + 
  ylim(320,400) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2", 
                     labels = c("Female", "Male"),
                     name = "Sex") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "bottom"
) -> osml_mean_over_time
osml_mean_over_time

# export figure
ggsave(filename = "osml_mean_over_time.jpeg",
       plot = osml_mean_over_time,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```


## Hct

```{r hct mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = hct_mean, 
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = hct_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Hematocrit (%)") + 
  #xlim(c("April", "May")) +
  ylim(20, 45) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> hct_mean_over_time
hct_mean_over_time

# export figure
#ggsave(filename = "hct_over_time.jpeg",
 #      plot = hct_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


Right now, I have the y-scale limited to exclude a few outliers.












## Scaled Mass

```{r mass mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = SMI_mean, 
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = SMI_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Body Condition (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "right"
) -> SMI_mean_over_time
SMI_mean_over_time

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL

```{r CEWL mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = CEWL_mean, 
                color = sex_M_F), 
               size = 3,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = CEWL_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 1,
            size = 1) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  ylim(6,14) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2", 
                     labels = c("Female", "Male"),
                     name = "Sex") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "bottom"
) -> CEWL_mean_over_time
CEWL_mean_over_time

# export figure
ggsave(filename = "CEWL_mean_over_time.jpeg",
       plot = CEWL_mean_over_time,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```




















# Correlations

Make a figure and model for each of the following relationships-

## CEWL ~ Body Temp (no relationship?!)

```{r CEWL ~ body temp fig}
ggplot(data = lizards_all_SMI) + 
  geom_point(aes(x = cloacal_temp_C, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  stat_smooth(aes(x = cloacal_temp_C, 
                   y = CEWL_g_m2h), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              #color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  #xlim(27,37) +
  xlab("Body Temperature (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_body_temp
CEWL_body_temp

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


model:

```{r CEWL ~ body temp model}
CEWL_temp_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ cloacal_temp_C + (1|individual_ID))
summary(CEWL_temp_mod)
```




## CEWL ~ Body Condition (nonsig)


```{r CEWL ~ SMI fig}
ggplot(data = lizards_all_SMI) + 
  geom_point(aes(x = SMI, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  stat_smooth(aes(x = SMI, 
                   y = CEWL_g_m2h), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              #color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Body Condition (g)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_SMI
CEWL_SMI

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```



model:

```{r CEWL ~ SMI model}
CEWL_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ SMI + (1|individual_ID))
summary(CEWL_SMI_mod)
```



































model:

```{r CEWL~osml model}
CEWL_osml_mod1 <- lm(data = lizards_all,
                                CEWL_g_m2h ~ osmolality_mmol_kg_mean:time_pt)
CEWL_osml_mod2 <- lm(data = lizards_all,
                                CEWL_g_m2h ~ osmolality_mmol_kg_mean)
anova(CEWL_osml_mod1, CEWL_osml_mod2)

CEWL_osml_mod3 <- lmerTest::lmer(data = lizards_all,
                  CEWL_g_m2h ~ osmolality_mmol_kg_mean + (1|individual_ID))
CEWL_osml_mod4 <- lmerTest::lmer(data = lizards_all,
          CEWL_g_m2h ~ osmolality_mmol_kg_mean:time_pt + (1|individual_ID))

summary(CEWL_osml_mod3)
summary(CEWL_osml_mod4)


# export
#CEWL_osml_mod_stats <- broom.mixed::tidy(CEWL_osml_mod2) %>%
 # mutate(response = "CEWL (g/m2h)")
#write.csv(CEWL_osml_mod_stats,
 #         "./results_statistics/CEWL_osml_mod_stats.csv")
```





## CEWL ~ Hematocrit

model:

```{r CEWL ~ hct model}
CEWL_hct_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ hematocrit_percent + (1|individual_ID))
summary(CEWL_hct_mod)
```



## Osmolality ~ Hematocrit


model:

```{r osml ~ hct model}
osml_hct_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                osmolality_mmol_kg_mean ~ hematocrit_percent + (1|individual_ID))
summary(osml_hct_mod)
```



## Osmolality ~ SMI


model:

```{r osml ~ SMI model}
osml_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                osmolality_mmol_kg_mean ~ SMI + (1|individual_ID))
summary(osml_SMI_mod)
```



## Hematocrit ~ SMI


model:

```{r osml ~ SMI model}
hct_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                hematocrit_percent ~ SMI + (1|individual_ID))
summary(hct_SMI_mod)
```



## Body Temp ~ Capture to Msmt Time ~ Msmt Temp ~ Msmt RH


Do I need to model this? It makes sense that they're all collinear. 



# Compare to Sceloporus


## Get S.o. Data

```{r load Sceloporus data}
Sceloporus1 <- read.csv("./data/Sceloporus_CEWL_1.csv") %>%
  dplyr::filter(region == "dors") %>%
  dplyr::select(date, individual_ID, CEWL_g_m2h = TEWL_g_m2h)
Sceloporus2 <- read.csv("./data/Sceloporus_CEWL_2.csv") %>%
  dplyr::filter(day == "capture") %>%
  dplyr::select(date, individual_ID, CEWL_g_m2h)
Sceloporus <- rbind(Sceloporus1, Sceloporus2) %>%
  mutate(species = "S. occidentalis",
         individual_ID = as.character(individual_ID))
```


## Merge S.o. and G.s.

```{r merge}
sp_compare <- lizards_all %>%
  dplyr::select(date, individual_ID, CEWL_g_m2h) %>%
  mutate(species = "G. sila",
         individual_ID = as.character(individual_ID)) %>%
  rbind(Sceloporus) 

sp_compare$species <- factor(sp_compare$species,
                             levels = c("S. occidentalis", "G. sila"))

sp_compare_means <- sp_compare %>%
  group_by(species) %>%
  summarise(mean_CEWL = mean(CEWL_g_m2h, na.rm = TRUE),
            sd_CEWL = sd(CEWL_g_m2h, na.rm = TRUE),
            min_CEWL = min(CEWL_g_m2h, na.rm = TRUE),
            max_CEWL = max(CEWL_g_m2h, na.rm = TRUE),
            range_CEWL = max_CEWL - min_CEWL)
sp_compare_means
```

I think I should present in the figure caption as mean ± SD (range).

So, "Mean ± SD (range) are as follows: S. occidentalis: 21.4 ± 6.6 (4.0 - 49.0); G. sila: 10.2 ± 4.0 (0.6 - 21.0)."


## Model Compare Avg CEWL

```{r model sp compare CEWL}
sp_compare_mod <- lm(data = sp_compare, CEWL_g_m2h ~ species)
summary(sp_compare_mod)
```


## Plot Compare Avg CEWL

this is the grand mean across dates and sexes

```{r compare sp CEWL}
ggplot() + 
  geom_boxplot(data = sp_compare,
               aes(x = species, 
                   y = CEWL_g_m2h, 
                color = species), 
               alpha = 1) +
  geom_point(data = sp_compare_means,
               aes(x = species, 
                   y = mean_CEWL, 
                color = species), 
               size = 6,
               alpha = 1) +
  theme_classic() + 
  xlab("") + 
  ylim(0, 55) +
  scale_y_continuous(breaks = c(0, 10, 20, 30, 40 , 50)) +
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  annotate("text", x = 1.5, y = 50, label = "p < 0.0001", size = 6) +
  scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_compare_sp
CEWL_compare_sp

# export figure
ggsave(filename = "CEWL_BNLL_vs_WFL.jpeg",
       plot = CEWL_compare_sp,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```














