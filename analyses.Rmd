---
title: "BNLL hydrophysiology analyses"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
```

make a common figure theme:

```{r}
savs_ggplot_theme <- theme_bw() + 
                     theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom",
                           #plot.margin = margin(t = 6, r = 6, b = 0, l = 1, unit = "pt")
                           ) #+
  
  #theme_classic() + 
  #guides(shape = guide_legend(nrow = 2, byrow = TRUE))
  
  
  
# custom colors
Male <- brewer.pal(11, "RdYlBu")[c(11)]
Fem <- brewer.pal(11, "RdYlBu")[c(2)]
my_colors <- c(Fem, Male)
my_shapes <- c(19,15)
my_shapes_open <- c(21,22)
```






# Background 



# Load in Data

This data was collected during fieldwork with Blunt-nosed Leopard Lizards (*Gambelia sila*) in the Elkhorn Plain of the Carrizo Plain National Monument in California, USA during the 2021 active season (April-August). See published paper (doi) for complete methods and discussion of these analyses. 


```{r}
dat <- read_rds("./data/G_sila_clean_full_dat.RDS") %>%
  mutate(month_sex = factor(paste(month, sex_M_F),
                            levels = c("April Female", "April Male",
                                       "May Female", "May Male",
                                       "July Female", "July Male")))
summary(dat)
```




## Variable Explanation






## Repeat Subset

I want to make some sub-dataframes for when I want to do stats for only a subset of individuals.

First, get a dataframe of only individuals that had more than one measurement taken, and note how many individuals had x measurements:

```{r}
# how many lizards were measured 1, 2, or 3 times?
note_repeats <- dat %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  group_by(n) %>%
  summarise(n_lizards = n())
note_repeats 

# this is how many individual lizards we measured :)
sum(note_repeats$n_lizards) 

# get subsetted data
dat_repeats <- dat %>%
  group_by(individual_ID) %>%
  mutate(n = n()) %>%
  dplyr::filter(n>1)

# check these match 'note_repeats'
dat_repeats %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  group_by(n) %>%
  summarise(n_lizards = n())
```



## Female Subset

To look at reproductive effort ~ water balance, I will make another subset for only the females we collected gravidity/egg data on:

```{r}
dat_repro_females <- dat %>%
  dplyr::filter(complete.cases(gravid_Y_N)) %>%
  group_by(individual_ID) %>%
  mutate(n = n(),
         n = factor(n)) 
summary(dat_repro_females)
```


It's good to note that I measured reproductive effort at **two time points** for 9 females, and only at one time point for 10 females.

Check whether the single-measurement females are all from the first weekend or not:

```{r}
table(dat_repro_females$week, dat_repro_females$n)
```


For the females who were only measured once, 8 of them are from the first weekend and 2 of them are from the third weekend.

Also save a subset of the females that were measured twice:


```{r}
dat_repeat_females <- dat_repro_females %>%
  dplyr::filter(n == 2)
```




# Does SVL change over time?

I want to know whether SVL changed over time for the individuals who had more than one measurement taken. If it does, then body condition is certainly more informative than mass.

```{r}
# model
summary(lme4::lmer(data = dat_repeats, 
                   SVL_mm ~ week_num + (1|individual_ID)))
```


There is no meaningful change in SVL for the individuals we were able to measure, so I could use either mass or body condition to estimate body size.



# Check CEWL Covariates

How much is CEWL impacted by the body temperature, ambient temperature, and ambient VPD at the time of CEWL measurement? I will investigate this using *all* measurements.

It's possible that I may find a relationship between ambient temp and CEWL but not body temp and CEWL because the body temp measurements we took were unfortunately only to the nearest degree...


## Plot

First, make a simple plot of each to look for relationships visually.

```{r}
ggplot(dat) +
  aes(x = cloacal_temp_C,
      y = CEWL_g_m2h,
      color = week
      #color = sex_M_F
        ) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
ggplot(dat) +
  aes(x = msmt_temp_C,
      y = CEWL_g_m2h,
      color = week
      #color = sex_M_F
        ) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
ggplot(dat) +
  aes(x = msmt_VPD_kPa,
      y = CEWL_g_m2h,
      color = week
      #color = sex_M_F
        ) +
  geom_point() +
  geom_smooth(method = "lm") +
  theme_bw()
```


Across dates, CEWL had no relationship with body temp, ambient temp, or ambient VPD at the time of capture. However, when separated by date, there were relationships. CEWL had a positive relationship with body temp, ambient temp, and ambient VPD, but only for week 3 measurements. There were no relationships when separated by treatment group. 


## Models

Now, check linear models of the effect of each of body temp, ambient temp, and ambient VPD with the interaction of date on CEWL.

```{r}
summary(lm(data = dat,
           CEWL_g_m2h ~ cloacal_temp_C*week))
summary(lm(data = dat,
           CEWL_g_m2h ~ msmt_temp_C*week))
summary(lm(data = dat,
           CEWL_g_m2h ~ msmt_VPD_kPa*week))
```

CEWL had a positive relationship with each of body temp, ambient temp, and ambient VPD, *but only for the measurements taken in May* (week 3).


## Variance

Let's also check the distribution/range of these covariates, because based on the figures, week 3 had a pretty small range of temperatures and VPDs.

```{r}
dat %>%
  group_by(week) %>%
  summarise(ctemp_range = max(cloacal_temp_C, na.rm = T) - 
              min(cloacal_temp_C, na.rm = T),
            mtemp_range = max(msmt_temp_C, na.rm = T) - 
              min(msmt_temp_C, na.rm = T),
            mVPD_range = max(msmt_VPD_kPa, na.rm = T) - 
              min(msmt_VPD_kPa, na.rm = T))
```

Well... the ranges for week 3 are not small enough to be meaningless. So, we will have to keep in mind that temperature and VPD should be retained in CEWL models as a covariate.




# Water Balance Metrics

What is the interrelation among water balance metrics CEWL, osmolality, hematocrit, and mass/SMI. I'll use all measurements for this. *I'm not sure if we will include hematocrit in the final results, though.*

## Models

Check a simple linear model between each set of paired measurements:

```{r}
# CEWL ~
summary(lm(data = dat,
           CEWL_g_m2h ~ osmolality_mmol_kg_mean))
summary(lm(data = dat,
           CEWL_g_m2h ~ hematocrit_percent))
summary(lm(data = dat,
           CEWL_g_m2h ~ mass_g))
summary(lm(data = dat,
           CEWL_g_m2h ~ SMI))

# osmolality ~
summary(lm(data = dat,
           osmolality_mmol_kg_mean ~ hematocrit_percent))
summary(lm(data = dat,
           osmolality_mmol_kg_mean ~ mass_g))
summary(lm(data = dat,
           osmolality_mmol_kg_mean ~ SMI))
```

There is a small negative correlation between CEWL and osmolality. Neither CEWL or osmolality have a relationship with body mass, but they do with SMI. Both CEWL and osmolality correlate with hematocrit.


## Plot CEWL ~ Osmolality


```{r CEWL osml fig}
ggplot(dat) + 
  aes(x = osmolality_mmol_kg_mean,
      y = CEWL_g_m2h,
      #color = tmt
      color = sex_M_F
      ) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Plasma Osmolality (mmol/kg)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim(300, 450) +
  #annotate(geom = "text", x = 430, y = 24, label = bquote(''*R^2*'=0.033'), 
   #        size = 7) +
  #ylim(0, 25) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "right"
        ) -> CEWL_osml_fig
CEWL_osml_fig

# export figure
#ggsave(filename = "CEWL_osml_fig.jpeg",
 #      plot = CEWL_osml_fig,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## Plot CEWL ~ Hematocrit


```{r CEWL hct fig}
ggplot(dat) + 
  aes(x = hematocrit_percent,
      y = CEWL_g_m2h,
      #color = tmt
      color = sex_M_F
      ) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Hematocrit (%)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  #xlim(300, 450) +
  #annotate(geom = "text", x = 430, y = 24, label = bquote(''*R^2*'=0.033'), 
   #        size = 7) +
  #ylim(0, 25) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "right"
        ) -> CEWL_hct_fig
CEWL_hct_fig
```


## Plot Osmol ~ Hematocrit


```{r CEWL hct fig}
ggplot(dat) + 
  aes(x = hematocrit_percent,
      y = osmolality_mmol_kg_mean,
      #color = tmt
      color = sex_M_F
      ) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Hematocrit (%)") + 
  ylab("Plasma Osmolality") + 
  #ylab("") +
  #xlim(300, 450) +
  #annotate(geom = "text", x = 430, y = 24, label = bquote(''*R^2*'=0.033'), 
   #        size = 7) +
  #ylim(0, 25) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "right"
        ) -> osml_hct_fig
osml_hct_fig
```


## Week Interaction

Redo CEWL ~ osmolality model with an interaction of date:

```{r}
summary(lm(data = dat, CEWL_g_m2h ~ osmolality_mmol_kg_mean*week))
```


Once again, the relationship is only significant for week 3...\



Also look at for hematocrit:

```{r}
summary(lm(data = dat,
           CEWL_g_m2h ~ hematocrit_percent*week))
summary(lm(data = dat,
           osmolality_mmol_kg_mean ~ hematocrit_percent*week))
```

The relationships between CEWL and osmolality with hematocrit are not different across weeks.



## Lag Effect?

What if I tested week 3 CEWL ~ week 1 osml, or visa versa? This is to look for a lag effect on their relationship, although the time period is likely too long.

First, organize the data:

```{r}
w3_CEWL <- dat %>%
  dplyr::filter(week == 3) %>%
  dplyr::select(individual_ID, CEWL_g_m2h)
w1_osml <- dat %>%
  dplyr::filter(week == 1) %>%
  dplyr::select(individual_ID, osmolality_mmol_kg_mean)
w3_vs_w1 <- w1_osml %>%
  left_join(w3_CEWL, by = 'individual_ID') %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean, CEWL_g_m2h))
w1_CEWL <- dat %>%
  dplyr::filter(week == 1) %>%
  dplyr::select(individual_ID, CEWL_g_m2h)
w3_osml <- dat %>%
  dplyr::filter(week == 3) %>%
  dplyr::select(individual_ID, osmolality_mmol_kg_mean) 
w1_vs_w3 <- w3_osml %>%
  left_join(w1_CEWL, by = 'individual_ID') %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean, CEWL_g_m2h))
```


Run models:

```{r}
summary(lm(data = w3_vs_w1, CEWL_g_m2h ~ osmolality_mmol_kg_mean))
summary(lm(data = w1_vs_w3, CEWL_g_m2h ~ osmolality_mmol_kg_mean))
```

It seems very unlikely there is a lag effect, at least at this time scale. t and F stats were both nonsig for each comparisons.



# Supplemental Hydration Treatment Effects


## Calculate Deltas

First, calculate the change in CEWL, osmolality, and mass for each treatment individual that was recaptured between April and May.

```{r}
starting_values <- dat_repeats %>%
  # look only at lizards in hydration or sham tmt
  dplyr::filter(tmt != "No Tmt") %>%
  # get the values for April measurements only 
  dplyr::filter(month == "April") %>%
  dplyr::select(individual_ID,
                CEWL_April = CEWL_g_m2h,
                osml_April = osmolality_mmol_kg_mean,
                mass_April = mass_g)
dat_tmt_change <- dat_repeats %>%
  # look only at lizards in hydration or sham tmt
  dplyr::filter(tmt != "No Tmt") %>%
  # add starting values
  left_join(starting_values, by = 'individual_ID') %>%
  # make sure we have complete data
  dplyr::filter(complete.cases(mass_April, CEWL_April)) %>%
  # calculate difference for each msmt versus in April
  mutate(mass_change_from_April = mass_g - mass_April,
         CEWL_change_from_April = CEWL_g_m2h - CEWL_April,
         osml_change_from_April = osmolality_mmol_kg_mean - osml_April)
dat_tmt_change_May_only <- dat_tmt_change %>%
  dplyr::filter(month == "May")
```



## Plot Change by Tmt

### Mass

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = mass_change_from_April,
      group = individual_ID,
      color = tmt
      ) +
  xlab("Measurement Month") + 
  ylab(expression(Delta ~ 'Lizard Mass (g)')) +
  geom_line(alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_color_manual(values = my_colors, name = "Sex") +
  savs_ggplot_theme -> tmt_delta_mass
tmt_delta_mass
```


### Osmolality

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = osml_change_from_April,
      group = individual_ID,
      color = tmt
      ) +
  xlab("Measurement Month") + 
  ylab(expression(Delta ~ 'Osmolality (mmol '*kg^-1*')')) +
  geom_line(alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_color_manual(values = my_colors, name = "Sex") +
  savs_ggplot_theme -> tmt_delta_osml
tmt_delta_osml
```




### CEWL

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = CEWL_change_from_April,
      group = individual_ID,
      color = tmt
      ) +
  xlab("Measurement Month") + 
  ylab(expression(Delta ~ 'CEWL (g '*m^-2*' '*h^-1*')')) +
  geom_line(alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_color_manual(values = my_colors, name = "Sex") +
  savs_ggplot_theme -> tmt_delta_CEWL
tmt_delta_CEWL
```


It does *not* look like treatment led to any differences in the amount or direction of change in lizard mass, CEWL, or osmolality. Changes were also not consistent by sex.

### Export Multi-Panel Fig

Save plots:

```{r}
ggarrange(tmt_delta_CEWL,
          tmt_delta_osml, 
          tmt_delta_mass,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> tmt_delta_multi_fig

ggsave(filename = "tmt_delta_multi_fig.pdf",
       plot = tmt_delta_multi_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 210)
```



## Stat Tests of Change

These lm's are doing the same thing as a two-sample t-test, checking whether the means are statistically different. 

```{r}
summary(lm(data = dat_tmt_change_May_only, mass_change_from_April ~ tmt))
summary(lm(data = dat_tmt_change_May_only, CEWL_change_from_April ~ tmt))
summary(lm(data = dat_tmt_change_May_only, osml_change_from_April ~ tmt))
```

Change was not significantly different between treatments for any of the variables. 


Was change overall (across tmts) different from zero?

```{r}
t.test(dat_tmt_change_May_only$mass_change_from_April)
t.test(dat_tmt_change_May_only$CEWL_change_from_April)
t.test(dat_tmt_change_May_only$osml_change_from_April)
```

On average, lizards who were measured in both April and May increased mass, but did not experience a change in osmolality or CEWL. 

What about mass change *during* treatment, when we either gave lizards water to drink or a sham treatment. 

```{r tmt mass change stats}
summary(lm(data = dat, tmt_mass_change_g ~ tmt))
```

So, it did result in a significant change in mass within the same-day water supplementation tmt (vs sham), but only ~1.4g difference, on average.




# Change Over Time


## Plot Delta ~ Time*Sex

### Mass

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = mass_change_from_April,
      group = individual_ID,
      color = sex_M_F,
      shape = sex_M_F
      ) +
  xlab("Measurement Month") + 
  ylab(expression(Delta ~ 'Lizard Mass (g)')) +
  geom_line(alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_color_manual(values = my_colors, name = "Sex") +
  scale_shape_manual(values = my_shapes, name = "Sex") +
  savs_ggplot_theme -> delta_mass_sex
delta_mass_sex
```


### Osmolality

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = osml_change_from_April,
      group = individual_ID,
      color = sex_M_F,
      shape = sex_M_F
      ) +
  xlab("Measurement Month") + 
  ylab(expression(Delta ~ 'Osmolality (mmol '*kg^-1*')')) +
  geom_line(alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_color_manual(values = my_colors, name = "Sex") +
  scale_shape_manual(values = my_shapes, name = "Sex") +
  savs_ggplot_theme -> delta_osml_sex
delta_osml_sex
```




### CEWL

```{r}
ggplot(dat_tmt_change) +
  aes(x = month,
      y = CEWL_change_from_April,
      group = individual_ID,
      color = sex_M_F,
      shape = sex_M_F
      ) +
  xlab("Measurement Month") + 
  ylab(expression(Delta ~ 'CEWL (g '*m^-2*' '*h^-1*')')) +
  geom_line(alpha = 0.5) +
  geom_point(size = 1.5) +
  scale_color_manual(values = my_colors, name = "Sex") +
  scale_shape_manual(values = my_shapes, name = "Sex") +
  savs_ggplot_theme -> delta_CEWL_sex
delta_CEWL_sex
```



### Export Multi-Panel Fig

Save plots:

```{r}
ggarrange(delta_CEWL_sex,
          delta_osml_sex, 
          delta_mass_sex,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> delta_multi_fig_sex

ggsave(filename = "delta_multi_fig_sex.pdf",
       plot = delta_multi_fig_sex,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 210)
```



## Time*Sex Marginal Means

I want to know whether the average values for all the lizards we measured changes over time. To test this, I can run a linear model, then use emmeans to get the marginal means and confidence intervals for each time point. 

Do this only for lizards with repeat measurements.

info for using emmeans with interactions:
https://cran.r-project.org/web/packages/emmeans/vignettes/interactions.html




### Mass

```{r}
time_sex_diffs_mass <- lm(data = dat_repeats, mass_g ~ month*sex_M_F)

# mean values
emmeans_mass <- data.frame(emmeans(time_diffs_mass, 
                                   pairwise ~ month | sex_M_F)$emmean) %>%
  mutate(measurement = "Mass")

# stat diffs by month
time_emmeans_mass <- data.frame(emmeans(time_diffs_mass, 
                                   pairwise ~ month | sex_M_F)$contrasts) %>%
  mutate(measurement = "Mass")

# stat diffs by sex
sex_emmeans_mass <- data.frame(emmeans(time_diffs_mass, 
                                   pairwise ~ sex_M_F | month)$contrasts) %>%
  mutate(measurement = "Mass")
```




### Osmolality

```{r}
time_sex_diffs_osml <- lm(data = dat_repeats, osmolality_mmol_kg_mean ~ month*sex_M_F)

# mean values
emmeans_osml <- data.frame(emmeans(time_diffs_osml, 
                                   pairwise ~ month | sex_M_F)$emmean) %>%
  mutate(measurement = "Osmolality")

# stat diffs by month
time_emmeans_osml <- data.frame(emmeans(time_diffs_osml, 
                                   pairwise ~ month | sex_M_F)$contrasts) %>%
  mutate(measurement = "Osmolality")

# stat diffs by sex
sex_emmeans_osml <- data.frame(emmeans(time_diffs_osml, 
                                   pairwise ~ sex_M_F | month)$contrasts) %>%
  mutate(measurement = "Osmolality")
```




### CEWL

```{r}
time_sex_diffs_CEWL <- lm(data = dat_repeats, CEWL_g_m2h ~ month*sex_M_F)
emmeans_CEWL <- data.frame(emmeans(time_diffs_CEWL, 
                                   pairwise ~ month | sex_M_F)$emmean) %>%
  mutate(measurement = "CEWL")
time_emmeans_CEWL <- data.frame(emmeans(time_diffs_CEWL, 
                                   pairwise ~ month | sex_M_F)$contrasts) %>%
  mutate(measurement = "CEWL")
sex_emmeans_CEWL <- data.frame(emmeans(time_diffs_CEWL, 
                                   pairwise ~ sex_M_F | month)$contrasts) %>%
  mutate(measurement = "CEWL")
```



### Merge dfs

```{r}
emmeans_all <- emmeans_CEWL %>%
  rbind(emmeans_osml) %>%
  rbind(emmeans_mass) %>%
  mutate(month_sex = factor(paste(month, sex_M_F),
                            levels = c("April Female", "April Male",
                                       "May Female", "May Male",
                                       "July Female", "July Male")))

# all pairwise stats together
emmean_time_stats <- time_emmeans_CEWL %>%
  rbind(time_emmeans_osml) %>%
  rbind(time_emmeans_mass)
emmean_sex_stats <- sex_emmeans_CEWL %>%
  rbind(sex_emmeans_osml) %>%
  rbind(sex_emmeans_mass)
```

















## Plot MMeans Time*Sex

### Mass

```{r}
ggplot() +
  geom_jitter(data = dat_repeats,
             aes(x = month,
                 y = mass_g,
                 color = sex_M_F,
                 shape = tmt),
             alpha = 0.3,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_point(data = emmeans_mass,
             aes(x = month,
                 y = emmean,
                 color = sex_M_F)) +
  geom_errorbar(data = emmeans_mass,
                aes(x = month,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                 color = sex_M_F),
                width = .4) +
  xlab("Measurement Month") + 
  ylab("Lizard Mass (g)") +
  savs_ggplot_theme +
  facet_wrap(~sex_M_F) -> mass_emmean_plot
mass_emmean_plot
```



### Osmolality

```{r}
ggplot() +
  geom_jitter(data = dat_repeats,
             aes(x = month,
                 y = osmolality_mmol_kg_mean,
                 color = sex_M_F,
                 shape = tmt),
             alpha = 0.3,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_point(data = emmeans_osml,
             aes(x = month,
                 y = emmean,
                 color = sex_M_F)) +
  geom_errorbar(data = emmeans_osml,
                aes(x = month,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                 color = sex_M_F),
                width = .4) +
  xlab("Measurement Month") + 
  ylab(bquote('Osmolality (mmol '*kg^-1*')')) +
  savs_ggplot_theme +
  facet_wrap(~sex_M_F) -> osml_emmean_plot
osml_emmean_plot
```




### CEWL

```{r}
ggplot() +
  geom_jitter(data = dat_repeats,
             aes(x = month_sex,
                 y = CEWL_g_m2h,
                 shape = sex_M_F,
                 color = sex_M_F,
                 fill = sex_M_F),
             alpha = 0.3,
             position = position_jitter(height = 0, width = 0.2)) +
  geom_point(data = emmeans_all[emmeans_all$measurement == "CEWL",],
             aes(x = month_sex,
                 y = emmean,
                 shape = sex_M_F,
                 color = sex_M_F,
                 fill = sex_M_F),
             alpha = 1,
             size = 3) +
  geom_errorbar(data = emmeans_all[emmeans_all$measurement == "CEWL",],
                aes(x = month_sex,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL,
                    color = sex_M_F),
                width = .4) +
  #annotate(geom = "text", x = 1, y = 20, label = "A", size = 3) +
  #annotate(geom = "text", x = 2, y = 20, label = "A", size = 3) +
  xlab("Measurement Month") + 
  ylab(bquote('CEWL (g '*m^-2*' '*h^-1*')')) +
  scale_color_manual(values = my_colors, name = "Sex") +
  scale_fill_manual(values = my_colors, name = "Sex") +
  scale_shape_manual(values = my_shapes_open, name = "Sex") +
  savs_ggplot_theme -> CEWL_emmean_plot
CEWL_emmean_plot
```


This is **only** for lizards that were recaptured and measured more than once, so I think these changes may reflect true seasonality in their water balance.



### Export Multi-Panel Fig

Put in one plot together:

```{r}
ggarrange(CEWL_emmean_plot, 
          osml_emmean_plot, 
          mass_emmean_plot,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> szn_change_multi_fig
#szn_change_multi_fig

ggsave(filename = "szn_change_multi_fig.pdf",
       plot = szn_change_multi_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 210)
```

















# LMER Time + Sex Stats

```{r diffs by sex + time}
# osmolality
osml_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       osmolality_mmol_kg_mean ~ time_pt + sex_M_F + (1|individual_ID)))
summary(osml_sex_mod)

# hematocrit
hct_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       hematocrit_percent ~ time_pt + sex_M_F + (1|individual_ID)))
summary(hct_sex_mod)

# mass
mass_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       mass_g ~ time_pt + sex_M_F + (1|individual_ID)))
summary(mass_sex_mod)

#SMI
SMI_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       SMI ~ time_pt + sex_M_F + (1|individual_ID)))
summary(SMI_sex_mod)

# CEWL
CEWL_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       CEWL_g_m2h ~ time_pt + sex_M_F + (1|individual_ID)))
summary(CEWL_sex_mod)
```
On average, with individual variation accounted for, osmolality and hematocrit both increased from April to May (but not for July). CEWL decreased from April to May, with no change for July. Mass increased from April to May, then decreased in July. 
...... AND, there are differences between the sexes! :O

Export those stats:

```{r export time stats}
osml_stats <- broom.mixed::tidy(osml_time_mod) %>%
  mutate(response = "Plasma Osmolality (mmol/kg)")
hct_stats <- broom.mixed::tidy(hct_time_mod) %>%
  mutate(response = "Hematocrit (%)")
SMI_stats <- broom.mixed::tidy(SMI_time_mod) %>%
  mutate(response = "Body Condition (g)")
CEWL_stats <- broom.mixed::tidy(CEWL_time_mod) %>%
  mutate(response = "CEWL (g/m2h)")

# aggregate and export
time_mod_stats <- osml_stats %>%
  rbind(hct_stats) %>%
  rbind(SMI_stats) %>%
  rbind(CEWL_stats)
write.csv(time_mod_stats, "./results_statistics/phys_change_over_time.csv")
```

```{r export time*sex stats}
osml_stats_ts <- broom.mixed::tidy(osml_sex_mod) %>%
  mutate(response = "Plasma Osmolality (mmol/kg)")
hct_stats_ts <- broom.mixed::tidy(hct_sex_mod) %>%
  mutate(response = "Hematocrit (%)")
SMI_stats_ts <- broom.mixed::tidy(SMI_sex_mod) %>%
  mutate(response = "Body Condition (g)")
CEWL_stats_ts <- broom.mixed::tidy(CEWL_sex_mod) %>%
  mutate(response = "CEWL (g/m2h)")

# aggregate and export
time_sex_mod_stats <- osml_stats_ts %>%
  rbind(hct_stats_ts) %>%
  rbind(SMI_stats_ts) %>%
  rbind(CEWL_stats_ts)
write.csv(time_sex_mod_stats,
          "./results_statistics/phys_change_over_time_by_sex.csv")
```




# Other Figures

Make a figure and model for each of the following relationships-

## CEWL ~ Body Temp (no relationship?!)

```{r CEWL ~ body temp fig}
ggplot(data = lizards_all_SMI) + 
  geom_point(aes(x = cloacal_temp_C, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  stat_smooth(aes(x = cloacal_temp_C, 
                   y = CEWL_g_m2h), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              #color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  #xlim(27,37) +
  xlab("Body Temperature (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_body_temp
CEWL_body_temp

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


model:

```{r CEWL ~ body temp model}
CEWL_temp_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ cloacal_temp_C + (1|individual_ID))
summary(CEWL_temp_mod)
```




## CEWL ~ Body Condition (nonsig)


```{r CEWL ~ SMI fig}
ggplot(data = lizards_all_SMI) + 
  geom_point(aes(x = SMI, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  stat_smooth(aes(x = SMI, 
                   y = CEWL_g_m2h), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              #color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Body Condition (g)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_SMI
CEWL_SMI

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```



model:

```{r CEWL ~ SMI model}
CEWL_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ SMI + (1|individual_ID))
summary(CEWL_SMI_mod)
```



































model:

```{r CEWL~osml model}
CEWL_osml_mod1 <- lm(data = lizards_all,
                                CEWL_g_m2h ~ osmolality_mmol_kg_mean:time_pt)
CEWL_osml_mod2 <- lm(data = lizards_all,
                                CEWL_g_m2h ~ osmolality_mmol_kg_mean)
anova(CEWL_osml_mod1, CEWL_osml_mod2)

CEWL_osml_mod3 <- lmerTest::lmer(data = lizards_all,
                  CEWL_g_m2h ~ osmolality_mmol_kg_mean + (1|individual_ID))
CEWL_osml_mod4 <- lmerTest::lmer(data = lizards_all,
          CEWL_g_m2h ~ osmolality_mmol_kg_mean:time_pt + (1|individual_ID))

summary(CEWL_osml_mod3)
summary(CEWL_osml_mod4)


# export
#CEWL_osml_mod_stats <- broom.mixed::tidy(CEWL_osml_mod2) %>%
 # mutate(response = "CEWL (g/m2h)")
#write.csv(CEWL_osml_mod_stats,
 #         "./results_statistics/CEWL_osml_mod_stats.csv")
```





## CEWL ~ Hematocrit

model:

```{r CEWL ~ hct model}
CEWL_hct_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ hematocrit_percent + (1|individual_ID))
summary(CEWL_hct_mod)
```



## Osmolality ~ Hematocrit


model:

```{r osml ~ hct model}
osml_hct_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                osmolality_mmol_kg_mean ~ hematocrit_percent + (1|individual_ID))
summary(osml_hct_mod)
```



## Osmolality ~ SMI


model:

```{r osml ~ SMI model}
osml_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                osmolality_mmol_kg_mean ~ SMI + (1|individual_ID))
summary(osml_SMI_mod)
```



## Hematocrit ~ SMI


model:

```{r osml ~ SMI model}
hct_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                hematocrit_percent ~ SMI + (1|individual_ID))
summary(hct_SMI_mod)
```




















# Reproductive Effort

Is reproductive effort related to water balance?


## Repeat Individuals

I have 9 females measured at both April and May time points. Let's see if their physiology changes consistently based on becoming gravid. 


First, calculate the change in CEWL, osmolality, and mass for each of those females between April to May.

```{r}
fem_starting_values <- dat_repeat_females %>%
  # get the values for April measurements only 
  dplyr::filter(month == "April") %>%
  dplyr::select(individual_ID,
                CEWL_April = CEWL_g_m2h,
                osml_April = osmolality_mmol_kg_mean,
                mass_April = mass_g)
fem_change <- dat_repeat_females %>%
  # add starting values
  left_join(fem_starting_values, by = 'individual_ID') %>%
  # make sure we have complete data
  dplyr::filter(complete.cases(mass_April, CEWL_April)) %>%
  # calculate difference for each msmt versus in April
  mutate(mass_change_from_April = mass_g - mass_April,
         CEWL_change_from_April = CEWL_g_m2h - CEWL_April,
         osml_change_from_April = osmolality_mmol_kg_mean - osml_April)
```



## Plot Indiv Change

```{r}
ggplot(fem_change) +
  aes(x = month,
      y = mass_change_from_April,
      group = individual_ID,
      color = gravid_Y_N
      ) +
  geom_point() +
  geom_line() +
  theme_bw()
ggplot(fem_change) +
  aes(x = month,
      y = CEWL_change_from_April,
      group = individual_ID,
      color = gravid_Y_N
      ) +
  geom_point() +
  geom_line() +
  theme_bw()
ggplot(fem_change) +
  aes(x = month,
      y = osml_change_from_April,
      group = individual_ID,
      color = gravid_Y_N
      ) +
  geom_point() +
  geom_line() +
  theme_bw()
```


On average, mass and osmolality both increase. There's only one lizard who was not gravid at both time points, so we can't compare change based on becoming gravid or not. But, I think it is reasonable to conclude that on average, gravid females gained mass and became less hydrated.


# Stats Indiv Change

Run stats tests on the change rates for only the females who were gravid in May, and use only the actual delta values, in their rows for May data.

```{r}
fem_change_stats <- fem_change %>%
  dplyr::filter(individual_ID != "F-12") %>%
  dplyr::filter(month == "May") #%>%
  #dplyr::filter(osml_change_from_April > -30)
```


ttests:

```{r}
t.test(fem_change_stats$CEWL_change_from_April)
t.test(fem_change_stats$osml_change_from_April)
t.test(fem_change_stats$mass_change_from_April)
```

Only mass change was significantly different from zero... But, if we got rid of the one super low osmolality value, the change in osmolality would also be significant. 



## Likelihood

First, I need to figure out what to do with the individuals measured twice, and whether I need to worry about choosing between the different dates.

```{r}
dat_repro_females %>%
  dplyr::filter(n == 1)
table(dat_repro_females$gravid_Y_N, dat_repro_females$week)
```


It will be interesting in the results section to talk about the following:

- several females that we measured more than once were *not* gravid in week 1, then *were* gravid when we re-measured them in week 3. 
- across recaptured and single-capture females, a higher proportion were gravid in week 3 than in week 1
- the egg development stage varied greatly among individuals, showing variability in timing of breeding, and potentially ability to have several clutches
- eggs were x-y cm in diameter, depending on development stage


Is it reasonable to look at a dataset of the week-3 repeat females + all the 1-msmt females?

Try it.. Basically, I just need to exclude the April measurements for the lizards measured at both dates.

```{r}
logit_stats_df <- dat_repro_females %>%
  dplyr::filter(!(month == "April" & n == 2))
```


Start with a multiple-effect logistic model to predict gravidity:

```{r}
repro_logit1 <- glm(gravid_Y_N ~ 
                     mass_g + SMI + osmolality_mmol_kg_mean + CEWL_g_m2h, 
                   data = logit_stats_df, 
                   family = binomial)
summary(repro_logit1)
drop1(repro_logit1)
```

```{r}
repro_logit2 <- glm(gravid_Y_N ~ 
                     mass_g + SMI + osmolality_mmol_kg_mean, 
                   data = logit_stats_df, 
                   family = binomial)
summary(repro_logit2)
drop1(repro_logit2)
```


```{r}
repro_logit3 <- glm(gravid_Y_N ~ 
                     SMI + osmolality_mmol_kg_mean, 
                   data = logit_stats_df, 
                   family = binomial)
summary(repro_logit3)
drop1(repro_logit3)
```


Even when we get down to just body condition, we do not have any variables that are significant predictors of whether a female is gravid. 





























































