---
title: "BNLL hydrophysiology analyses"
author: "Savannah Weaver"
output: pdf_document
toc: TRUE
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
```


# Load in Data

This data was collected during fieldwork with Blunt-nosed Leopard Lizards (*Gambelia sila*) in the Elkhorn Plain of the Carrizo Plain National Monument in California, USA during the 2021 active season (April-August). See published paper (doi) for complete methods and discussion of these analyses. 



## Variable Explanation





## CEWL

```{r load CEWL data}
CEWL_unformatted <- read.csv("data/CEWL_dat_all_clean.csv")

# fix some upper/lowercase issues
CEWL_unformatted[95, "individual_ID"] <- "F-08a"
CEWL_unformatted[117, "individual_ID"] <- "M-03a"

# M-03a was originally W-029, so we need to reassign the correct ID to CEWL msmts
CEWL_unformatted[77, "individual_ID"] <- "M-03a"

CEWL <- CEWL_unformatted %>%
  dplyr::mutate(date = as.Date(date, format = "%Y-%m-%d"),
                individual_ID = as.factor(individual_ID)) %>%
  dplyr::select(-X)
```


## Osmolality

```{r load osml data}
osmolality <- read.csv("data/osml_means_clean.csv") %>%
  dplyr::mutate(blood_draw_date = as.Date(blood_draw_date, format = "%m/%d/%y"),
                individual_ID = as.factor(individual_ID))
```



## Collared Lizards

The first dataset loaded in is for lizards we radio-collared and tracked throughout the summer.

```{r get data collared lizards}
lizards_collared <- read.csv("data/collared_measurements.csv") %>%
                
                # format data classes
  dplyr::mutate(capture_process_date_time = as.POSIXct(paste(capture_process_date, capture_time, sep = " "), format = "%m/%d/%y %H:%M"),
                capture_process_date = as.Date(capture_process_date, 
                                                  format = "%m/%d/%y"),
                SVL_mm = as.numeric(SVL_mm),
                pre_tmt_mass_g = as.numeric(pre_tmt_mass_g),
                pre_mass_w_collar_Y_N = as.factor(pre_mass_w_collar_Y_N),
                post_tmt_mass_g = as.numeric(post_tmt_mass_g),
                post_mass_w_collar_Y_N = as.factor(post_mass_w_collar_Y_N),
                treatment_date_time = as.POSIXct(paste(treatment_date, processing_time, sep = " "), format = "%m/%d/%y %H:%M"),
                tmt_start_time = as.POSIXct(tmt_start_time, format = "%H:%M"),
                tmt_end_time = as.POSIXct(tmt_end_time, format = "%H:%M"),
                hematocrit_percent = as.numeric(hematocrit_percent),
                cloacal_temp_C = as.numeric(cloacal_temp_C)
                ) %>%
  
  # add tmt group info
  left_join(read.csv("data/collared_identification.csv"),
            by = 'individual_ID') %>%
  
  # add osmolality values from blood samples
  left_join(osmolality, by = c('individual_ID', 
                   'capture_process_date' = 'blood_draw_date')) %>%

  # add CEWL values
  left_join(CEWL, by = c('individual_ID', 
                   'capture_process_date' = 'date')) %>%
  
                # format data classes
  dplyr::mutate(individual_ID = as.factor(individual_ID),
                sex_M_F = as.factor(sex),
                tmt = as.factor(tmt),
                radio_collar_mass_g = as.numeric(radio_collar_mass_g),
                
                #statistics
                capture_to_msmt = as.numeric(treatment_date_time - capture_process_date_time),
                tmt_time_elapsed = as.numeric(tmt_end_time - tmt_start_time),
                #test = capture_process_date == treatment_date,
                actual_pre_tmt_mass_g = pre_tmt_mass_g - radio_collar_mass_g*(pre_mass_w_collar_Y_N == "Y"),
                actual_post_tmt_mass_g = post_tmt_mass_g - radio_collar_mass_g*(post_mass_w_collar_Y_N == "Y"),
                tmt_mass_change_g = actual_post_tmt_mass_g - actual_pre_tmt_mass_g
                )

summary(lizards_collared)
```


## Widespread Lizards

The second dataset loaded in is for lizards we caught opportunistically and who we did not radio-collar or track throughout the summer.

```{r get data widespread lizards}
lizards_widespread <- read.csv("data/widespread_measurements.csv") %>%
  
                # format data classes
  dplyr::mutate(date = as.Date(date, format = "%m/%d/%y"),
                # time with arbitrary date, need to figure out how to remove
                capture_time = as.POSIXct(capture_time, format = "%H:%M"),
                processing_time = as.POSIXct(processing_time, format = "%H:%M"),
                individual_ID = as.factor(individual_ID),
                SVL_mm = as.numeric(SVL_mm),
                mass_g = as.numeric(mass_g),
                sex_M_F = as.factor(sex_M_F),
                hematocrit_percent = as.numeric(hematocrit_percent),
                cloacal_temp_C = as.numeric(cloacal_temp_C)
                ) %>%

  # add osmolality values from blood samples
  left_join(osmolality, by = c('individual_ID', 
                   'date' = 'blood_draw_date')) %>%

  # add CEWL values
  left_join(CEWL, by = c('individual_ID', 'date')) %>%

                #statistics
  dplyr::mutate(capture_to_msmt = as.numeric(processing_time - capture_time)
                )

summary(lizards_widespread)
```





## Methods Stats

```{r n lizards}
# in general
length(unique(lizards_collared$individual_ID))
length(unique(lizards_widespread$individual_ID))
41+38

# by date
lizards_widespread %>%
  group_by(date) %>%
  summarise(n = n())
# by date
lizards_collared %>%
  group_by(capture_process_date) %>%
  summarise(n = n())

# which were recaptured and when
lizards_widespread %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  dplyr::filter(n > 1) -> recap_W
lizards_widespread %>% dplyr::filter(individual_ID %in% recap_W$individual_ID)
# which were recaptured and when
lizards_collared %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  dplyr::filter(n > 1) -> recap_C
lizards_collared %>% 
  dplyr::filter(individual_ID %in% recap_C$individual_ID) %>%
  dplyr::filter(capture_process_date > "2021-05-01")

# check things
lizards_collared %>% 
  dplyr::filter(individual_ID %nin% recap_C$individual_ID)
lizards_widespread %>% dplyr::filter(individual_ID == "W-029")
lizards_collared %>% dplyr::filter(individual_ID == "M-03a")
```

Throughout the summer, we measured 41 collared lizards, & 38 widespread lizards.

Of the 38 widespread lizards, 28 were captured in April, 9 in May, and 1 in July. 5 of the widespread lizards captured in APril were recaptured in May. 

Of the 41 collared lizards, 39 were captured (and collared) in April, 22 (of the 39) recaptured in May, and 14 (of the 39) recaptured in July. F08a and M03a were newly captured in May and radio-collared. F08a was a new capture, but M03a was briefly originally assigned W-029. Thankfully, the widespread data no longer includes that data, and it's been shifted to the collared data only. 


```{r capture to msmt}
# collared
mean(lizards_collared$capture_to_msmt, na.rm = TRUE)/60 # hours
median(lizards_collared$capture_to_msmt, na.rm = TRUE)/60
hist(lizards_collared$capture_to_msmt)
300/60

# widespread
mean(lizards_widespread$capture_to_msmt, na.rm = TRUE) # minutes
max(lizards_widespread$capture_to_msmt, na.rm = TRUE)
```

Most collared lizards were measured within 3 hours of capture, with the majority being measured within 2 hours of capture, and a few being measured the day after capture.

Widespread lizards were always measured within 5 hours of capture, and usually within 2 hours.

```{r tmt time}
mean(lizards_collared$tmt_time_elapsed, na.rm = T)
hist(lizards_collared$tmt_time_elapsed, na.rm = T)
```

Lizards were put in bins with shallow water for 1 hour, on average, to promote drinking behavior.


## Treatment Effects

Are there *ANY* differences between lizards who we gave water vs no water??

```{r tmt diffs}
lizards_collared %>%
  group_by(tmt, sex_M_F) %>%
  summarise(SVL_mean = mean(SVL_mm, na.rm = T),
            hct_mean = mean(hematocrit_percent, na.rm = T),
            osml_mean = mean(osmolality_mmol_kg_mean, na.rm = T),
            mass_change_mean = mean(tmt_mass_change_g, na.rm = T),
            CEWL_change_mean = mean(CEWL_g_m2h, na.rm = T)
            )
```

Only with mass it seems.

Are the widespread-caught lizards any different?

```{r wd diffs}
lizards_widespread %>%
  group_by(sex_M_F) %>%
  summarise(SVL_mean = mean(SVL_mm, na.rm = T),
            hct_mean = mean(hematocrit_percent, na.rm = T),
            osml_mean = mean(osmolality_mmol_kg_mean, na.rm = T),
            CEWL_mean = mean(CEWL_g_m2h, na.rm = T)
            )
```

Widespread lizards were simply the smaller ones that couldn't be radio-collared, so that's slightly different. Osmolality for those females seems higher than radio-collared control, but hct values seem on-par. 

We did recapture several widespread lizards, so I think it makes sense to put them on the same figures? Because that way, we can compare them to our control group. Maybe rename widespread -> "no intervention", control -> "sham tmt", and hydration -> "water tmt". :)




## Purge & Merge !

columns I want to have in BOTH:
- date
- ID
- SVL
- mass
- sex
- hct
- osml
- CEWL
- cloacal temp

```{r p n m}
widespread_clean <- lizards_widespread %>%
  dplyr::select(date,
                individual_ID,
                SVL_mm,
                mass_g,
                sex_M_F,
                hematocrit_percent,
                osmolality_mmol_kg_mean,
                cloacal_temp_C,
                capture_to_msmt
                ) %>%
  dplyr::mutate(tmt = as.factor("No Tmt"))

collared_clean <- lizards_collared %>%
  dplyr::select(date = capture_process_date,
                individual_ID,
                SVL_mm,
                mass_g = actual_pre_tmt_mass_g,
                sex_M_F,
                hematocrit_percent,
                osmolality_mmol_kg_mean,
                cloacal_temp_C,
                capture_to_msmt,
                tmt
                )

lizards_all <- rbind(widespread_clean, collared_clean) %>%
  dplyr::mutate(time_pt = as.factor(case_when(date == "2021-04-23 PDT" ~ 1, 
                                              date == "2021-04-24 PDT" ~ 1, 
                                              date == "2021-04-25 PDT" ~ 1,
                                              date == "2021-05-07 PDT" ~ 2,
                                              date == "2021-05-08 PDT" ~ 2,
                                              date == "2021-07-14 PDT" ~ 3))) %>%
  # easier to rejoin here
  left_join(CEWL, by = c('individual_ID', 'date'))

lizards_all$tmt <- factor(lizards_all$tmt,
                          levels = c("hydration", "control", "No Tmt"),
                          labels = c("Water Tmt", "Sham Tmt", "No Tmt")
                          )

lizards_all$time_pt <- factor(lizards_all$time_pt,
                              labels = c("April", "May", "July")
                              )

summary(lizards_all)
```



## Calculate Body Condition

This is also known as scaled mass index, or log-log residuals.

I calculate as described by: Peig, J., & Green, A. J. (2009). New perspectives for estimating body condition from mass/length data: The scaled mass index as an alternative method. Oikos, 118(12), 1883–1891. https://doi.org/10.1111/j.1600-0706.2009.17643.x


Step 0:

get subset of data with only April data:

```{r April only}
April_lizard_dat <- lizards_all %>%
  dplyr::filter(time_pt == "April")
```


Step 1: Simple Linear Regression

```{r SMI SLR}
mass_SVL_SLR <- lm(data = April_lizard_dat, mass_g ~ SVL_mm)
summary(mass_SVL_SLR)
```


Step 2: Identify Outliers

```{r SMI equation outliers 1}
plot(mass_SVL_SLR)
```

Hm, residuals are fanned-out, and many have high values, but they are evenly distrubuted on either side of zero.


So, check for high leverage points:

```{r high leverage}
# compute values for observations 
high_leverage <- data.frame(H = hatvalues(mass_SVL_SLR)
                            ) %>% mutate(row = rownames(.))

# compute cutoff value 
h_bar <- (3*sum(high_leverage$H))/nrow(high_leverage)

# add to original dataframe 
# see which observations have extremely high leverage (if any)
high_leverage_dat <- April_lizard_dat %>%
  dplyr::mutate(residuals = residuals(mass_SVL_SLR)) %>%
  dplyr::mutate(row = rownames(.)) %>%
  left_join(., high_leverage, by = "row") %>%
  dplyr::filter(H > h_bar) 
high_leverage_dat
```

The point for individual M-20 seems to be high-leverage, so we will try removing

Check for influential points based on Cook's distance:

```{r}
# get Cook's distance 
cooks <- data.frame(c = cooks.distance(mass_SVL_SLR) # specify model name 
                    ) %>% mutate(row = rownames(.))

# add to original dataframe 
influential <- April_lizard_dat %>%
  dplyr::mutate(residuals = residuals(mass_SVL_SLR)) %>%
  dplyr::mutate(row = rownames(.)) %>% 
  left_join(., cooks, by = "row")

# see moderately influential points 
cook_mod_inf <- influential %>% 
  dplyr::filter(c>0.5) 
cook_mod_inf
```

There are none, so there's nothing to potentially remove.


```{r SMI equation outliers 2}
boxplot(residuals(mass_SVL_SLR))
hist(residuals(mass_SVL_SLR))
max(residuals(mass_SVL_SLR))
influential %>% dplyr::filter(residuals < -10)
influential %>% dplyr::filter(residuals > 8)
```

From the boxplot, there are FOUR individuals with much larger residuals than the rest of the distribution. The histogram looks fine, and pretty normally distributed.


Test whether removing the high-leverage pt and the high residuals improve things:

```{r remove outliers}
cleaned_SMI_dat <- April_lizard_dat %>%
  dplyr::filter(individual_ID %nin% c("W-012", "W-015", 
                                      "M-07", "M-15", "M-20", 
                                      "F-03"))
```


re-check residuals:

```{r check 2}
mass_SVL_SLR2 <- lm(data = cleaned_SMI_dat, mass_g ~ SVL_mm)
summary(mass_SVL_SLR2)
plot(mass_SVL_SLR2)
mean(residuals(mass_SVL_SLR2))
median(residuals(mass_SVL_SLR2))
```

I don't think removing those points improved things much with residuals, but R-sq is a little better, so I will keep the subsetted dataset.


Step 3: log-log Regression

```{r SMI log log regression}
log_mass_SVL_SLR <- lm(data = cleaned_SMI_dat, 
                       log(mass_g) ~ log(SVL_mm))
summary(log_mass_SVL_SLR)
```


Step 4: Extract Values

compute standardized major axis using the log-log regression equation:

```{r SMI equation}
r <- sqrt(0.8526) # Pearson's correlection coefficient (sqrt of R-squared)
b_OLS <- 2.0891 # regression slope
b_SMA <- b_OLS/r
```

mean length in capture data:

```{r mean SVL}
L0 <- mean(April_lizard_dat$SVL_mm)
```


Step 5: Calculate Scaled Mass Index

```{r join all data}
lizards_all_SMI <- lizards_all %>%
  # compute SMI
  mutate(SMI = mass_g * ((L0/SVL_mm) ^ b_SMA))

summary(lizards_all_SMI)
```





# Experimental Hydration Effects

```{r tmt mass change plot}
ggplot(data = lizards_collared) + 
  geom_boxplot(aes(x = tmt, 
                   y = tmt_mass_change_g, 
                   color = tmt
                   )) +
  geom_jitter(aes(x = tmt, 
                   y = tmt_mass_change_g, 
                   color = tmt
                   ), 
               size = 0.6,
               alpha = 0.6) +
  geom_point(aes(x = tmt, 
                   y = mean(tmt_mass_change_g, na.rm = T), 
                   color = tmt,
                   ), 
               size = 6,
               alpha = 1) +
  geom_hline(yintercept = 0) +
  theme_classic() + 
  xlab("Treatment Group") + 
  ylab("Mass Change (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
)
```



```{r tmt mass change stats}
summary(lm(data = lizards_collared, tmt_mass_change_g ~ tmt))
```


So, it did result in a significant change in mass within the same-day water supplementation tmt (vs sham), but only 1.1g, on average.




# Look for Potential Correlations

first, load function to format correlation stats:

```{r func to format}
flattenCorrMatrix <- function(cormat, pmat) {
  ut <- upper.tri(cormat)
  data.frame(
    row = rownames(cormat)[row(cormat)[ut]],
    column = rownames(cormat)[col(cormat)[ut]],
    cor  =(cormat)[ut],
    p = pmat[ut]
    )
}
```

```{r corr}
num_only <- lizards_all_SMI %>%
  dplyr::select(SVL_mm, mass_g, SMI,
                hematocrit_percent, osmolality_mmol_kg_mean, 
                CEWL_g_m2h, cloacal_temp_C, msmt_temp_C, msmt_RH_percent,
                capture_to_msmt)
corr <- rcorr(as.matrix(num_only))
flattenCorrMatrix(corr$r, corr$P)
```

significant correlations to look into:
- CEWL / hct
- osml / hct
- SMI / osml
- SMI / hct
- cloacal temp /msmt temp/ msmt RH/ capture to msmst time
- CEWL / osml

somewhat meaningful:
- SMI / CEWL

surprising/sig NON correlations:
- CEWL / cloacal temp
- CEWL / msmt RH
- CEWL / msmt temp





# Tmt x Time Stats


```{r change by tmt * time}
# osmolality
summary(lm(data = lizards_all, osmolality_mmol_kg_mean ~ tmt:time_pt))
TukeyHSD(aov(lm(data = lizards_all, osmolality_mmol_kg_mean ~ tmt + time_pt)))

# hematocrit
summary(lm(data = lizards_all, hematocrit_percent ~ tmt:time_pt))

# mass
summary(lm(data = lizards_all, mass_g ~ tmt:time_pt))
summary(lm(data = lizards_all_SMI, SMI ~ tmt:time_pt))

# CEWL
summary(lm(data = lizards_all, CEWL_g_m2h ~ tmt:time_pt))
```

There was NO effect of treatment on CEWL, osmolality, hematocrit, or mass/SMI change throughout the season. 

So, we can carry on with all 3 treatment groups aggregated.


# Time Stats

```{r change over time only}
# only do for individuals measured at time points 1 and 2
indiv_over_time <- lizards_all_SMI %>%
  group_by(individual_ID) %>%
  summarise(n = n()) %>%
  dplyr::filter(n > 1)
lizards_over_time <- lizards_all_SMI %>%
  dplyr::filter(individual_ID %in% indiv_over_time$individual_ID)

# now the following stats will be "for lizards measured at >1 time pt..."

# osmolality
osml_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       osmolality_mmol_kg_mean ~ time_pt + (1|individual_ID)))
summary(osml_time_mod)

# hematocrit
hct_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       hematocrit_percent ~ time_pt + (1|individual_ID)))
summary(hct_time_mod)

# mass
mass_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       mass_g ~ time_pt + (1|individual_ID)))
summary(mass_time_mod)

#SMI
SMI_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       SMI ~ time_pt + (1|individual_ID)))
summary(SMI_time_mod)

# CEWL
CEWL_time_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       CEWL_g_m2h ~ time_pt + (1|individual_ID)))
summary(CEWL_time_mod)
```


# Time + Sex Stats

```{r diffs by sex + time}
# osmolality
osml_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       osmolality_mmol_kg_mean ~ time_pt + sex_M_F + (1|individual_ID)))
summary(osml_sex_mod)

# hematocrit
hct_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       hematocrit_percent ~ time_pt + sex_M_F + (1|individual_ID)))
summary(hct_sex_mod)

# mass
mass_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       mass_g ~ time_pt + sex_M_F + (1|individual_ID)))
summary(mass_sex_mod)

#SMI
SMI_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       SMI ~ time_pt + sex_M_F + (1|individual_ID)))
summary(SMI_sex_mod)

# CEWL
CEWL_sex_mod <- (lmerTest::lmer(data = lizards_over_time, 
                       CEWL_g_m2h ~ time_pt + sex_M_F + (1|individual_ID)))
summary(CEWL_sex_mod)
```
On average, with individual variation accounted for, osmolality and hematocrit both increased from April to May (but not for July). CEWL decreased from April to May, with no change for July. Mass increased from April to May, then decreased in July. 
...... AND, there are differences between the sexes! :O

Export those stats:

```{r export time stats}
osml_stats <- broom.mixed::tidy(osml_time_mod) %>%
  mutate(response = "Plasma Osmolality (mmol/kg)")
hct_stats <- broom.mixed::tidy(hct_time_mod) %>%
  mutate(response = "Hematocrit (%)")
SMI_stats <- broom.mixed::tidy(SMI_time_mod) %>%
  mutate(response = "Body Condition (g)")
CEWL_stats <- broom.mixed::tidy(CEWL_time_mod) %>%
  mutate(response = "CEWL (g/m2h)")

# aggregate and export
time_mod_stats <- osml_stats %>%
  rbind(hct_stats) %>%
  rbind(SMI_stats) %>%
  rbind(CEWL_stats)
write.csv(time_mod_stats, "./results_statistics/phys_change_over_time.csv")
```

```{r export time*sex stats}
osml_stats_ts <- broom.mixed::tidy(osml_sex_mod) %>%
  mutate(response = "Plasma Osmolality (mmol/kg)")
hct_stats_ts <- broom.mixed::tidy(hct_sex_mod) %>%
  mutate(response = "Hematocrit (%)")
SMI_stats_ts <- broom.mixed::tidy(SMI_sex_mod) %>%
  mutate(response = "Body Condition (g)")
CEWL_stats_ts <- broom.mixed::tidy(CEWL_sex_mod) %>%
  mutate(response = "CEWL (g/m2h)")

# aggregate and export
time_sex_mod_stats <- osml_stats_ts %>%
  rbind(hct_stats_ts) %>%
  rbind(SMI_stats_ts) %>%
  rbind(CEWL_stats_ts)
write.csv(time_sex_mod_stats,
          "./results_statistics/phys_change_over_time_by_sex.csv")
```




# Figures: Raw Values ~ Time

## Osmolality

```{r osml ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = osmolality_mmol_kg_mean, 
                group = individual_ID,
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = osmolality_mmol_kg_mean, 
                group = individual_ID,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Osmolality (mmol/kg)") + 
  #xlim(c("April", "May")) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> osml_over_time
osml_over_time

# export figure
#ggsave(filename = "osml_over_time.jpeg",
 #      plot = osml_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## Hct

```{r hct ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = hematocrit_percent, 
                group = individual_ID,
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = hematocrit_percent, 
                group = individual_ID,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Hematocrit (%)") + 
  #xlim(c("April", "May")) +
  ylim(20, 45) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> hct_over_time
hct_over_time

# export figure
#ggsave(filename = "hct_over_time.jpeg",
 #      plot = hct_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


Right now, I have the y-scale limited to exclude a few outliers.












## Scaled Mass

```{r mass ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = SMI, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = SMI, 
                group = individual_ID,
                color = individual_ID),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Body Condition (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> SMI_over_time
SMI_over_time

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL

```{r CEWL ~ time fig}
ggplot(data = lizards_over_time) + 
  geom_point(aes(x = time_pt, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("CEWL (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_over_time
CEWL_over_time

# export figure
#ggsave(filename = "CEWL_over_time.jpeg",
 #      plot = CEWL_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```




















# Figures: Mean Values ~ Time

First, I need to calculate the mean values.

```{r get means}
means_by_date_sex <- lizards_over_time %>%
  group_by(time_pt, sex_M_F) %>%
  summarise(hct_mean = mean(hematocrit_percent, na.rm = T),
            osml_mean = mean(osmolality_mmol_kg_mean, na.rm = T),
            mass_mean = mean(mass_g, na.rm = T),
            SMI_mean = mean(SMI, na.rm = T),
            CEWL_mean = mean(CEWL_g_m2h, na.rm = T))
means_by_date_sex
```



## Osmolality

```{r osml mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = osml_mean, 
                color = sex_M_F), 
               size = 3,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = osml_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 1,
            size = 1) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Osmolality (mmol/kg)") + 
  ylim(320,400) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2", 
                     labels = c("Female", "Male"),
                     name = "Sex") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "bottom"
) -> osml_mean_over_time
osml_mean_over_time

# export figure
ggsave(filename = "osml_mean_over_time.jpeg",
       plot = osml_mean_over_time,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```


## Hct

```{r hct mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = hct_mean, 
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = hct_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Hematocrit (%)") + 
  #xlim(c("April", "May")) +
  ylim(20, 45) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> hct_mean_over_time
hct_mean_over_time

# export figure
#ggsave(filename = "hct_over_time.jpeg",
 #      plot = hct_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


Right now, I have the y-scale limited to exclude a few outliers.












## Scaled Mass

```{r mass mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = SMI_mean, 
                color = sex_M_F), 
               size = 2,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = SMI_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 0.8) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab("Body Condition (g)") + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "right"
) -> SMI_mean_over_time
SMI_mean_over_time

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


## CEWL

```{r CEWL mean ~ time fig}
ggplot(data = means_by_date_sex) + 
  geom_point(aes(x = time_pt, 
                   y = CEWL_mean, 
                color = sex_M_F), 
               size = 3,
               alpha = 1) +
  geom_line(aes(x = time_pt, 
                   y = CEWL_mean, 
                group = sex_M_F,
                color = sex_M_F),
            alpha = 1,
            size = 1) +
  theme_classic() + 
  xlab("Time (not to scale)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  ylim(6,14) +
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  scale_color_brewer(palette = "Set2", 
                     labels = c("Female", "Male"),
                     name = "Sex") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "bottom"
) -> CEWL_mean_over_time
CEWL_mean_over_time

# export figure
ggsave(filename = "CEWL_mean_over_time.jpeg",
       plot = CEWL_mean_over_time,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```




















# Correlations

Make a figure and model for each of the following relationships-

## CEWL ~ Body Temp (no relationship?!)

```{r CEWL ~ body temp fig}
ggplot(data = lizards_all_SMI) + 
  geom_point(aes(x = cloacal_temp_C, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  stat_smooth(aes(x = cloacal_temp_C, 
                   y = CEWL_g_m2h), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              #color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  #xlim(27,37) +
  xlab("Body Temperature (°C)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_body_temp
CEWL_body_temp

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```


model:

```{r CEWL ~ body temp model}
CEWL_temp_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ cloacal_temp_C + (1|individual_ID))
summary(CEWL_temp_mod)
```




## CEWL ~ Body Condition (nonsig)


```{r CEWL ~ SMI fig}
ggplot(data = lizards_all_SMI) + 
  geom_point(aes(x = SMI, 
                   y = CEWL_g_m2h, 
                group = individual_ID,
                color = individual_ID), 
               size = 2,
               alpha = 1) +
  stat_smooth(aes(x = SMI, 
                   y = CEWL_g_m2h), 
              formula = y ~ x, 
              method = "lm", 
              se = F, 
              #color = temp_color,
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Body Condition (g)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #annotate("text", x = 1, y = 64, label = "a", size = 6) +
  #scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_SMI
CEWL_SMI

# export figure
#ggsave(filename = "SMI_over_time.jpeg",
 #      plot = SMI_over_time,
  #     path = "./results_figures",
   #    device = "jpeg",
    #   dpi = 1200,
     #  width = 6, height = 4)
```



model:

```{r CEWL ~ SMI model}
CEWL_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ SMI + (1|individual_ID))
summary(CEWL_SMI_mod)
```
































## CEWL ~ Osmolality

```{r CEWL osml fig}
ggplot(lizards_all) + 
  aes(x = osmolality_mmol_kg_mean,
      y = CEWL_g_m2h
      ) +
  geom_point(size = 1, 
             alpha = 0.4) + 
  stat_smooth(formula = y ~ x, 
              method = "lm", 
              se = F, 
              color = "slateblue4",
              size = 1.6, 
              alpha = 1) + 
  theme_classic() + 
  xlab("Plasma Osmolality (mmol/kg)") + 
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  #ylab("") +
  xlim(300, 450) +
  annotate(geom = "text", x = 430, y = 24, label = bquote(''*R^2*'=0.033'), 
           size = 7) +
  ylim(0, 25) +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 20),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 18),
        legend.text.align = 0,
        legend.position = "none"
        ) -> CEWL_osml_fig
CEWL_osml_fig

# export figure
ggsave(filename = "CEWL_osml_fig.jpeg",
       plot = CEWL_osml_fig,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```


model:

```{r CEWL~osml model}
CEWL_osml_mod1 <- lm(data = lizards_all,
                                CEWL_g_m2h ~ osmolality_mmol_kg_mean:time_pt)
CEWL_osml_mod2 <- lm(data = lizards_all,
                                CEWL_g_m2h ~ osmolality_mmol_kg_mean)
anova(CEWL_osml_mod1, CEWL_osml_mod2)

CEWL_osml_mod3 <- lmerTest::lmer(data = lizards_all,
                  CEWL_g_m2h ~ osmolality_mmol_kg_mean + (1|individual_ID))
CEWL_osml_mod4 <- lmerTest::lmer(data = lizards_all,
          CEWL_g_m2h ~ osmolality_mmol_kg_mean:time_pt + (1|individual_ID))

summary(CEWL_osml_mod3)
summary(CEWL_osml_mod4)


# export
#CEWL_osml_mod_stats <- broom.mixed::tidy(CEWL_osml_mod2) %>%
 # mutate(response = "CEWL (g/m2h)")
#write.csv(CEWL_osml_mod_stats,
 #         "./results_statistics/CEWL_osml_mod_stats.csv")
```





## CEWL ~ Hematocrit

model:

```{r CEWL ~ hct model}
CEWL_hct_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                CEWL_g_m2h ~ hematocrit_percent + (1|individual_ID))
summary(CEWL_hct_mod)
```



## Osmolality ~ Hematocrit


model:

```{r osml ~ hct model}
osml_hct_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                osmolality_mmol_kg_mean ~ hematocrit_percent + (1|individual_ID))
summary(osml_hct_mod)
```



## Osmolality ~ SMI


model:

```{r osml ~ SMI model}
osml_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                osmolality_mmol_kg_mean ~ SMI + (1|individual_ID))
summary(osml_SMI_mod)
```



## Hematocrit ~ SMI


model:

```{r osml ~ SMI model}
hct_SMI_mod <- lmerTest::lmer(data = lizards_all_SMI, 
                                hematocrit_percent ~ SMI + (1|individual_ID))
summary(hct_SMI_mod)
```



## Body Temp ~ Capture to Msmt Time ~ Msmt Temp ~ Msmt RH


Do I need to model this? It makes sense that they're all collinear. 



# Compare to Sceloporus


## Get S.o. Data

```{r load Sceloporus data}
Sceloporus1 <- read.csv("./data/Sceloporus_CEWL_1.csv") %>%
  dplyr::filter(region == "dors") %>%
  dplyr::select(date, individual_ID, CEWL_g_m2h = TEWL_g_m2h)
Sceloporus2 <- read.csv("./data/Sceloporus_CEWL_2.csv") %>%
  dplyr::filter(day == "capture") %>%
  dplyr::select(date, individual_ID, CEWL_g_m2h)
Sceloporus <- rbind(Sceloporus1, Sceloporus2) %>%
  mutate(species = "S. occidentalis",
         individual_ID = as.character(individual_ID))
```


## Merge S.o. and G.s.

```{r merge}
sp_compare <- lizards_all %>%
  dplyr::select(date, individual_ID, CEWL_g_m2h) %>%
  mutate(species = "G. sila",
         individual_ID = as.character(individual_ID)) %>%
  rbind(Sceloporus) 

sp_compare$species <- factor(sp_compare$species,
                             levels = c("S. occidentalis", "G. sila"))

sp_compare_means <- sp_compare %>%
  group_by(species) %>%
  summarise(mean_CEWL = mean(CEWL_g_m2h, na.rm = TRUE),
            sd_CEWL = sd(CEWL_g_m2h, na.rm = TRUE),
            min_CEWL = min(CEWL_g_m2h, na.rm = TRUE),
            max_CEWL = max(CEWL_g_m2h, na.rm = TRUE),
            range_CEWL = max_CEWL - min_CEWL)
sp_compare_means
```

I think I should present in the figure caption as mean ± SD (range).

So, "Mean ± SD (range) are as follows: S. occidentalis: 21.4 ± 6.6 (4.0 - 49.0); G. sila: 10.2 ± 4.0 (0.6 - 21.0)."


## Model Compare Avg CEWL

```{r model sp compare CEWL}
sp_compare_mod <- lm(data = sp_compare, CEWL_g_m2h ~ species)
summary(sp_compare_mod)
```


## Plot Compare Avg CEWL

this is the grand mean across dates and sexes

```{r compare sp CEWL}
ggplot() + 
  geom_boxplot(data = sp_compare,
               aes(x = species, 
                   y = CEWL_g_m2h, 
                color = species), 
               alpha = 1) +
  geom_point(data = sp_compare_means,
               aes(x = species, 
                   y = mean_CEWL, 
                color = species), 
               size = 6,
               alpha = 1) +
  theme_classic() + 
  xlab("") + 
  ylim(0, 55) +
  scale_y_continuous(breaks = c(0, 10, 20, 30, 40 , 50)) +
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  annotate("text", x = 1.5, y = 50, label = "p < 0.0001", size = 6) +
  scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_compare_sp
CEWL_compare_sp

# export figure
ggsave(filename = "CEWL_BNLL_vs_WFL.jpeg",
       plot = CEWL_compare_sp,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```














