---
title: "BNLL hydrophysiology analyses"
author: "Savannah Weaver"
date: "4/29/2021"
output: pdf_document
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("MASS")) install.packages("MASS") 
library("MASS")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("leaps")) install.packages("leaps") 
library("leaps") # for best subsets model selection
if (!require("pwr")) install.packages("pwr") 
library("pwr") # power analyses
if (!require("PerformanceAnalytics")) install.packages("PerformanceAnalytics")
library("PerformanceAnalytics") # pretty multicollinearity plots
```


# Load in Data

This data was collected during fieldwork with Blunt-nosed Leopard Lizards (*Gambelia sila*) in the Elkhorn Plain of the Carrizo Plain National Monument in California, USA during the 2021 active season (April-August). See _ for complete methods and discussion of these analyses. 


### Treatment, Morphometrics, and Blood Sample Data

Variables:

```{r}
dat <- read.csv("data/Supplemental Hydration collared BNLL.csv") %>%
  dplyr::mutate(capture_process_date = as.POSIXct(capture_process_date, format = "%m/%d/%y"),
                treatment_date = as.Date(treatment_date, format = "%m/%d/%y"),
                # time with arbitrary date, need to figure out how to remove
                capture_time = as.POSIXct(capture_time, format = "%H:%M"),
                processing_time = as.POSIXct(processing_time, format = "%H:%M"),
                tmt_start_time = as.POSIXct(tmt_start_time, format = "%H:%M"),
                tmt_end_time = as.POSIXct(tmt_end_time, format = "%H:%M"),
                pre_mass_w_collar. = as.factor(pre_mass_w_collar.),
                post_mass_w_collar. = as.factor(post_mass_w_collar.),
                hemolyzed. = as.factor(hemolyzed.)
                ) %>%
  dplyr::select(-date_blood_processed, # remove these since no longer need
                -notes) %>%
  left_join(read.csv("data/collared_BNLL_tmt_assignments.csv"),
            by = 'individual_ID') %>%
  dplyr::mutate(sex = as.factor(sex),
                tmt = as.factor(tmt)) %>%
  dplyr::filter(complete.cases(sex, osmolality_mmol_kg))
summary(dat)
```





### CEWL Data

Variables:
- date/time
- weekend = sequential sampling outing labels
- ID = lizard unique identifier
- TEWL = transepidermal water loss (same as CEWL, cutaneous evaporative water loss)
- CV = coefficient of variation when measurement was taken
- SSWL = ??
- ambient climate conditions (temperature, RH)
info about each variabl etc...

```{r, get CEWL data}
# weekend 1
CEWL_April_23_25 <- read.csv("./data/BNLL CEWL 4-23-2021 to 4-25-2021.csv") %>%
  dplyr::mutate(weekend = "1") # add weekend index for throughout season

# weekend 2
# etc etc 

# merge all CEWL datafiles & reformat
CEWL <- CEWL_April_23_25 %>%
  # join
  #rbind(., CEWL_May_xx, CEWL_May_xx, etc
    #      ) %>%
  # reformat data
  dplyr::select(Date, Time,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                CV = CV...., # rename
                SSWL_g_m2 = SSWL..g..m2.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH...., # rename
                weekend
                ) %>%
  dplyr::mutate(date_time = as.POSIXct(paste(Date, Time), format = "%m/%d/%y %I:%M:%S %p"),
                # date only
                Date = as.Date(Date, format = "%m/%d/%y"),
                # time with arbitrary date, need to figure out how to remove
                Time = as.POSIXct(Time, format = "%I:%M:%S %p"),
                # get length of current ID for editing
                length_ID = nchar((ID)),
                # extract CEWL replicate number
                replicate = as.numeric(substring(ID, length_ID, length_ID)),
                # extract group (male, female, widespread)
                ID_group = substring(ID, 1, 1),
                # extract ID number within group
                ID_number = substring(ID, 2, (length_ID-2)),
                # merge IDs to match format in other data files
                ID = paste(ID_group, "-", ID_number, sep = ""),
                weekend = as.numeric(weekend)
                ) %>%
  dplyr::select(-length_ID, # remove these since no longer need
                -ID_group,
                -ID_number
                )
summary(CEWL)
```




# Basic Trends

```{r}
dat %>% 
  ggplot(data = .) + 
  geom_line(aes(x = capture_process_date,
                 y = osmolality_mmol_kg, 
                color = individual_ID
                 ), 
             size = 1, 
             alpha = 0.6) + 
  #scale_colour_manual(name = "Treatment", 
   #                   #labels = c("Burrow", "Open", "Shrub"), 
    #                  values = c("salmon1", "royalblue") ) +
  #scale_shape_discrete(name = "Microhabitat", 
   #                    labels = c("Burrow", "Open", "Shrub") ) + 
  theme_classic() + 
  xlab("Date") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
        #legend.position = c(0.9, 0.145)
  )
```


```{r}
dat_by_tmt <- dat %>%
  group_by(tmt, weekend) %>%
  summarise(mean_osmol = mean(osmolality_mmol_kg))
```


```{r}
dat_by_tmt %>% 
  ggplot(data = .) + 
  geom_line(aes(x = weekend,
                 y = mean_osmol, 
                color = tmt
                 ), 
             size = 1, 
             alpha = 0.6) + 
  #scale_colour_manual(name = "Treatment", 
   #                   #labels = c("Burrow", "Open", "Shrub"), 
    #                  values = c("salmon1", "royalblue") ) +
  #scale_shape_discrete(name = "Microhabitat", 
   #                    labels = c("Burrow", "Open", "Shrub") ) + 
  theme_classic() + 
  xlab("Date") + 
  ylab("Osmolality") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
        #legend.position = c(0.9, 0.145)
  )
```





# Power Analysis

calculate f for ANOVA power analysis

```{r}
# grand mean
grand_mean_osmol <- dat %>%
  dplyr::filter(weekend == 1) %>%
  summarise(grand_mean = mean(osmolality_mmol_kg))

# control mean
mean_osmol_control <- dat %>%
  dplyr::filter(tmt == 'control' & weekend == 1) %>%
  summarise(control_mean = mean(osmolality_mmol_kg))

# control p = control n / total n


# hydration mean
mean_osmol_hydration <- dat %>%
  dplyr::filter(tmt == 'hydration' & weekend == 1) %>%
  summarise(hydration_mean = mean(osmolality_mmol_kg))

# between group variance 
# sum ( n * (group mean - grand mean)^2 )
```


power analysis

```{r}
# ANOVA with our current sample sizes
pwr.anova.test(k = 4, # number of groups (M/F x control/hydration)
               n = 8, # ~8 individuals in each group, due to dropped collars 
               f = 0.1, # want to be able to detect small effects 
               sig.level = 0.05
                 )

# ANOVA to find out n per group
pwr.anova.test(k = 4, # number of groups (M/F x control/hydration)
               f = 0.1, # want to be able to detect small effects 
               sig.level = 0.05, 
               power = 0.9
                 )
```































