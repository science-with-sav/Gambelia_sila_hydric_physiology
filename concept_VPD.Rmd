---
title: "making a conceptual diagram of VPD"
author: "Savannah Weaver"
date: "2023-08-22"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse") # for dplyr workflow + ggplot
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer") # plot colors
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("rmdformats")) install.packages("rmdformats")
library("rmdformats") # pretty Rmd format
```




# Create Fake, Conceptual Data

Values I want to visualize:

- vapor pressure deficit (kPa)
- air temperature (C)
- relative humidity, as a few set points (0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100)

```{r}
# RH formatting
RH_list <- c(seq(0,100,10))
RH_levels <- paste(as.character(sort(RH_list, decreasing = TRUE)), "%", sep = "")
  
# first, get every combo of temp and RH
dat <- data.frame(temp_C = sort(rep(c(20:40), 11)),
                  RH = rep(RH_list, 21)
                  ) %>% 
  # now get the VPD (Campbell & Normal 1998) for each temp x RH combo
  mutate(e_s_kPa = 0.611 * exp((17.502*temp_C)/(temp_C + 240.97)), # saturation VP
         e_a_kPa = e_s_kPa*((RH/100)), # actual VP
         VPD_kPa = e_s_kPa - e_a_kPa # VP deficit
         ) %>%
  # format things
  mutate(RH_ch = paste(as.character(RH), "%", sep = ""),
         RH_fact = factor(RH_ch, levels = RH_levels))
summary(dat)
```


get a subset of the dataframe that is 100% RH only:

```{r}
dat_100_only <- dat %>% 
  dplyr::filter(RH == 100)
dat_40_100_only <- dat %>% 
  dplyr::filter(RH %in% c(40,100)) %>% 
  mutate(RH = factor(RH))
```







# Make Pretty Plots

## Themes & Colors

```{r}
savs_ggplot_theme <- theme_classic() + 
                     theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 16),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 12),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 12),
                           legend.text.align = 0,
                           legend.position = "right",
                           legend.spacing.y = unit(1, "mm")
                           )

my_brew_cols <- brewer.pal(11, "RdYlBu")[c(1:5, 7:11)] # this one! delete 6 bc too faint
black <- brewer.pal(9, "Greys")[9]
my_brew_cols_combo <- c(my_brew_cols, black)
```






## Saturation VP

```{r}
ggplot() + 
  # all lines
  geom_smooth(data = dat,
              aes(x = temp_C,
                  y = e_a_kPa,
                  color = RH_fact),
              method = "loess",
              formula = y~x,
              se = F,
              size = 0.5) +
  # 100% RH only
  geom_smooth(data = dat_100_only,
              aes(x = temp_C,
                  y = e_a_kPa),
              method = "loess",
              formula = y~x,
              se = F,
              size = 1.2,
              color = "black") +
  # make pretty
  scale_color_manual(values = rev(my_brew_cols_combo), name = "Relative\nHumidity") +
  #scale_y_continuous(breaks = c(0:7), labels = c(0:7)) +
  xlab("Air Temperature (°C)") +
  ylab("Saturation Vapor Pressure (kPa)") +
  savs_ggplot_theme -> sat_VP_fig
sat_VP_fig
```




## VP Deficit 

```{r}
ggplot(data = dat) + 
  geom_point(aes(x = temp_C,
             y = VPD_kPa,
             color = RH))
```





## RH ~ Temp


```{r}
ggplot() + 
  geom_tile(
    data = dat,
    aes(
      x = temp_C,
      y = RH,
      fill = VPD_kPa
    )
  ) +
  
  # make pretty
  scale_fill_distiller(palette = "RdYlBu", limits = c(0, 8),
                       name = "VPD\n(kPa)") +
  scale_y_continuous(breaks = c(seq(0, 100, 25)), 
                     labels = c(seq(0, 100, 25)),
                     expand = c(0, 0.5),
                     name = "Relative Humidity (%)"
                     ) +
  scale_x_continuous(breaks = c(seq(20, 40, 5)),
                     labels = c(seq(20, 40, 5)),
                     expand = c(0, 0.1),
                     name = "Air Temperature (°C)"
                     ) +
  savs_ggplot_theme +
  theme(
    plot.margin = margin(0, 0, 0, 0, unit = "pt"),
    legend.spacing.y = unit(10, "pt")
  ) -> VPD_tile
VPD_tile
```






## Animated Bar Comparisons


### Base Plot

To start, make a plot of the saturation vapor pressure and vapor pressure at ~50% RH.


```{r}
ggplot() + 
  
  # RH lines
  geom_smooth(data = dat_40_100_only,
              aes(x = temp_C,
                  y = e_a_kPa,
                  group = RH,
                  color = RH),
              method = "loess",
              formula = y~x,
              se = F,
              size = 1.2) +
  
  # axis labels
  scale_x_continuous(limits = c(20, 42),
                     #expand = c(0, 0),
                     name = "Air Temperature (°C)") +
  scale_y_continuous(limits = c(0, 7.6),
                     expand = c(0, 0),
                     name = "Water Vapor Pressure (kPa)") +
  
  # line labels
  annotate(geom = "text", parse = F, x = 41.5, y = 3, label = "40%") +
  annotate(geom = "text", parse = F, x = 41.8, y = 7.43, label = "100%") +
  annotate(geom = "text", parse = F, x = 29, y = 4.6, angle = 30,
           label = "Saturation Vapor Pressure") +
  
  # colors
  scale_color_manual(values = c("gray70", "gray0")) +
  
  # themes
  savs_ggplot_theme +
  theme(
    legend.position = "none"
  ) -> VP_base_fig

VP_base_fig

ggsave(filename = "concept_VPD_0a.pdf",
       plot = VP_base_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 110, height = 90)
```






### Add Diff WVP Bars

```{r}
VP_diff_bar_fig <- VP_base_fig +
  geom_segment(aes(x = 25, xend = 25, y = 0, yend = 1.266), 
               color = "deepskyblue3", alpha = 0.8, size = 4) +
  geom_segment(aes(x = 35, xend = 35, y = 0, yend = 2.25), 
               color = "deepskyblue3", alpha = 0.8, size = 4) +
  annotate(geom = "text", parse = F, x = 26.5, y = 0.63, label = "1.2\nkPa") +
  annotate(geom = "text", parse = F, x = 36.5, y = 1.12, label = "2.2\nkPa")
VP_diff_bar_fig

ggsave(filename = "concept_VPD_1b.pdf",
       plot = VP_diff_bar_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 110, height = 90)
```





### Add VPD Bars

```{r}
VPD_diff_bar_fig <- VP_diff_bar_fig +
  geom_segment(aes(x = 25, xend = 25, y = 1.266, yend = 3.166), 
               color = "firebrick", size = 4) +
  geom_segment(aes(x = 35, xend = 35, y = 2.25, yend = 5.62), 
               color = "firebrick", size = 4) +
  annotate(geom = "text", parse = F, x = 26.5, y = 2.22, label = "1.9\nkPa") +
  annotate(geom = "text", parse = F, x = 36.5, y = 3.94, label = "3.4\nkPa")
VPD_diff_bar_fig

ggsave(filename = "concept_VPD_1c.pdf",
       plot = VPD_diff_bar_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 110, height = 90)
```









### Add WVP Ribbon

```{r}
VP_ribbon_fig <- VP_base_fig +
  # I think lines look better, and are more similar to the bar figs
  geom_segment(aes(x = 20, xend = 40, y = 2.34, yend = 2.34), 
               color = "deepskyblue3", alpha = 0.8, size = 2, linetype = "dashed") +
  geom_segment(aes(x = 40, xend = 40, y = 0, yend = 2.42), 
               color = "deepskyblue3", alpha = 0.8, size = 4) +
  # but could also use a ribbon instead
  # geom_ribbon(aes(x = c(20:40), ymin = 0, ymax = 2.34), 
  #             fill = "deepskyblue3", alpha = 0.5) +
  annotate(geom = "text", parse = F, x = 41.5, y = 1.17, label = "2.3\nkPa")
VP_ribbon_fig

ggsave(filename = "concept_VPD_2b.pdf",
       plot = VP_ribbon_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 110, height = 90)
```



### Add VPD Compare

```{r}
VPD_compare_fig <- VP_ribbon_fig +
  annotate(geom = "point", x = 20, y = 2.34, shape = 15, color = "deepskyblue3", size = 5) +
  geom_segment(aes(x = 35.5, xend = 35.5, y = 2.42, yend = 5.8), 
               color = "firebrick", size = 4) +
  annotate(geom = "text", parse = F, x = 37, y = 4.05, label = "3.6\nkPa")
VPD_compare_fig

ggsave(filename = "concept_VPD_2c.pdf",
       plot = VPD_compare_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 110, height = 90)
```


















# Export Figure

## All The Data

```{r}
ggsave(filename = "concept_VPD_all_lines.pdf",
       plot = sat_VP_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 150, height = 90)
ggsave(filename = "concept_VPD_tiles.pdf",
       plot = VPD_tile,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 50)
```



## Progressive Explanations


```{r}
VPD_concept_multi <- ggarrange(VPD_diff_bar_fig, VPD_compare_fig)

ggsave(filename = "concept_VPD_multi.pdf",
       plot = VPD_concept_multi,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 160, height = 90)
```




























