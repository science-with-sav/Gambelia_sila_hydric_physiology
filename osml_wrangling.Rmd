---
title: "BNLL Plasma Osmolality Data Wrangling"
author: "Savannah Weaver"
output: pdf_document
toc: TRUE
---


# Packages

```{r setup, include = TRUE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse")
library("tidyverse") # workflow and plots
```


# Background and Goals

Blood was drawn from the postorbital sinus of Blunt-nosed Leopard Lizards (*Gambelia sila*) between April - July 2021. After centrifuging and separating, plasma was run on a VAPRO vapor pressure osmometer in 1-3 replicates, when plasma volume allowed. In this R script, I check the distribution of replicates, omit outliers, and average remaining replicates. The final values will be more precise and accurate estimates of the true plasma osmolality for each lizard, and those values will be used in the analyses R script file. Please refer to **doi:** for the published scientific paper  and full details.


# Load Data

```{r load data}
osml_reps <- read.csv("./data/osmolality.csv",
                na.strings = c("","NA"),
                header = TRUE
                ) %>%
    dplyr::mutate(blood_draw_date = as.Date(blood_draw_date,
                                             format = "%m/%d/%y"),
                  individual_ID = as.factor(individual_ID),
                  replicate_no = as.factor(replicate_no),
                  osmolality_mmol_kg = as.numeric(osmolality_mmol_kg),
                  hemolyzed_Y_N = as.factor(hemolyzed_Y_N),
                  )
summary(osml_reps)
unique(osml_reps$blood_draw_date)
```


# Replicates

Now, I will try to identify outliers within the replicates for a given individual on a given date. There must be at least 3 replicates to do this, so the first thing I need to do is figure out which individuals/dates have enough replicates, then subset my data to be only those individuals.


## Individuals w 3+ Replicates

```{r separate data w enough reps to assess}
# identify individuals with 3-4 reps
enuf_reps <- osml_reps %>%
  group_by(individual_ID, blood_draw_date) %>%
  mutate(count = n()) %>%
  dplyr::filter(count > 2) %>%
  arrange(count)
enuf_reps

# identify individuals with 1-2 reps
not_reps <- osml_reps %>%
  group_by(individual_ID, blood_draw_date) %>%
  mutate(count = n()) %>%
  dplyr::filter(count < 3) %>%
  arrange(count)
not_reps

# check total obs still add to original 307
nrow(enuf_reps) + nrow(not_reps)
nrow(enuf_reps) + nrow(not_reps) == nrow(osml_reps)
```

Most of the blood samples had enough plasma for 3 reps :)


## Assess Variation

We want the Coefficient of Variation (CV) among our technical replicates to be small. We need to calculate it to identify whether there may be outliers.

```{r calculate CVs}
CVs <- enuf_reps %>%
  group_by(individual_ID, blood_draw_date) %>%
  summarise(mean = mean(osmolality_mmol_kg),
            SD = sd(osmolality_mmol_kg),
            CV = (SD/mean) *100,
            min = min(osmolality_mmol_kg),
            max = max(osmolality_mmol_kg),
            range = max - min
            )
summary(CVs)
hist(CVs$CV)
hist(CVs$range) 
```

Ideally, CV would be <10-15%. If it's larger, and one of the replicates is very different than the others, we can assume that the replicates that are closer together are more reliable. CV values look really good, which is surprising because the range of values for some groups of replicates is 20-60 mmol/kg, which is very very high. So, I don't think we will find statistical outliers, but it's important to omit singular points increasing the range of their replicate set.



## Find Outliers

```{r create find outlier function}
# write function to find outliers for each individual on each date
find_outliers <- function(df) {
  
  # initiate dataframe to compile info and list to compile plots
  outliers <- data.frame()
  #boxplots <- list()

  # initiate a for loop to go through every who in df
  for(indiv_ch in unique(df$individual_ID)) {
    
    # select data for only the individual of interest
    df_sub <- df %>%
      dplyr::filter(individual_ID == as.character(indiv_ch))
    
    # make a boxplot
    df_sub %>%
      ggplot(.) +
      geom_boxplot(aes(x = as.factor(blood_draw_date),
                       y = osmolality_mmol_kg,
                       fill = as.factor(blood_draw_date))) +
      ggtitle(paste("Individual", indiv_ch)) +
      theme_classic() -> plot
    
    # print/save
    print(plot)
    #boxplots[[indiv_ch]] <- plot
    
    # extract outliers
    outs <- df_sub %>%
      group_by(individual_ID, blood_draw_date) %>%
      summarise(outs = boxplot.stats(osmolality_mmol_kg)$out)
    
    # add to running dataframe of outliers
    outliers <- outliers %>%
      rbind(outs)
  }
  #return(boxplots)
  return(outliers)
}
```


Now apply the function to the data:

```{r find outlier using boxplots, fig.show="hold", out.width="50%"}
par(mfrow = c(71, 2))
outliers_found <- find_outliers(enuf_reps)
outliers_found
par(mfrow = c(1, 1))
```

As expected, based on boxplots, there are no outliers, but we still want to find and omit the points severely increasing the replicate ranges.


Determine which replicates lead to an increased CV... The osmometer is supposed to have measurement precision within a range of Â±3 mmol/kg, so generously, we will investigate variability in replicate sets with a range of >10. 

```{r find super different values}
# first, look at just the replicate sets with very (badly) high value ranges
high_ranges <- enuf_reps %>%
  group_by(individual_ID, blood_draw_date) %>%
  dplyr::mutate(mean = mean(osmolality_mmol_kg),
                SD = sd(osmolality_mmol_kg),
                CV = (SD/mean) *100,
                min = min(osmolality_mmol_kg),
                max = max(osmolality_mmol_kg),
                range = max - min
            ) %>%
  dplyr::filter(range > 10) %>%
  dplyr::select(individual_ID, blood_draw_date, CV, osmolality_mmol_kg, replicate_no)

CV_12 <- high_ranges %>% # get CV for only reps 1&2
    dplyr::filter(replicate_no != 3) %>%
    group_by(individual_ID, blood_draw_date) %>%
    summarise(mean = mean(osmolality_mmol_kg),
              SD = sd(osmolality_mmol_kg),
              CV = (SD/mean) *100) %>%
    mutate(rep_excluded = "3") %>%
    dplyr::select(-mean, -SD)
  
CV_23 <- high_ranges %>% # get CV for only reps 2&3
    dplyr::filter(replicate_no != 1) %>%
    group_by(individual_ID, blood_draw_date) %>%
    summarise(mean = mean(osmolality_mmol_kg),
              SD = sd(osmolality_mmol_kg),
              CV = (SD/mean) *100) %>%
    mutate(rep_excluded = "1") %>%
    dplyr::select(-mean, -SD)
  
CV_31 <- high_ranges %>% # get CV for only reps 3&1
    dplyr::filter(replicate_no != 2) %>%
    group_by(individual_ID, blood_draw_date) %>%
    summarise(mean = mean(osmolality_mmol_kg),
              SD = sd(osmolality_mmol_kg),
              CV = (SD/mean) *100) %>%
    mutate(rep_excluded = "2") %>%
    dplyr::select(-mean, -SD)

# figure out what replicate inflates CV (and range)
compare <- high_ranges %>%
    dplyr::select(individual_ID, blood_draw_date, CV) %>%
    mutate(rep_excluded = "none") %>%
    rbind(CV_12) %>%
    rbind(CV_23) %>%
    rbind(CV_31) %>%
  group_by(individual_ID, blood_draw_date) %>%
  dplyr::mutate(min_CV = min(CV),
                max_CV = max(CV),
                CV_diff = max_CV - min_CV) %>%
  dplyr::filter(min_CV == CV)
compare

hist(compare$CV_diff)
```





## Remove Outliers

```{r remove outlier}
# need to save these or they get filtered out by default with the NAs
save <- enuf_reps %>%
  left_join(compare, by = c("individual_ID", "blood_draw_date")) %>%
  dplyr::filter(is.na(rep_excluded) == TRUE)

# remove "outlying" replicates
cleaned <- enuf_reps %>%
  left_join(compare, by = c("individual_ID", "blood_draw_date")) %>%
  dplyr::filter(replicate_no != rep_excluded)

# check number of data obs
nrow(enuf_reps) == (nrow(compare) + nrow(save) + nrow(cleaned))

# check that we improved things
check <- save %>%
  rbind(cleaned) %>%
  group_by(individual_ID, blood_draw_date) %>%
  summarise(osmolality_mmol_kg_mean = mean(osmolality_mmol_kg),
            rep_SD = sd(osmolality_mmol_kg),
            rep_CV = (rep_SD/osmolality_mmol_kg_mean) *100,
            rep_min = min(osmolality_mmol_kg),
            rep_max = max(osmolality_mmol_kg),
            rep_range = rep_max - rep_min
            )
hist(check$rep_CV)
hist(check$rep_range) 
```

Much, MUCH better! :D


## Average Remaining Replicates

Now that the outliers are removed from the technical replicates when there were enough replicates to identify them, I will average the remaining replicates and check that it meaningfully improved things.

```{r calculate means}
osml_means <- not_reps %>%
  rbind(save) %>%
  rbind(cleaned) %>%
  group_by(individual_ID, blood_draw_date) %>%
  summarise(osmolality_mmol_kg_mean = mean(osmolality_mmol_kg))
```


# Export

```{r export cleaned}
write.csv(osml_means, "./data/osml_means_clean.csv")
```









