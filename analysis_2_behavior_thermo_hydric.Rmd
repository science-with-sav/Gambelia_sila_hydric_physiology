---
title: "Blunt-nosed Leopard Lizard Data Analysis: Behavior and Thermoregulation vs Water Physiology"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
```


# Background & Introduction


Telemetry response variables to test vs hydric physiology
-	Microhabitat use = proportion of observations doing x (above, partial shade, full shade, burrow)
-	Time of onset of estivation (once you no longer ever get aboveground obs)




# Load Data


## Lizard Data

This is the same dataframe used in 'analysis_1'.

```{r}
liz_dat <- read_rds("./data/G_sila_clean_full_dat.RDS") %>%
  # we only use data for radio collared lizards in this analysis
  dplyr::filter(complete.cases(radio_collar_serial)) %>%
  # add date chunks to help look at values over time
  mutate(date_chunks = factor(case_when(capture_date %in% c("2021-04-23", 
                                                     "2021-04-24", 
                                                     "2021-04-25") ~ "Apr 26 - May 6",
                                 capture_date %in% c("2021-05-07", 
                                                     "2021-05-08", 
                                                     "2021-05-09") ~ "May 10 - 20")))
liz_IDs_only <- liz_dat %>%
  group_by(radio_collar_serial, individual_ID, sex_M_F) %>%
  summarise(n = n()) %>%
  dplyr::select(-n)
```




## Tsurf + Wrangling

We measured the surface body temperature of lizards throughout the study using Holohil temperature-sensitive transmitters, which is the data we load in this section. 

variables in this dataframe:

- DateTime = date and time the temperature was logged
- Serial = the radio-collar serial number for that observation (to be used to link to specific individuals)
- Freq = what radio frequency the collar was on
- pp = the pulse period recorded by the radio-collar receiver (pulse period is a proxy for temperature)
- ppTempC = the pp value converted into temperature in degrees Celsius using third order polynomial functions estimated from the reference transformations provided by Holohil

```{r}
temps <- read.csv("./data/telemetry/tower_temps_all.csv") %>%
  # properly format data classes
  mutate(date_only = as.Date(substr(DateTime, 1, 10), format = "%Y-%m-%d"),
         hour_of_day = as.numeric(substr(DateTime, 12, 13)),
         DateTime = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M:%S"),
         Serial = factor(paste(substr(Serial, 1, 3), 
                               substr(Serial, 4, 7), sep = "-")),
         Freq = round(Freq, 2))

# save freq-serial link
freq_serial <- temps %>%
  group_by(Freq, Serial) %>%
  summarise(n = n()) #%>%
# check that there is 1 serial per frequency
#  group_by(Freq) %>%
 # summarise(n = n())

# look at temps dataframe
summary(temps)
unique(temps$Serial)
```



Subset the temperature data so that we do not use the temperatures from during up to 24h after the capturing and releasing lizards:
**NOTE** I will also need to remove any data for lizards that went missing, and for when we re-assigned collars.
These two radio collar serial numbers will be problematic. I need to go in to the Radio-collar temp data and add the "a" for data after the date we switched the collar to a new lizard.

**to do**
- 245-762-a
- 229-070-a

Also add columns for time chunks to make averaging easier later.

```{r}
# capture weekend dates
cap_dates <- as.Date(c("2021-04-23", "2021-04-24", "2021-04-25", # April
                        "2021-05-07", "2021-05-08", "2021-05-09"), # May
                     format = "%Y-%m-%d")

# grouping notes by date
group_dates <- data.frame(date_only = c(seq(as.Date("2021-04-26"), 
                                            as.Date("2021-07-13"), by = 1))) %>%
  dplyr::filter(date_only %nin% cap_dates) %>%
  mutate(date_chunks = factor(c(rep("Apr 26 - May 6", 11), 
                                rep("May 10 - 20", 11), 
                                rep("May 21 - 31", 11),
                                rep("Jun 1 - 11", 11),
                                rep("Jun 12 - 22", 11),
                                rep("Jun 23 - Jul 3", 11), 
                                rep("Jul 4 - 13", 10)),
                              levels = c("Apr 26 - May 6", "May 10 - 20", 
                                         "May 21 - 31", "Jun 1 - 11", "Jun 12 - 22", 
                                         "Jun 23 - Jul 3", "Jul 4 - 13")))

# subset dataset and add grouping notes
temp_sub <- temps %>%
  dplyr::filter(date_only %nin% cap_dates) %>%
  left_join(group_dates, by = 'date_only')
summary(temp_sub)
```


I also need to remove outliers, which are pretty standard erroneous points when using temperature-sensitive telemetry with devices external to the animal. I will follow Nicole Gaudenti's 2021 paper, and exclude "any outliers greater than two standard deviations away from each lizard's mean Tb"

, as these likely represented glitches in the data acquisition system; such outliers were uncommon (<5% of data points).

Look at data distribution:

```{r}
boxplot(temp_sub$ppTempC)
hist(temp_sub$ppTempC)
ggplot(temp_sub) +
  geom_point(aes(x = Serial,
                 y = ppTempC,
                 color = Serial)) +
  theme_classic()
ggplot(temp_sub) +
  geom_boxplot(aes(x = Serial,
                 y = ppTempC,
                 color = Serial)) +
  theme_classic()
```



Get mean and SD for each lizard's Tb data, then use it to filter out extreme values:

```{r}
temp_clean <- temp_sub %>%
  group_by(Serial) %>%
  #summarise(outs = boxplot.stats(ppTempC)$out) # less outliers found this way
  mutate(mean_Tb = mean(ppTempC),
         sd_Tb = sd(ppTempC)) %>%
  mutate(accept_low = mean_Tb - (2*sd_Tb),
         accept_high = mean_Tb + (2*sd_Tb)) %>%
  dplyr::filter(ppTempC < accept_high & ppTempC > accept_low) %>%
  dplyr::select(-mean_Tb, -sd_Tb, -accept_low, -accept_high)

summary(temp_clean)
```


What proportion of points did we remove?

```{r}
(nrow(temp_sub) - nrow(temp_clean))/nrow(temp_sub)
```

4.6%

Plot again:

```{r}
ggplot(temp_clean) +
  geom_point(aes(x = Serial,
                 y = ppTempC,
                 color = Serial)) +
  theme_classic()
ggplot(temp_clean) +
  geom_boxplot(aes(x = Serial,
                 y = ppTempC,
                 color = Serial)) +
  theme_classic()
```

Individual IQRs definitely look reasonable.




## Microhabitat Use

This data was collected by radio-tracking lizards, finding them, then recording what type of microhabitat they were in. We have to read-in a few files, because at first the formatting was not consistent, then put the dataframes all together.

variables in this dataframe:

- Serial = the radio-collar serial number for that observation (to be used to link to specific individuals)
- DateTime = date and time the temperature was logged
- microhabitat (was Micro_1) = which microhabitat lizards were observed in
- Breed_Col = breeding coloration of lizards (we will not use)
- bpmTempC = the temperature in Celsius from the lizards' collar, based on the handheld receivers used to locate them, which record the pulse interval in beats per minute rather than the pulse period of the tower receiver for other Tb data
- dwsTempOut = the temperature recorded by a weather station at the study site; these values were interpolated to the specific time of the observation since the weather station was only recording data every two hours
ModTempC = the ground surface temperature estimated by a temperature model (Ian Axsom) for the location and time that each observation occurred; this is an estimate of the operative temperature available to these lizards

This is the nice, clean data that was collected early May onwards:

```{r}
microhab_clean <- read.csv("./data/telemetry/behavior_observations.csv") %>%
  # force NAs on, then remove, observations for the "uncollared" lizard
  mutate(Serial_no = as.numeric(substr(Serial, 1, 5))) %>%
  dplyr::filter(complete.cases(Serial_no)) %>%
  # properly format data classes
  mutate(date_only = as.Date(substr(DateTime, 1, 10), format = "%Y-%m-%d"),
          hour_of_day = as.numeric(substr(DateTime, 12, 13)),
          DateTime = as.POSIXct(DateTime, format = "%Y-%m-%d %H:%M:%S"),
          Serial = factor(paste(paste(substr(as.character(Serial), 1, 3), 
                                     substr(as.character(Serial), 4, 7), sep = "-"))),
         microhabitat = factor(Micro_1,
                               labels = c("Burrow", # keep
                                          "", # change from Burrow slide
                                          "", # change from Burrow-Partial
                                          "", # change from Burrow/ephedra
                                          "", # change from Burrow/shrub
                                          "Dead/Missing", # keep
                                          "", # change from Grass trims
                                          "", # change from IDK
                                          "No Visual", # keep
                                          "Open", # keep
                                          "Shade - Full", # keep
                                          "Shade - Partial", # keep
                                          "Shade - Partial", # remove notes
                                          "Shade - Partial", # remove notes
                                          "Shade - Partial", # remove notes
                                          "Shade - Partial", # remove notes
                                          "Shade - Partial", # remove notes
                                          "Shade - Partial", # remove notes
                                          "Shade - Partial" # remove notes
                                          ))
         ) %>%
  # for some reason, it only works to fix the order separately
  mutate(microhabitat = factor(microhabitat,
                               levels = c("Open", 
                                          "Shade - Partial", 
                                          "Shade - Full", 
                                          "Burrow",
                                          "No Visual", "Dead/Missing"))) %>%
  dplyr::select(Serial, DateTime, date_only, hour_of_day, microhabitat, 
                bpmTempC, dwsTempOut, ModTempC) %>%
  # add date chunk grouping notes
  dplyr::filter(date_only %nin% cap_dates)
```


This is the messy data collected in late April and very early May. Unfortunately, the following radio-frequencies were unable to be linked to a serial number: 150.14, 150.19, 150.21, and 150.28. But, that only applied to 11 observations.

```{r}
microhab_early0 <- read.csv("./data/telemetry/behavior_observations_early_0.csv") %>%
  dplyr::select(date_only = date, time, 
                microhabitat = micro, 
                Serial = serial, 
                Freq = freq, freq_notes = X)
# this one must be split by whether freq or serial number of radio collars recorded
microhab_early0_freq_only <- microhab_early0 %>%
  dplyr::filter(!complete.cases(Serial)) %>%
  dplyr::select(-Serial)
microhab_early0_serial <- microhab_early0 %>%
  dplyr::filter(complete.cases(Serial)) %>%
  mutate(Serial = factor(paste(substr(Serial, 1, 3), 
                               substr(Serial, 4, 7), sep = "-")))

# load other csv, and add the dfs above to it
microhab_early_all <- read.csv("./data/telemetry/behavior_observations_early_1.csv") %>%
  dplyr::select(date_only = date, time, 
                microhabitat = micro, 
                Freq = freq, freq_notes) %>%
  rbind(microhab_early0_freq_only) %>%
  mutate(Freq = round(Freq, 2)) %>%
  left_join(freq_serial, by = 'Freq') %>%
  dplyr::select(-n) %>%
  rbind(microhab_early0_serial) %>%
  mutate(DateTime = as.POSIXct(paste(date_only, time, sep = " "), 
                               format = "%m/%d/%y %H:%M"),
         hour_of_day = as.numeric(substr(as.character(DateTime), 12, 13)),
         date_only = as.Date(date_only, format = "%m/%d/%y"),
         microhabitat = factor(str_to_title(microhabitat))) %>%
  dplyr::filter(complete.cases(Serial, microhabitat)) %>%
  # some of these were "focal observations" taken every few minutes
  # to be consistent with other obs, take first point of each focal
  group_by(Serial, date_only) %>%
  #summarise(min(date), max(date), min(time), max(time)) # check that data is one chunk
  # might remove a few usable data, but OK
  slice(1) %>%
  # remove these to make it easy to bind to clean one
  dplyr::select(-time, -Freq, -freq_notes) %>%
  # add these to make it easy to bind to clean one
  mutate(bpmTempC = NA, dwsTempOut = NA, ModTempC = NA)
summary(microhab_early_all) 
```



Now, put together the original and messy-now-clean dataframes, and add some formatting:

```{r}
microhab <- microhab_clean %>%
  rbind(microhab_early_all) %>%
  left_join(group_dates, by = 'date_only')

summary(microhab)
```





# Thermal Metrics

For each lizard, we want to calculate some assessment of how hot they let themselves be, and their thermoregulatory accuracy.



## Daily Maximums

```{r}
daily_max <- temp_clean %>%
  # quick look to use
  #dplyr::filter(date_chunks %in% c("Apr 26 - May 6", "May 10 - 20")) %>%
  
  # first do daily maximums
  group_by(date_only, date_chunks, Serial) %>%
  mutate(Tb_percentile_50 = quantile(ppTempC, 0.5),
         Tb_percentile_60 = quantile(ppTempC, 0.6),
         Tb_percentile_70 = quantile(ppTempC, 0.7),
         Tb_percentile_80 = quantile(ppTempC, 0.8),
         Tb_percentile_90 = quantile(ppTempC, 0.9)) %>%
  ungroup() %>%
  # select only the data between the 80-90th percentiles of Tb for each lizard
  dplyr::filter(ppTempC > Tb_percentile_80 & ppTempC < Tb_percentile_90) %>%
  # calculate the mean Tb for that subset for each lizard per day
  group_by(date_only, date_chunks, Serial) %>%
  summarise(daily_Tb_percentile_80_90 = mean(ppTempC)) %>%
  # then do the mean Tb between 80-90%ile for each lizard per time chunk (~11 days)
  group_by(date_chunks, Serial) %>%
  summarise(chunk_avg_Tb_percentile_80_90 = mean(daily_Tb_percentile_80_90))
summary(daily_max)
```








## Db

From Kat Ivey's 2020 paper, Tset range is: 32.3±1.2 - 37.5±1.1 deg C.

From Nicole Gaudenti's 2021 paper, Tset range: 33.2-37.9 deg C.

I will use the widest margin created by both:
32.3 (Ivey) - 37.9 (Gaudenti)

Sunrise during our study: 6:05-6:40 am --> middle ~~6:20?
Sunset during our study: 20:24-21:07 (8:24-9:07 pm) --> middle ~~20:40?
(entire study during DST)
from [NOAA solar calculator](https://gml.noaa.gov/grad/solcalc/)

Or, just use the same daily time range as Ivey did? (0700-1900)

Although Db is usually taken as the absolute value, I will use pos/neg values, because I want to know the directionality of Db.

```{r}
Db <- temp_clean %>%
  # we only want daytime Tb for this
  # currently using Kat's limits
  dplyr::filter(hour_of_day <=19 & hour_of_day >=7) %>%
  mutate(Tpref_low = 32.3,
         Tpref_high = 37.9) %>%
  mutate(Db = case_when(ppTempC < Tpref_low ~ ppTempC - Tpref_low, # for pos/neg version
                        #ppTempC < Tpref_low ~ Tpref_low - ppTempC, # for abs value version
                        ppTempC > Tpref_high ~ ppTempC - Tpref_high,
                        ppTempC < Tpref_high & ppTempC > Tpref_low ~ 0)) %>%
  group_by(date_chunks, Serial) %>%
  summarise(chunk_mean_Db_deg_C_diff = mean(Db))

summary(Db)
```




# Microhabitat Use


## Proportions of Observations

To calculate microhabitat use, I literally just calculate the proportion of observations for a given individual/time range that were in each microhabitat. 

*From Nicole's paper: We then calculated the percent of time G. sila used each microhabitat in May, June, and July at each site. To compare the probability that a lizard would be found underground (in burrows) between the two sites, we ran a mixed-effects logistic regression model in R (R Core Team, 2020; RStudio, 2020, lme4 package v. 1.1-26, Bates et al., 2015) with time as a polynomial, site and month as fixed effects, and lizard ID as a random effect.*

So, for each time chunk, for each lizard (radio-collar serial), I need to get the following values:

- number of total observations 
- number of observations in each microhabitat
- proportion of observations in each microhabitat
- aboveground temps based on Ian's model ?

**We do not have a lot of obs for each lizard for every time chunk, so how many observations should there be to make the proportions valid/reasonable?** One potential way to do this could be to at least have 1-2 obs for every microhabitat type we are trying to observe (so, minimum points per date chunk either 4 or 8, once I get rid of the irrelevant ones).

```{r}
MH_use_by_indiv <- microhab %>%
  group_by(Serial, date_chunks, microhabitat) %>%
  summarise(n_obs_micro = n()) %>%
  group_by(Serial, date_chunks) %>%
  mutate(n_obs_total = sum(n_obs_micro)) %>%
  ungroup() %>%
  mutate(MH_use_proportion = n_obs_micro/n_obs_total)
head(MH_use_by_indiv)
summary(MH_use_by_indiv)

MH_use_across_indivs <- microhab %>%
  group_by(date_chunks, microhabitat) %>%
  summarise(n_obs_micro = n(),
            mean_mod_temp = mean(ModTempC)) %>%
  group_by(date_chunks) %>%
  mutate(n_obs_total = sum(n_obs_micro),
         mean_mod_temp2 = mean(mean_mod_temp)) %>%
  ungroup() %>%
  mutate(MH_use_proportion = n_obs_micro/n_obs_total)
head(MH_use_across_indivs)
```


*Now*, I need to get rid of the non-microhabitat obs (i.e. "no visual") and only use props with enough obs to back them up. THEN, I can move on to joining & investigating bigger relationships. :)

```{r}
ggplot(MH_use_across_indivs) + 
    geom_bar(aes(x = date_chunks,
                 y = MH_use_proportion,
                 fill = microhabitat
                 ),
             position = "fill", 
             stat = "identity") +
  theme_classic()
ggplot(MH_use_by_indiv) + 
    geom_bar(aes(x = date_chunks,
                 y = MH_use_proportion,
                 fill = microhabitat
                 ),
             position = "fill", 
             stat = "identity") +
  facet_wrap(~Serial) +
  theme_classic()
```





# Join Data

## Temp + IDs


```{r}
temp_full <- daily_max %>%
  left_join(Db, by = c('Serial', 'date_chunks')) %>%
  # last time I tried, the date_chunks didn't
  left_join(liz_IDs_only, by = c('date_chunks', 'Serial' = 'radio_collar_serial'))

summary(temp_full)
```



## Temp & Hydric

Use to do linear regression of thermal/hab sel ~ hydration across lizards.
```{r}
#temp_hydric_dat <- temp_full 

#summary(temp_hydric_dat)
```







# Plot Temp ~ Time

### VTmax

```{r}
ggplot(temp_full) + 
  geom_boxplot(aes(x = date_chunks,
                   y = chunk_avg_daily_max_temp_C,
                   color = sex_M_F)) + 
  geom_point(aes(x = date_chunks,
                   y = chunk_avg_daily_max_temp_C,
                   color = sex_M_F)) +
  theme_classic()
```


### Tpref

```{r}
ggplot(temp_full) + 
  geom_point(aes(x = date_chunks,
                   y = chunk_median_temp_C,
                   color = sex_M_F)) +
  geom_boxplot(aes(x = date_chunks,
                   y = chunk_median_temp_C,
                   color = sex_M_F)) +
  #geom_errorbar(aes(x = date_chunks,
   #                 y = chunk_median,
    #                ymax = chunk_75th_quantile,
     #               ymin = chunk_25th_quantile)) +
  theme_classic()
```







