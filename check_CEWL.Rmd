---
title: "Blunt-nosed Leopard Lizard CEWL Measurement Triplicate Tests"
author: "Savannah Weaver"
date: "April 2021"
output: 
  pdf_document:
    toc: true
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("MASS")) install.packages("MASS") 
library("MASS")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
```


# Data Info

This data was collected during fieldwork with Blunt-nosed Leopard Lizards (*Gambelia sila*) in the Elkhorn Plain of the Carrizo Plain National Monument in California, USA during the 2021 active season (April-August). 


This is a preliminary analysis to decide whether CEWL measurements should be taken in triplicate or can be just one measurement.



# Load CEWL Data

Only the first weekend is loaded for now, but we can check with other replicates later. 

```{r, get CEWL data}
# weekend 1
CEWL_April_23_25 <- read.csv("./data/BNLL CEWL 4-23-2021 to 4-25-2021.csv") %>%
  dplyr::mutate(weekend = "1") # add weekend index for throughout season

# weekend 2
# etc etc 

# merge all CEWL datafiles & reformat
CEWL <- CEWL_April_23_25 %>%
  # join
  #rbind(., CEWL_May_xx, CEWL_May_xx, etc
    #      ) %>%
  # reformat data
  dplyr::select(Date, Time,
                ID = Comments,
                TEWL_g_m2h = TEWL..g..m2h.., # rename
                CV = CV...., # rename
                SSWL_g_m2 = SSWL..g..m2.., # rename
                ambient_temp_C = AmbT..C., # rename
                ambient_RH_percent = AmbRH...., # rename
                weekend
                ) %>%
  dplyr::mutate(date_time = as.POSIXct(paste(Date, Time), format = "%m/%d/%y %I:%M:%S %p"),
                # date only
                Date = as.Date(Date, format = "%m/%d/%y"),
                # time with arbitrary date, need to figure out how to remove
                Time = as.POSIXct(Time, format = "%I:%M:%S %p"),
                # get length of current ID for editing
                length_ID = nchar((ID)),
                # extract CEWL replicate number
                replicate = as.numeric(substring(ID, length_ID, length_ID)),
                # extract group (male, female, widespread)
                ID_group = substring(ID, 1, 1),
                # extract ID number within group
                ID_number = substring(ID, 2, (length_ID-2)),
                # merge IDs to match format in other data files
                ID = paste(ID_group, "-", ID_number, sep = ""),
                weekend = as.numeric(weekend)
                ) %>%
  dplyr::select(-length_ID, # remove these since no longer need
                -ID_group,
                -ID_number
                )
summary(CEWL)
```



# Basic Calculations


Get mean, sd, and CV values for each lizard's CEWL:

```{r, CEWL means and sds}
CEWL_rep_avg <- CEWL %>%
  group_by(Date, ID) %>% # put all keeps here
  # summaries
  summarise(mean_TEWL_g_m2h = mean(TEWL_g_m2h), 
            sd_TEWL_g_m2h = sd(TEWL_g_m2h),
            TEWL_CV = (sd_TEWL_g_m2h/mean_TEWL_g_m2h)*100
            )
```



# Plot CV Histogram


```{r}
CEWL_rep_avg %>%
  ggplot(., aes(x = TEWL_CV)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) +
  theme_classic() +
  xlab("Coefficient of Variation") + 
  ylab("Count") +
  labs(title = "All Three Replicates")
```



# Find CV of two most similar replicates

first, save out the CEWL data, remove the most different replicate for each lizard, and re-load the data

```{r}
write.csv(CEWL, "CEWL.csv")
CEWL_duplicates_only <- read.csv("./CEWL_culled.csv")
```

calculate CV again:

```{r}
CEWL_dup_avg <- CEWL_duplicates_only %>%
  group_by(Date, ID) %>% 
  summarise(mean_TEWL_g_m2h = mean(TEWL_g_m2h), 
            sd_TEWL_g_m2h = sd(TEWL_g_m2h),
            TEWL_CV = (sd_TEWL_g_m2h/mean_TEWL_g_m2h)*100
            )
```


replot:

```{r}
CEWL_dup_avg %>%
  ggplot(., aes(x = TEWL_CV)) +
  geom_histogram(color = "black", fill="steelblue", bins=50) +
  theme_classic() +
  xlab("Coefficient of Variation") + 
  ylab("Count") +
  labs(title = "Only Two Closest Replicates")
```




# Plot Replicates


```{r, plot CEWL reps}
CEWL %>% 
  ggplot(data = .) + 
  geom_point(aes(x = ID,
                 y = TEWL_g_m2h, 
                 color = ID
                 ), 
             size = 1, 
             alpha = 0.6) + 
  theme_classic() + 
  xlab("BNLL Individual ID") + 
  ylab("CEWL replicate values (g/m2h)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
        legend.position = "none"
)
```

It looks like there are two unusually high measurements - one replicate for the fifth lizard listed and one replicate for the third-to-last lizard listed. I think they're both above 40, so I could see how filtering them out affects replicability. 



Plot means:

```{r, plot CEWL means}
CEWL_rep_avg %>% 
  ggplot(data = .) + 
  geom_point(aes(x = ID,
                 y = mean_TEWL_g_m2h, 
                 color = ID
                 ), 
             size = 1, 
             alpha = 0.6) + 
  theme_classic() + 
  xlab("BNLL Individual ID") + 
  ylab("Mean CEWL (g/m2h)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
        legend.position = "none"
)
```


# Model Replicates

make a GLMM to figure out whether replicates have significantly different CEWL values:

```{r, CEWL model}
mod <- lme4::lmer(data = CEWL, TEWL_g_m2h ~ replicate + (1|ID))
mod2 <- nlme::lme(data = CEWL, TEWL_g_m2h ~ replicate, random = ~ 1|ID) # for p-values
summary(mod)
summary(mod2)
```



# Remove Unusual Points

```{r, remove unusual pts}
CEWL_sub <- CEWL %>%
  dplyr::filter(TEWL_g_m2h <= 40)
```




# Re-Plot

```{r, plot CEWL unusual pts removed}
CEWL_sub %>% 
  ggplot(data = .) + 
  geom_point(aes(x = ID,
                 y = TEWL_g_m2h, 
                 color = ID
                 ), 
             size = 1, 
             alpha = 0.6) + 
  theme_classic() + 
  xlab("BNLL Individual ID") + 
  ylab("CEWL replicate values (g/m2h)") + 
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 12),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 10),
        legend.text.align = 0,
        legend.position = "none"
)
```

This looks a lot better....



# Re-Model


```{r, CEWL model unusual pts removed}
mod3 <- lme4::lmer(data = CEWL_sub, TEWL_g_m2h ~ replicate + (1|ID))
mod4 <- nlme::lme(data = CEWL_sub, TEWL_g_m2h ~ replicate, random = ~ 1|ID) # for p-values
summary(mod3)
summary(mod4)
```


The p-values are still 0 even after removing the two unusually high points... 







# Conclusion

There's definitely a lot of variation among triplicate measurements for a given lizard, and the models show that variation is significant. I would conclude that it is important to take these measurements in triplicate to even out the variation in measurements. Taking measurements in triplicate will also allow us to exclude unusual points like the two in the first weekend's dataset, while still having the other replicates for that lizard for us to analyse.




















