---
title: "Blunt-nosed Leopard Lizard Data Analysis: Climate at the Study Site"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("viridis")) install.packages("viridis")
library("viridis")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
```




# Set Colors & Themes

```{r}
savs_ggplot_theme <- theme_bw() + 
                     theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom"
                           #plot.margin = margin(t = 6, r = 6, b = 0, l = 1, unit = "pt")
                           )
```









# Background











# Load Data


## Sunrise & Sunset

These times were obtained from [NOAA ESRL](https://gml.noaa.gov/grad/solcalc/table.php?lat=35.304442&lon=-120.65925&year=2021).

All sunrise & set times during our study are with saylight savings time in effect (1 hour shift).

sunrise times:

```{r}
sunrises <- read.csv("./data/Carrizo_sunrise_2021.csv")

rise_April <- sunrises %>%
  dplyr::select(Day, time = Apr) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "04", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))
rise_May <- sunrises %>%
  dplyr::select(Day, time = May) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "05", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))
rise_June <- sunrises %>%
  dplyr::select(Day, time = Jun) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "06", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))
rise_July <- sunrises %>%
  dplyr::select(Day, time = Jul) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "07", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))

sunrises_formatted <- rise_April %>%
  rbind(rise_May) %>%
  rbind(rise_June) %>%
  rbind(rise_July) %>%
  dplyr::select(date, sunrise) %>%
  mutate(date = as.Date(date))
head(sunrises_formatted)
```


sunset times:

```{r}
sunsets <- read.csv("./data/Carrizo_sunset_2021.csv")

set_April <- sunsets %>%
  dplyr::select(Day, time = Apr) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "04", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))
set_May <- sunsets %>%
  dplyr::select(Day, time = May) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "05", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))
set_June <- sunsets %>%
  dplyr::select(Day, time = Jun) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "06", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))
set_July <- sunsets %>%
  dplyr::select(Day, time = Jul) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "07", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))

sunsets_formatted <- set_April %>%
  rbind(set_May) %>%
  rbind(set_June) %>%
  rbind(set_July) %>%
  dplyr::select(date, sunset) %>%
  mutate(date = as.Date(date))
head(sunsets_formatted)
```




## Burrows

All burrow data is with daylight savings time in effect (1 hour shift), so it will pair to the sunrise/sunset times correctly.

```{r}
dat_HOBO <- read_rds("./data/burrow_HOBOs_BNLL_activeszn_2021.RDS") %>%
  # add sunrise and sunset times
  left_join(sunrises_formatted, by = c('date_only' = 'date')) %>%
  left_join(sunsets_formatted, by = c('date_only' = 'date')) %>%
  group_by(date_only) %>%
  mutate(daytime = case_when(date_time_PST >= sunrise & date_time_PST <= sunset ~ "day",
                             date_time_PST < sunrise ~ "night",
                             date_time_PST > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  ungroup()
summary(dat_HOBO)

# daytime only

# nighttime only
dat_HOBO_night <- dat_HOBO %>%
  dplyr::filter(daytime == "night")
summary(dat_HOBO_night)
# maybe this is pre-processing tho... 
```


## Weather Station

```{r}
# dat_Davis <- 
```





# Prep Data

## Daily Means

*If I decide not to split day/nighttime temps, all I need to do is delete the daytime grouping factor from the code in this and the next sections.*


```{r}
dat_HOBO_means_by_burrow <- dat_HOBO %>%
  # get daily means for each burrow/HOBO, for each date, daytime and nighttime
  # I could consider this step averaging across technical replicates
  group_by(HOBO_ID, date_only, daytime) %>%
  summarise(temp_C_daily_mean_by_HOBO = mean(temp_C),
            RH_daily_mean_by_HOBO = mean(RH_percent),
            VPD_kPa_daily_mean_by_HOBO = mean(VPD_kPa)
            ) 
dat_HOBO_means <- dat_HOBO_means_by_burrow %>%
  # get daily means & SD for each date, daytime and nighttime
  # ACROSS burrows
  # this step is literally just for plotting the mean values, not getting values for stats
  group_by(date_only, daytime) %>%
  summarise(n = n(),
            temp_C_daily_mean = mean(temp_C_daily_mean_by_HOBO),
            RH_daily_mean = mean(RH_daily_mean_by_HOBO),
            VPD_kPa_daily_mean = mean(VPD_kPa_daily_mean_by_HOBO),
            temp_C_daily_sd = sd(temp_C_daily_mean_by_HOBO),
            RH_daily_sd = sd(RH_daily_mean_by_HOBO),
            VPD_kPa_daily_sd = sd(VPD_kPa_daily_mean_by_HOBO),
            ) %>%
  # calculate standard error (SEM)
  mutate(temp_C_daily_se = temp_C_daily_sd/sqrt(n),
         RH_daily_se = RH_daily_sd/sqrt(n),
         VPD_kPa_daily_se = VPD_kPa_daily_sd/sqrt(n)) %>%
  # calculate standard error upper & lower limits
  mutate(temp_C_daily_se_upper = temp_C_daily_mean + temp_C_daily_se,
         temp_C_daily_se_lower = temp_C_daily_mean - temp_C_daily_se,
         RH_daily_se_upper = RH_daily_mean + RH_daily_se,
         RH_daily_se_lower = RH_daily_mean - RH_daily_se,
         VPD_kPa_daily_se_upper = VPD_kPa_daily_mean + VPD_kPa_daily_se,
         VPD_kPa_daily_se_lower = VPD_kPa_daily_mean - VPD_kPa_daily_se)
# do SEM for across HOBOs
summary(dat_HOBO_means)
```



## Date Chunk Means

Now, use daily means to get means across date chunks.

First, create the date chunks:


```{r}
# capture weekend dates
cap_dates <- as.Date(c("2021-04-23", "2021-04-24", "2021-04-25", # April
                        "2021-05-07", "2021-05-08", "2021-05-09"), # May
                     format = "%Y-%m-%d")

# grouping notes by date
group_dates <- data.frame(date_only = c(seq(as.Date("2021-04-26"), 
                                            as.Date("2021-07-13"), by = 1))) %>%
  dplyr::filter(date_only %nin% cap_dates) %>%
  mutate(date_chunks = factor(c(rep("Apr 26 - May 6", 11), 
                                rep("May 10 - 20", 11), 
                                rep("May 21 - 31", 11),
                                rep("Jun 1 - 11", 11),
                                rep("Jun 12 - 22", 11),
                                rep("Jun 23 - Jul 3", 11), 
                                rep("Jul 4 - 13", 10)),
                              levels = c("Apr 26 - May 6", "May 10 - 20", 
                                         "May 21 - 31", "Jun 1 - 11", "Jun 12 - 22", 
                                         "Jun 23 - Jul 3", "Jul 4 - 13")))
head(group_dates)
```



Join date chunks & daily mean data, then get the mean daily temps for that date chunk:

```{r}
dat_HOBO_chunks_by_burrow <- dat_HOBO_means_by_burrow %>%
  # add date chunks
  left_join(group_dates, by = 'date_only') %>%
  # remove NA values for date chunks (data on capture days, just for consistency)
  dplyr::filter(complete.cases(date_chunks)) %>%
  # get avg across days within a chunk for each HOBO
  group_by(HOBO_ID, date_chunks, daytime) %>%
  # get the avg of the avg daily mean (not sure if this is how I want to calculate?)
  summarise(temp_C_chunk_mean_by_HOBO = mean(temp_C_daily_mean_by_HOBO),
            RH_chunk_mean_by_HOBO = mean(RH_daily_mean_by_HOBO),
            VPD_kPa_chunk_mean_by_HOBO = mean(VPD_kPa_daily_mean_by_HOBO),
            n = n()
            ) %>%
  # only use an avg for a date chunk for a HOBO with at least 3 days in that chunk
  # removes 6 values
  dplyr::filter(n >= 3) %>%
  arrange(HOBO_ID, date_chunks, daytime)
```










# Statistics

My goal now is to calculate the emmeans, CI, and pairwise differences across HOBOs for each date chunk. **I need to do this for each climate variable, temperature, RH, and VPD.**

Then, I can use the emmeans +/- CI for plotting.

**NOTE** day vs night values are NOT different for burrows, so I think I should go back and remove that as a grouping variable, but that would require me also not using it as a grouping variable for the weather station data...

## HOBO Temperature

```{r}
HOBO_temp_lm <- lm(data = dat_HOBO_chunks_by_burrow,
                   temp_C_chunk_mean_by_HOBO ~ date_chunks #* daytime
                   )
#summary(HOBO_temp_lm)
HOBO_temp_emmean <- emmeans(HOBO_temp_lm, "date_chunks")
HOBO_temp_pairwise <- pairs(emmeans(HOBO_temp_lm, "date_chunks"))
```



## HOBO RH

```{r}
HOBO_RH_lm <- lm(data = dat_HOBO_chunks_by_burrow,
                   RH_chunk_mean_by_HOBO ~ date_chunks #* daytime
                   )
#summary(HOBO_temp_lm)
HOBO_RH_emmean <- emmeans(HOBO_RH_lm, "date_chunks")
HOBO_RH_pairwise <- pairs(emmeans(HOBO_RH_lm, "date_chunks"))
```



## HOBO VPD

```{r}
HOBO_VPD_lm <- lm(data = dat_HOBO_chunks_by_burrow,
                   VPD_kPa_chunk_mean_by_HOBO ~ date_chunks #* daytime
                   )
#summary(HOBO_temp_lm)
HOBO_VPD_emmean <- emmeans(HOBO_VPD_lm, "date_chunks")
HOBO_VPD_pairwise <- pairs(emmeans(HOBO_VPD_lm, "date_chunks"))
```
























# Figures

## Temperature

```{r}
ggplot(dat_HOBO_means) +
  aes(x = date_only,
      y = temp_C_daily_mean) +
  geom_point(aes(shape = daytime)) +
  xlab("Time") +
  ylab("Daily Mean Temperature (C)") +
  savs_ggplot_theme -> daily_temps_fig
daily_temps_fig
```


## Relative Humidity

```{r}
ggplot(dat_HOBO_means) +
  aes(x = date_only,
      y = RH_daily_mean) +
  geom_point(aes(shape = daytime)) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = as.Date("2021-04-25"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = as.Date("2021-05-08"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = as.Date("2021-07-14"),
             linetype = "dashed",
             color = "slategray") +
  xlab("Time") +
  ylab("Relative Humidity (%)") +
  savs_ggplot_theme -> daily_RH_fig
daily_RH_fig
```


## Vapor Pressure Deficit

```{r}
ggplot(dat_HOBO_means) +
  aes(x = date_only,
      y = VPD_kPa_daily_mean) +
  geom_point(aes(shape = daytime)) +
  xlab("Time") +
  ylab("Vapor Pressure Deficit (kPa)") +
  savs_ggplot_theme -> daily_VPD_fig
daily_VPD_fig
```









# Export Multi-Figure

```{r}
ggarrange(daily_temps_fig, daily_RH_fig, daily_VPD_fig,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> multi_climate

ggsave(filename = "climate_multi_figure.pdf",
       plot = multi_climate,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 200)
```














































