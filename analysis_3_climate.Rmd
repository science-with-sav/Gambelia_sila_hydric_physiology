---
title: "Blunt-nosed Leopard Lizard Data Analysis: Climate at the Study Site"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("viridis")) install.packages("viridis")
library("viridis")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
```




# Set Colors & Themes

```{r}
savs_ggplot_theme <- theme_bw() + 
                     theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom"
                           #plot.margin = margin(t = 6, r = 6, b = 0, l = 1, unit = "pt")
                           )
```









# Background











# Load Data


## Sunrise & Sunset

These times were obtained from [NOAA ESRL](https://gml.noaa.gov/grad/solcalc/table.php?lat=35.304442&lon=-120.65925&year=2021).

All sunrise & set times during our study are with saylight savings time in effect (1 hour shift).

sunrise times:

```{r}
sunrises <- read.csv("./data/Carrizo_sunrise_2021.csv")

rise_April <- sunrises %>%
  dplyr::select(Day, time = Apr) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "04", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))
rise_May <- sunrises %>%
  dplyr::select(Day, time = May) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "05", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))
rise_June <- sunrises %>%
  dplyr::select(Day, time = Jun) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "06", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))
rise_July <- sunrises %>%
  dplyr::select(Day, time = Jul) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "07", Day, sep = "-"),
         sunrise = as.POSIXct(paste(date, time, sep = " ")))

sunrises_formatted <- rise_April %>%
  rbind(rise_May) %>%
  rbind(rise_June) %>%
  rbind(rise_July) %>%
  dplyr::select(date, sunrise) %>%
  mutate(date = as.Date(date))
head(sunrises_formatted)
```


sunset times:

```{r}
sunsets <- read.csv("./data/Carrizo_sunset_2021.csv")

set_April <- sunsets %>%
  dplyr::select(Day, time = Apr) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "04", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))
set_May <- sunsets %>%
  dplyr::select(Day, time = May) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "05", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))
set_June <- sunsets %>%
  dplyr::select(Day, time = Jun) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "06", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))
set_July <- sunsets %>%
  dplyr::select(Day, time = Jul) %>%
  dplyr::filter(time != "") %>%
  mutate(date = paste("2021", "07", Day, sep = "-"),
         sunset = as.POSIXct(paste(date, time, sep = " ")))

sunsets_formatted <- set_April %>%
  rbind(set_May) %>%
  rbind(set_June) %>%
  rbind(set_July) %>%
  dplyr::select(date, sunset) %>%
  mutate(date = as.Date(date))
head(sunsets_formatted)
```




## Burrows

All burrow data is with daylight savings time in effect (1 hour shift), so it will pair to the sunrise/sunset times correctly.

```{r}
dat_HOBO <- read_rds("./data/burrow_HOBOs_BNLL_activeszn_2021.RDS") %>%
  # add sunrise and sunset times
  left_join(sunrises_formatted, by = c('date_only' = 'date')) %>%
  left_join(sunsets_formatted, by = c('date_only' = 'date')) %>%
  group_by(date_only) %>%
  mutate(daytime = case_when(date_time_PST >= sunrise & date_time_PST <= sunset ~ "day",
                             date_time_PST < sunrise ~ "night",
                             date_time_PST > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  ungroup()
summary(dat_HOBO)

# daytime only

# nighttime only
dat_HOBO_night <- dat_HOBO %>%
  dplyr::filter(daytime == "night")
summary(dat_HOBO_night)
# maybe this is pre-processing tho... 
```


## Weather Station

```{r}
# dat_Davis <- 
```





# Prep Data

## Daily Means

I think what's interesting is not day vs night, but burrow vs weather station.

```{r}
dat_HOBO_means <- dat_HOBO %>%
  # get daily means for each HOBO, each date, daytime and nighttime
  group_by(HOBO_ID, date_only, daytime) %>%
  summarise(temp_C_daily_mean_by_HOBO = mean(temp_C),
            RH_daily_mean_by_HOBO = mean(RH_percent),
            VPD_kPa_daily_mean_by_HOBO = mean(VPD_kPa)
            ) %>%
  # get daily means & SD for each date, daytime and nighttime
  group_by(date_only, daytime) %>%
  summarise(n = n(),
            temp_C_daily_mean = mean(temp_C_daily_mean_by_HOBO),
            RH_daily_mean = mean(RH_daily_mean_by_HOBO),
            VPD_kPa_daily_mean = mean(VPD_kPa_daily_mean_by_HOBO),
            temp_C_daily_sd = sd(temp_C_daily_mean_by_HOBO),
            RH_daily_sd = sd(RH_daily_mean_by_HOBO),
            VPD_kPa_daily_sd = sd(VPD_kPa_daily_mean_by_HOBO),
            sem = "sem :)" # left off here
            ) %>%
  # calculate standard error (SEM)
  mutate(temp_C_daily_se = temp_C_daily_sd/sqrt(n),
         RH_daily_se = RH_daily_sd/sqrt(n),
         VPD_kPa_daily_se = VPD_kPa_daily_sd/sqrt(n)) %>%
  # calculate standard error upper & lower limits
  mutate(temp_C_daily_se_upper = temp_C_daily_mean + temp_C_daily_se,
         temp_C_daily_se_lower = temp_C_daily_mean - temp_C_daily_se,
         RH_daily_se_upper = RH_daily_mean + RH_daily_se,
         RH_daily_se_lower = RH_daily_mean - RH_daily_se,
         VPD_kPa_daily_se_upper = VPD_kPa_daily_mean + VPD_kPa_daily_se,
         VPD_kPa_daily_se_lower = VPD_kPa_daily_mean - VPD_kPa_daily_se)
# do SEM for across HOBOs
summary(dat_HOBO_means)
```






































# Figures

## Temperature

```{r}
ggplot(dat_HOBO_means) +
  aes(x = date_only,
      y = temp_C_daily_mean) +
  geom_point(aes(shape = daytime)) +
  xlab("Time") +
  ylab("Daily Mean Temperature (C)") +
  savs_ggplot_theme -> daily_temps_fig
daily_temps_fig
```


## Relative Humidity

```{r}
ggplot(dat_HOBO_means) +
  aes(x = date_only,
      y = RH_daily_mean) +
  geom_point(aes(shape = daytime)) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = as.Date("2021-04-25"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = as.Date("2021-05-08"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = as.Date("2021-07-14"),
             linetype = "dashed",
             color = "slategray") +
  xlab("Time") +
  ylab("Relative Humidity (%)") +
  savs_ggplot_theme -> daily_RH_fig
daily_RH_fig
```


## Vapor Pressure Deficit

```{r}
ggplot(dat_HOBO_means) +
  aes(x = date_only,
      y = VPD_kPa_daily_mean) +
  geom_point(aes(shape = daytime)) +
  xlab("Time") +
  ylab("Vapor Pressure Deficit (kPa)") +
  savs_ggplot_theme -> daily_VPD_fig
daily_VPD_fig
```









# Export Multi-Figure

```{r}
ggarrange(daily_temps_fig, daily_RH_fig, daily_VPD_fig,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> multi_climate

ggsave(filename = "climate_multi_figure.pdf",
       plot = multi_climate,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 200)
```


















# Statistics


do I use the same 10-11-day chunks, and calc avgs, then compute pairwise diffs? or, something else? no stats?

should I do stats by month (microhab & climate), just to be comparable with Kay * Nicole??
































