---
title: "Blunt-nosed Leopard Lizard Data Analysis: Climate at the Study Site"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse") # for dplyr workflow + ggplot
if (!require("weathermetrics")) install.packages("weathermetrics")
library("weathermetrics") # convert F to C
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest") #LMMs with p-values
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer") # plot colors
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
```




# Set Colors & Themes

```{r}
savs_ggplot_theme <- theme_classic() + 
                     theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom"
                           )
```









# Background & Introduction

This data is for the local climate and burrow microclimates at our study site in the Carrizo Plain National Monument, CA, USA. The local climate comes from the Meso West online database, and we personally deployed data loggers in burrows to assess that microhabitat. Both datasets help us to contextualize the physiology, ecology, and behavior of endangered Blunt-nosed Leopard Lizards (*Gambelia sila*). 
\n
In this file, I will load data for: sunrise and sunset times at our study site, burrow microclimates, and local climate. I will run statistics on differences and plot the data to assess change in the study site climate throughout the active season our study took place.









# Load Data


## Sunrise & Sunset

These times were obtained from [NOAA ESRL](https://gml.noaa.gov/grad/solcalc/table.php?lat=35.304442&lon=-120.65925&year=2021).

All sunrise & set times during our study are with daylight savings time in effect (1 hour shift).

I only load in sunrise and sunset times for 2021, when we want to characterize the daytime versus nighttime local climate. 

\n
Sunrises:

```{r}
sunrises <- read.csv("./data/climate/Carrizo_sunrise_2021.csv")

sunrises_full <- sunrises %>% 
  # put in tidy data format
  pivot_longer(
    cols = !Day, 
    names_to = "month", 
    values_to = "time"
  ) %>%
  # get rid of empty data
  dplyr::filter(time != "") %>%
  dplyr::filter(complete.cases(Day))

sunrises_formatted <- sunrises_full %>% 
  mutate(date = as.POSIXct(paste("2021", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunrise = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)
head(sunrises_formatted)
```

\n
Sunsets:

```{r}
sunsets <- read.csv("./data/climate/Carrizo_sunset_2021.csv")

sunsets_full <- sunsets %>% 
  # put in tidy data format
  pivot_longer(
    cols = !Day, 
    names_to = "month", 
    values_to = "time"
  ) %>%
  # get rid of empty data
  dplyr::filter(time != "") %>%
  dplyr::filter(complete.cases(Day))

sunsets_formatted <- sunsets_full %>% 
  mutate(date = as.POSIXct(paste("2021", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunset = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)
head(sunsets_formatted)
```











## Burrows

All burrow data is with daylight savings time in effect (1 hour shift), so it will pair to the sunrise/sunset times correctly.

variables in this dataframe, as named in the following summary:

- date_time = date and time temp/RH was logged
- date_only
- HOBO_ID = ID number for the burrow/data logger that the measurements come from
- temp_C = burrow microclimate temperature in degrees Celsius
- RH_percent = burrow relative humidity in percent
- VPD_kPa = burrow vapor pressure deficit in kilo-Pascals, calculated from the temperature and relative humidity values for each time using equations published by Campbell & Normal (1998)
- daytime = whether data is from daytime or nighttime, based on the sunrise and sunset times loaded above

```{r}
dat_HOBO <- read_rds("./data/climate/burrow_HOBOs_BNLL_activeszn_2021.RDS") %>%
  # add sunrise and sunset times
  left_join(sunrises_formatted, by = c('date_only' = 'date')) %>%
  left_join(sunsets_formatted, by = c('date_only' = 'date')) %>%
  # for each date, add whether that date_time is day or night
  group_by(date_only) %>%
  mutate(daytime = case_when(date_time_PST >= sunrise & date_time_PST <= sunset ~ "day",
                             date_time_PST < sunrise ~ "night",
                             date_time_PST > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  ungroup() %>%
  # select only variables of interest
  dplyr::select(date_time = date_time_PST,
                date_only, HOBO_ID,
                temp_C, RH_percent, VPD_kPa,
                daytime)

summary(dat_HOBO)
length(unique(dat_HOBO$HOBO_ID)) # how many burrows did we log in?
```






## Cochora Weather Station

This climate data was collected by a weather station 3.7 km due east of the study site: [Cochora Ranch, station ID: CXXC1](https://mesowest.utah.edu/cgi-bin/droman/meso_base_dyn.cgi?stn=CXXC1).

I download data from this weather station from Sept 2017 to Sept 2021 in order to look at precipitation trends over time. For the local temperature and humidity, I will only use 2021 data.

I had to download it from the website in 1-year chunks, and there is 1 hour of overlap between each sequential file, so I will have to fix that.


variables in this dataframe:

- Station_ID = the weather station ID, designated by the organization collecting the data
- date_time = date and time weather station (ws) logged data
- air_temp_F = local ambient temperature in degrees Fahrenheit
- RH_percent = local relative humidity in percent
- wind_speed_mph = local wind speed in miles per hour
- precip_accum_one_hour_inches = amount of precipitation accumulated by the weather station over the last hour, in inches; resets to zero every hour when the weather station records data
- date_only
- temp_C = local ambient temperature in degrees Celsius
- e_s_kPa = saturation vapor pressure deficit, an intermediate step to calculate VPD
- VPD_kPa = local vapor pressure deficit in kilo-Pascals, calculated from the temperature and relative humidity values for each time using equations published by Campbell & Normal (1998)


The weather station data is with daylight savings time in effect (1 hour shift), so it will pair with the burrow data correctly. :D

```{r}
# get all data
dat_ws <- read_csv("./data/climate/CXXC1_weather_2017to2018.csv") %>%
  rbind(read_csv("./data/climate/CXXC1_weather_2018to2019.csv")) %>%
  rbind(read_csv("./data/climate/CXXC1_weather_2019to2020.csv")) %>%
  rbind(read_csv("./data/climate/CXXC1_weather_2020to2021.csv")) 

# pretty-fy
dat_ws_clean <- dat_ws %>%
  # remove repeat data rows
  distinct() %>% 
  # only get variables of interest
  dplyr::select(Station_ID,
                date_time = Date_Time, 
                air_temp_F, 
                RH_percent = relative_humidity_percent, 
                wind_speed_mph,
                precip_accum_one_hour_inches) %>%
  # remove rows with missing data
  dplyr::filter(complete.cases(air_temp_F, RH_percent)) %>%
  # format things
  mutate(date_time = as.POSIXct(date_time, format = "%m/%d/%Y %H:%M"),
         date_only = as.Date(substr(as.character(date_time), 1, 10),
                      format = "%Y-%m-%d"),
         temp_C = fahrenheit.to.celsius(air_temp_F, round = 2),
         # calculate vapor pressure deficit, Campbell & Normal 1998
         e_s_kPa = 0.611 * exp((17.502*temp_C)/(temp_C + 240.97)), # saturation VP
         # VPD
         VPD_kPa = e_s_kPa*(1 - (RH_percent/100))
         ) 

head(dat_ws_clean)
summary(dat_ws_clean)
```



















# Prep Data


## Weather Station Subset

Take a subset of weather station data only during our study to look at more closely:

```{r}
dat_ws_2021BNLL <- dat_ws_clean %>%
  # only during our study
  dplyr::filter(date_only > as.Date("2021-04-25") & 
                  date_only < as.Date("2021-07-14")) %>%
  # add sunrise/set times
  left_join(sunrises_formatted, by = c('date_only' = 'date')) %>%
  left_join(sunsets_formatted, by = c('date_only' = 'date')) %>%
  group_by(date_only) %>%
  mutate(daytime = case_when(date_time >= sunrise & date_time <= sunset ~ "day",
                             date_time < sunrise ~ "night",
                             date_time > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  ungroup() %>%
  # select only relevant variables
  dplyr::select(date_time,
                date_only, Station_ID,
                temp_C, RH_percent, VPD_kPa, wind_speed_mph,
                daytime)

summary(dat_ws_2021BNLL)
```






## Daily Means

Calculate daily mean temperature, humidity, and VPD for the weather station and each burrow where microclimate was recorded. 


### Burrows 

```{r}
dat_HOBO_means_by_burrow <- dat_HOBO %>%
  # get daily means for each burrow/HOBO, for each date
  # I would consider this step averaging across technical replicates
  group_by(HOBO_ID, date_only#, daytime # no diff for day vs night
           ) %>%
  summarise(temp_C_daily_mean_by_HOBO = mean(temp_C),
            RH_daily_mean_by_HOBO = mean(RH_percent),
            VPD_kPa_daily_mean_by_HOBO = mean(VPD_kPa)
            )
```


### Weather Station 

```{r}
dat_ws_means <- dat_ws_2021BNLL %>%
  # get daily means for each date, daytime and nighttime
  # I would consider this step averaging across technical replicates
  group_by(date_only, daytime # only one WS, compared to multiple burrow loggers
           ) %>%
  summarise(temp_C_daily_mean = mean(temp_C),
            RH_daily_mean = mean(RH_percent),
            VPD_kPa_daily_mean = mean(VPD_kPa),
            wind_mph_mean = mean(wind_speed_mph)
            )
```



## Time Period Means

Now, use daily means to get means across different time periods throughout the 
G. sila active season that we studied.
\n
First, create the time periods:

```{r}
# capture weekend dates = don't want data for days we measured lizards
cap_dates <- as.Date(c("2021-04-23", "2021-04-24", "2021-04-25", # April
                        "2021-05-07", "2021-05-08", "2021-05-09"), # May
                     format = "%Y-%m-%d")

# grouping by date
# create an inclusive range of the desired dates
group_dates <- data.frame(date_only = c(seq(as.Date("2021-04-26"), 
                                            as.Date("2021-07-13"), by = 1))) %>%
  # remove unwanted dates
  dplyr::filter(date_only %nin% cap_dates) %>%
  # add group labels for designated time periods
  mutate(date_chunks = factor(c(rep("Apr 26 - May 6", 11), 
                                rep("May 10 - 20", 11), 
                                rep("May 21 - 31", 11),
                                rep("Jun 1 - 11", 11),
                                rep("Jun 12 - 22", 11),
                                rep("Jun 23 - Jul 3", 11), 
                                rep("Jul 4 - 13", 10)),
                              levels = c("Apr 26 - May 6", "May 10 - 20", 
                                         "May 21 - 31", "Jun 1 - 11", "Jun 12 - 22", 
                                         "Jun 23 - Jul 3", "Jul 4 - 13")))

head(group_dates)
```




### Burrows

Join time periods & daily mean burrow data, then get the mean daily temps for each time period:

```{r}
dat_HOBO_chunks_by_burrow <- dat_HOBO_means_by_burrow %>%
  # add time periods
  left_join(group_dates, by = 'date_only') %>%
  # remove NA values for time periods (data on capture days, just for consistency)
  dplyr::filter(complete.cases(date_chunks)) %>%
  # get avg across days within a time periods for each HOBO/burrow
  group_by(HOBO_ID, date_chunks#, daytime
           ) %>%
  # get the avg daily mean for each time period for each burrow
  summarise(temp_C_chunk_mean_by_HOBO = mean(temp_C_daily_mean_by_HOBO),
            RH_chunk_mean_by_HOBO = mean(RH_daily_mean_by_HOBO),
            VPD_kPa_chunk_mean_by_HOBO = mean(VPD_kPa_daily_mean_by_HOBO),
            # how many days were successfully logged per time period per burrow?
            n = n()
            ) %>%
  # only use time periods for burrows with at least 3 days logged for that time period
  # removes 6 values
  dplyr::filter(n >= 3) %>%
  arrange(HOBO_ID, date_chunks) 
```


### Weather Station

Join time periods & daily mean local weather station data, then get the mean daily temps for each time period:

```{r}
dat_ws_chunk_means <- dat_ws_means %>%
  # add time periods
  left_join(group_dates, by = 'date_only') %>%
  # remove NA values for time periods (data on capture days, just for consistency)
  dplyr::filter(complete.cases(date_chunks)) %>%
  # get avg across days within a time periods for each daytime and nighttime 
  group_by(date_chunks, daytime
           ) %>%
  # get the avg daily mean per time period
  summarise(temp_C_chunk_mean = mean(temp_C_daily_mean),
            RH_chunk_mean = mean(RH_daily_mean),
            VPD_kPa_chunk_mean = mean(VPD_kPa_daily_mean),
            wind_speed_mph_chunk_mean = mean(wind_mph_mean),
            n = n()
            )
```





# Statistics

To assess burrow microclimate throughout the G. sila active season, I can run a linear mixed effects model of each microclimate variable based on time period, with burrow ID as a random effect. From these models, I will calculate the marginal mean and confidence interval of each microclimate variable across burrows for each time period. The same statistics are not feasible for the weather station data, because only one weather station was logging, compared to ~12 burrow loggers.

\n
Daytime vs nighttime values were NOT different for burrows, so I commented-out that as a grouping variable. To see those (essentially nonexistent) differences, simply add it back to the model.

## HOBO Temperature

```{r}
HOBO_temp_lm <- lmerTest::lmer(data = dat_HOBO_chunks_by_burrow,
                   temp_C_chunk_mean_by_HOBO ~ date_chunks + #* daytime 
                   (1|HOBO_ID)
                   )

HOBO_temp_emmean <- data.frame(emmeans(HOBO_temp_lm, "date_chunks")) %>%
  # add reference for plots
  mutate(type = "Burrow")

HOBO_temp_pairwise <- pairs(emmeans(HOBO_temp_lm, "date_chunks"))
HOBO_temp_pairwise
```

burrow temperature pairwise comparisons that are *not* different, so will have the same letter when I make figures:

- (May 10 - 20) - (May 21 - 31)


burrow temperature pairwise comparison groups for when I make figures:

- Apr 26 - May 6 = A
- May 10 - 20 = B
- May 21 - 31 = B
- Jun 1 - 11 = C
- Jun 12 - 22 = D
- Jun 23 - Jul 3 = E
- Jul 4 - 13 = F


## HOBO RH

```{r}
HOBO_RH_lm <- lmerTest::lmer(data = dat_HOBO_chunks_by_burrow,
                   RH_chunk_mean_by_HOBO ~ date_chunks + #* daytime
                   (1|HOBO_ID)
                   )

HOBO_RH_emmean <- data.frame(emmeans(HOBO_RH_lm, "date_chunks")) %>%
  # add reference for plots
  mutate(type = "Burrow")

HOBO_RH_pairwise <- pairs(emmeans(HOBO_RH_lm, "date_chunks"))
HOBO_RH_pairwise
```

burrow humidity pairwise comparison groups for when I make figures:

- Apr 26 - May 6 = A
- May 10 - 20 = AB
- May 21 - 31 = AB
- Jun 1 - 11 = AB
- Jun 12 - 22 = B
- Jun 23 - Jul 3 = B
- Jul 4 - 13 = B






## HOBO VPD

```{r}
HOBO_VPD_lm <- lmerTest::lmer(data = dat_HOBO_chunks_by_burrow,
                   VPD_kPa_chunk_mean_by_HOBO ~ date_chunks + #* daytime
                   (1|HOBO_ID)
                   )

HOBO_VPD_emmean <- data.frame(emmeans(HOBO_VPD_lm, "date_chunks")) %>%
  # add reference for plots
  mutate(type = "Burrow")

HOBO_VPD_pairwise <- pairs(emmeans(HOBO_VPD_lm, "date_chunks"))
HOBO_VPD_pairwise
```

burrow VPD pairwise comparison groups for when I make figures:

- (Apr 26 - May 6) - (May 10 - 20) - (May 21 - 31) = A
- (May 10 - 20) - (May 21 - 31) - (Jun 1 - 11) = B
- (Jun 12 - 22) - (Jun 23 - Jul 3) = C
- (Jun 23 - Jul 3) - (Jul 4 - 13) = D

A
AB
AB
B
C
CD
D


























# Figures

For the temperature, RH, and VPD plots, I include data from individual burrows, statistics for across burrows based on time period, and average local climate from the weather station. 

## Temperature

```{r}
ggplot() +
  # data from individual burrows
  geom_jitter(data = dat_HOBO_chunks_by_burrow,
             aes(x = date_chunks,
                 y = temp_C_chunk_mean_by_HOBO
                 ),
             alpha = 0.3,
             size = 0.9,
              position = position_jitter(height = 0, width = 0.2)) +
  # show trend across time
  geom_line(data = HOBO_temp_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 group = 1 # tell ggplot it's okay to only have 1 obs per x value
                 ),
             alpha = 0.2,
             size = 0.5) +
  # marginal mean burrow conditions per time period, from LMM
  geom_point(data = HOBO_temp_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 color = type
                 ),
             alpha = 1,
             size = 2) +
  # marginal mean confidence intervals
  geom_errorbar(data = HOBO_temp_emmean,
                aes(x = as.numeric(date_chunks)-0.1,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL
                    ),
                width = .2) +
  # weather station data
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = temp_C_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  labs(y = "Temperature (°C)") +
  scale_x_discrete(labels = c("Apr 26\n-May 6",
                              "May\n10-20",
                              "May\n21-31",
                              "Jun\n1-11",
                              "Jun\n12-22",
                              "Jun 23\n-Jul 3",
                              "Jul\n4-13"
                              ),
                   name = "") +
  # time period pairwise differences
  annotate(geom = "text", x = 1, y = 37, label = "A", size = 3) +
  annotate(geom = "text", x = 2, y = 37, label = "B", size = 3) +
  annotate(geom = "text", x = 3, y = 37, label = "B", size = 3) +
  annotate(geom = "text", x = 4, y = 37, label = "C", size = 3) +
  annotate(geom = "text", x = 5, y = 37, label = "D", size = 3) +
  annotate(geom = "text", x = 6, y = 37, label = "E", size = 3) +
  annotate(geom = "text", x = 7, y = 37, label = "F", size = 3) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5,
             linetype = "dashed",
             size = 0.5) +
  geom_vline(xintercept = 1.5, 
             linetype = "dashed",
             size = 0.5) +
  geom_vline(xintercept = 7.5,
             linetype = "dashed",
             size = 0.5) +
  # these are for the weather station points
  scale_fill_manual(values = c(brewer.pal(11, "RdYlBu")[c(1,10)]), name = NULL,
                    labels = c("Aboveground\nDaytime", "Aboveground\nNighttime")
                     ) +
  scale_shape_manual(values = 24:25, name = NULL,
                    labels = c("Aboveground\nDaytime", "Aboveground\nNighttime")
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = NULL, labels = "Burrow"
                     ) +
  # additional formatting
  ylim(16, 37) +
  savs_ggplot_theme +
  theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 5, unit = "pt"),
        legend.margin = margin(0,0,0,0, unit = "pt")) -> daily_temps_fig
daily_temps_fig

ggsave(filename = "climate_temp_standalone.pdf",
       plot = daily_temps_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 80
       )
```


## Relative Humidity

```{r}
ggplot() +
  geom_jitter(data = dat_HOBO_chunks_by_burrow,
             aes(x = date_chunks,
                 y = RH_chunk_mean_by_HOBO,
                 ),
             alpha = 0.3,
             size = 0.9,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_line(data = HOBO_RH_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 group = 1 # tell ggplot it's okay to only have 1 obs per x value
                 ),
             alpha = 0.2,
             size = 0.5) +
  geom_point(data = HOBO_RH_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 color = type
                 ),
             alpha = 1,
             size = 2) +
  geom_errorbar(data = HOBO_RH_emmean,
                aes(x = as.numeric(date_chunks)-0.1,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL
                    ),
                width = .2) +
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = RH_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  labs(y = "Relative Humidity (%)") +
  scale_x_discrete(labels = c("Apr 26\n-May 6",
                              "May\n10-20",
                              "May\n21-31",
                              "Jun\n1-11",
                              "Jun\n12-22",
                              "Jun 23\n-Jul 3",
                              "Jul\n4-13"
                              ),
                   name = "") +
  # time period differences
  annotate(geom = "text", x = 1, y = 107, label = "A", size = 3) +
  annotate(geom = "text", x = 2, y = 107, label = "AB", size = 3) +
  annotate(geom = "text", x = 3, y = 107, label = "AB", size = 3) +
  annotate(geom = "text", x = 4, y = 107, label = "AB", size = 3) +
  annotate(geom = "text", x = 5, y = 107, label = "B", size = 3) +
  annotate(geom = "text", x = 6, y = 107, label = "B", size = 3) +
  annotate(geom = "text", x = 7, y = 107, label = "B", size = 3) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5,
             linetype = "dashed",
             size = 0.5) +
  geom_vline(xintercept = 1.5, 
             linetype = "dashed",
             size = 0.5) +
  geom_vline(xintercept = 7.5,
             linetype = "dashed",
             size = 0.5) +
  # these are for the weather station points
  scale_fill_manual(values = c(brewer.pal(11, "RdYlBu")[c(1,10)]), name = NULL,
                    labels = c("Aboveground\nDaytime", "Aboveground\nNighttime")
                     ) +
  scale_shape_manual(values = 24:25, name = NULL,
                    labels = c("Aboveground\nDaytime", "Aboveground\nNighttime")
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = NULL, labels = "Burrow"
                     ) +
  scale_y_continuous(limits = c(0, 107),
                     breaks = c(seq(0, 100, 20)),
                     labels = c(seq(0, 100, 20))) + 
  savs_ggplot_theme +
  theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 0.5, unit = "pt"),
        legend.margin = margin(0,0,0,0, unit = "pt")) -> daily_RH_fig
daily_RH_fig

ggsave(filename = "climate_RH_standalone.pdf",
       plot = daily_RH_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 80
       )
```


## Vapor Pressure Deficit

```{r}
ggplot() +
  geom_jitter(data = dat_HOBO_chunks_by_burrow,
             aes(x = date_chunks,
                 y = VPD_kPa_chunk_mean_by_HOBO
                 ),
             alpha = 0.3,
             size = 0.9,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_line(data = HOBO_VPD_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 group = 1 # tell ggplot it's okay to only have 1 obs per x value
                 ),
             alpha = 0.2,
             size = 0.5) +
  geom_point(data = HOBO_VPD_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 color = type
                 ),
             alpha = 1,
             size = 2) +
  geom_errorbar(data = HOBO_VPD_emmean,
                aes(x = as.numeric(date_chunks)-0.1,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL
                    ),
                width = .2) +
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = VPD_kPa_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  labs(y = "VPD (kPa)") +
  scale_x_discrete(labels = c("Apr 26\n-May 6",
                              "May\n10-20",
                              "May\n21-31",
                              "Jun\n1-11",
                              "Jun\n12-22",
                              "Jun 23\n-Jul 3",
                              "Jul\n4-13"
                              ),
                   name = "") +
  # time period differences
  annotate(geom = "text", x = 1, y = 5, label = "A", size = 3) +
  annotate(geom = "text", x = 2, y = 5, label = "AB", size = 3) +
  annotate(geom = "text", x = 3, y = 5, label = "AB", size = 3) +
  annotate(geom = "text", x = 4, y = 5, label = "B", size = 3) +
  annotate(geom = "text", x = 5, y = 5, label = "C", size = 3) +
  annotate(geom = "text", x = 6, y = 5, label = "CD", size = 3) +
  annotate(geom = "text", x = 7, y = 5, label = "D", size = 3) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5,
             linetype = "dashed",
             size = 0.5) +
  geom_vline(xintercept = 1.5, 
             linetype = "dashed",
             size = 0.5) +
  geom_vline(xintercept = 7.5,
             linetype = "dashed",
             size = 0.5) +
  # these are for the weather station points
  scale_fill_manual(values = c(brewer.pal(11, "RdYlBu")[c(1,10)]), name = NULL,
                    labels = c("Aboveground\nDaytime", "Aboveground\nNighttime")
                     ) +
  scale_shape_manual(values = 24:25, name = NULL,
                    labels = c("Aboveground\nDaytime", "Aboveground\nNighttime")
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = NULL, labels = "Burrow"
                     ) +
  ylim(-0.01, 5) +
  savs_ggplot_theme +
  theme(plot.margin = margin(t = 0, r = 0, b = 0, l = 9, unit = "pt"),
        legend.margin = margin(0,0,0,0, unit = "pt")) -> daily_VPD_fig
daily_VPD_fig

ggsave(filename = "climate_vpd_standalone.pdf",
       plot = daily_VPD_fig,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 80
       )
```




## Wind

This data is only from the weather station

```{r}
ggplot() +
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = wind_speed_mph_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  xlab("") +
  ylab("Wind Speed (mph)") +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5, #as.Date("2021-04-25"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 1.5, #as.Date("2021-05-08"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 7.5, #as.Date("2021-07-14"),
             linetype = "dashed",
             color = "slategray") +
  scale_fill_manual(values = c("darkred", "darkblue"), name = "Weather Station"
                     ) +
  scale_shape_manual(values = 24:25, name = "Weather Station"
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = "Burrows", labels = ""
                     ) +
  #scale_color_manual(values = my_colors, name = "Sex") +
  #scale_fill_manual(values = my_colors, name = "Sex") +
  #scale_shape_manual(values = my_shapes_open, name = "Sex") +
  #scale_x_discrete(labels = my_labels) +
  #ylim(0, 4.4) + 
  savs_ggplot_theme -> daily_wind_fig
daily_wind_fig
```









# Export Multi-Figure

Put the temperature, RH, and VPD figures arranged into one for publication.

```{r}
daily_temps_fig_multi <- daily_temps_fig + 
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())
daily_RH_fig_multi <- daily_RH_fig + 
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank())


ggarrange(daily_temps_fig_multi, daily_RH_fig_multi, daily_VPD_fig,
          ncol = 1, nrow = 3,
          #ncol = 3, nrow = 1,
          labels = c("A", "B", "C"),
          label.y = c(1.02, 1.02, 1.02),
          label.x = c(-0.02, -0.02, -0.02),
          heights = c(1, 1, 1.11),
          common.legend = TRUE,
          legend = "bottom"
          ) -> multi_climate

ggsave(filename = "climate_multi_figure_vertical.pdf",
       plot = multi_climate,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 190
       #width = 220, height = 80
       )
```

















# Across Years

In addition to looking at how climate changed throughout the G. sila active season of our study, we also want to quantify the local rainfall to help provide evidence for the drought during our study. 


## Prep Data

I am defining winter as Dec to March. We will look at precipitation in this time period each year for our study year and the 3 years prior.

```{r}
dat_ws_compare_years <- dat_ws_clean %>%
  # add a variable for the "year" of the winter period, since it technically spans years
  mutate(year = case_when(date_only >= as.Date("2017-12-01") &
                            date_only < as.Date("2018-03-30") ~ 2018,
                          date_only >= as.Date("2018-12-01") &
                            date_only < as.Date("2019-03-30") ~ 2019,
                          date_only >= as.Date("2019-12-01") &
                            date_only < as.Date("2020-03-30") ~ 2020,
                          date_only >= as.Date("2020-12-01") &
                            date_only < as.Date("2021-03-30") ~ 2021),
         year = factor(year)) %>%
  dplyr::filter(complete.cases(year))

summary(dat_ws_compare_years)
```





## Mean Precip Per Year

What was the cumulative amount of rain for each winter?

```{r}
cum_rain <- dat_ws_compare_years %>%
  group_by(year) %>%
  summarise(winter_precip_in = sum(precip_accum_one_hour_inches, na.rm = TRUE)) %>%
  mutate(winter_precip_mm = winter_precip_in*25.4)
cum_rain

prior_mean_in <- cum_rain %>%
  dplyr::filter(year != 2021) %>%
  summarise(mean(winter_precip_in))

prior_mean_mm <- cum_rain %>%
  dplyr::filter(year != 2021) %>%
  summarise(mean(winter_precip_mm))

2.91/prior_mean_in # inches
73.914/prior_mean_mm #mm (same prop)
```



Precipitation in 2021, our study year, was ~50% that of the previous 3-year average.









