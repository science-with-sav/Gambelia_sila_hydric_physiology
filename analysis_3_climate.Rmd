---
title: "Blunt-nosed Leopard Lizard Data Analysis: Climate at the Study Site"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
`%nin%` = Negate(`%in%`)
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("viridis")) install.packages("viridis")
library("viridis")
if (!require("RColorBrewer")) install.packages("RColorBrewer")
library("RColorBrewer")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
if (!require("weathermetrics")) install.packages("weathermetrics")
library("weathermetrics") # convert F to C
```




# Set Colors & Themes

```{r}
savs_ggplot_theme <- theme_bw() + 
                     theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom"
                           #plot.margin = margin(t = 6, r = 6, b = 0, l = 1, unit = "pt")
                           )
```









# Background











# Load Data


## Sunrise & Sunset

These times were obtained from [NOAA ESRL](https://gml.noaa.gov/grad/solcalc/table.php?lat=35.304442&lon=-120.65925&year=2021).

All sunrise & set times during our study are with saylight savings time in effect (1 hour shift).

sunrise times:

```{r}
sunrises <- read.csv("./data/climate/Carrizo_sunrise_2021.csv")

sunrises_full <- sunrises %>% 
  # put in tidy data format
  pivot_longer(
    cols = !Day, 
    names_to = "month", 
    values_to = "time"
  ) %>%
  # get rid of empty data
  dplyr::filter(time != "") %>%
  dplyr::filter(complete.cases(Day))

sunrises_formatted <- sunrises_full %>% 
  mutate(date = as.POSIXct(paste("2021", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunrise = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)
head(sunrises_formatted)
```


sunset times:

```{r}
sunsets <- read.csv("./data/climate/Carrizo_sunset_2021.csv")

sunsets_full <- sunsets %>% 
  # put in tidy data format
  pivot_longer(
    cols = !Day, 
    names_to = "month", 
    values_to = "time"
  ) %>%
  # get rid of empty data
  dplyr::filter(time != "") %>%
  dplyr::filter(complete.cases(Day))

sunsets_formatted <- sunsets_full %>% 
  mutate(date = as.POSIXct(paste("2021", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunset = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)
head(sunsets_formatted)
```



Then, make versions of the sunrise and sunset times for 2018-2020:

```{r}
# sunsets
sunsets_formatted_2018 <- sunsets_full %>% 
  mutate(date = as.POSIXct(paste("2018", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunset = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)

sunsets_formatted_2019 <- sunsets_full %>% 
  mutate(date = as.POSIXct(paste("2019", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunset = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)

sunsets_formatted_2020 <- sunsets_full %>% 
  mutate(date = as.POSIXct(paste("2020", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunset = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)


sunsets_formatted_all_years <- sunsets_formatted %>%
  rbind(sunsets_formatted_2020) %>%
  rbind(sunsets_formatted_2019) %>%
  rbind(sunsets_formatted_2018)

# sunrises
sunrises_formatted_2018 <- sunrises_full %>% 
  mutate(date = as.POSIXct(paste("2018", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunrise = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)

sunrises_formatted_2019 <- sunrises_full %>% 
  mutate(date = as.POSIXct(paste("2019", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunrise = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)

sunrises_formatted_2020 <- sunrises_full%>% 
  mutate(date = as.POSIXct(paste("2020", month, Day, sep = "-"),
                           format = "%Y-%b-%d"),
         sunrise = as.POSIXct(paste(as.character(date), time, sep = " "))) %>%
  dplyr::select(-time, -Day, -month)

sunrises_formatted_all_years <- sunrises_formatted %>%
  rbind(sunrises_formatted_2020) %>%
  rbind(sunrises_formatted_2019) %>%
  rbind(sunrises_formatted_2018)
```











## Burrows

All burrow data is with daylight savings time in effect (1 hour shift), so it will pair to the sunrise/sunset times correctly.

variables in this dataframe, as named in the following summary:

- vapor pressure deficit, Campbell & Normal 1998

```{r}
dat_HOBO <- read_rds("./data/climate/burrow_HOBOs_BNLL_activeszn_2021.RDS") %>%
  # add sunrise and sunset times
  left_join(sunrises_formatted, by = c('date_only' = 'date')) %>%
  left_join(sunsets_formatted, by = c('date_only' = 'date')) %>%
  group_by(date_only) %>%
  mutate(daytime = case_when(date_time_PST >= sunrise & date_time_PST <= sunset ~ "day",
                             date_time_PST < sunrise ~ "night",
                             date_time_PST > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  ungroup() %>%
  dplyr::select(date_time = date_time_PST,
                date_only, HOBO_ID,
                temp_C, RH_percent, VPD_kPa,
                daytime)
summary(dat_HOBO)
length(unique(dat_HOBO$HOBO_ID))
```






## Cochora Weather Station

This climate data was collected by a weather station 3.7 km due east of the study site: [Cochora Ranch, station ID: CXXC1](https://mesowest.utah.edu/cgi-bin/droman/meso_base_dyn.cgi?stn=CXXC1).

I download data from this weather station from Sept 2017 to Sept 2021 in order to look at trends over time, but I will also subset it.

I had to download it from the website in 1-year chunks, and there is 1 hour of overlap between each sequential file, so I will have to fix that.


variables in this dataframe:

- 

The weather station data is with daylight savings time in effect (1 hour shift), so it will pair with the burrow data correctly. :D

```{r}
# get 
dat_ws <- read_csv("./data/climate/CXXC1_weather_2017to2018.csv") %>%
  rbind(read_csv("./data/climate/CXXC1_weather_2018to2019.csv")) %>%
  rbind(read_csv("./data/climate/CXXC1_weather_2019to2020.csv")) %>%
  rbind(read_csv("./data/climate/CXXC1_weather_2020to2021.csv")) 
# pretty-fy
dat_ws_clean <- dat_ws %>%
  distinct() %>%
  dplyr::select(Station_ID,
                date_time = Date_Time, 
                air_temp_F, 
                RH_percent = relative_humidity_percent, 
                precip_accum_one_hour_inches) %>%
  dplyr::filter(complete.cases(air_temp_F, RH_percent)) %>%
  mutate(date_time = as.POSIXct(date_time, format = "%m/%d/%Y %H:%M"),
         date_only = as.Date(substr(as.character(date_time), 1, 10),
                      format = "%Y-%m-%d"),
         temp_C = fahrenheit.to.celsius(air_temp_F, round = 2),
         # calculate vapor pressure deficit, Campbell & Normal 1998
         e_s_kPa = 0.611 * exp((17.502*temp_C)/(temp_C + 240.97)), # saturation VP
         # VPD
         VPD_kPa = e_s_kPa*(1 - (RH_percent/100))
         ) 

# something to fix...
month = as.numeric(substr(as.character(date_only), 6, 7)),
         
head(dat_ws_clean)
summary(dat_ws_clean)
```



















# Prep Data


## Cochora Subset

Take a subset for weather only during our study to look at more closely:

```{r}
dat_ws_2021BNLL <- dat_ws_clean %>%
  dplyr::filter(date_only > as.Date("2021-04-25") & 
                  date_only < as.Date("2021-07-14")) %>%
  left_join(sunrises_formatted, by = c('date_only' = 'date')) %>%
  left_join(sunsets_formatted, by = c('date_only' = 'date')) %>%
  group_by(date_only) %>%
  mutate(daytime = case_when(date_time >= sunrise & date_time <= sunset ~ "day",
                             date_time < sunrise ~ "night",
                             date_time > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  ungroup() %>%
  dplyr::select(date_time,
                date_only, Station_ID,
                temp_C, RH_percent, VPD_kPa,
                daytime)
summary(dat_ws_2021BNLL)
```




## Join Burrow & Cochora Data

Join the two dataframes for the active season that we studied Blunt-nosed Leopard Lizards.
*not sure I need to do this*



## Daily Means

*If I decide not to split day/nighttime temps, all I need to do is delete the daytime grouping factor from the code in this and the next sections.*


### Burrows 

```{r}
dat_HOBO_means_by_burrow <- dat_HOBO %>%
  # get daily means for each burrow/HOBO, for each date, daytime and nighttime
  # I could consider this step averaging across technical replicates
  group_by(HOBO_ID, date_only#, daytime
           ) %>%
  summarise(temp_C_daily_mean_by_HOBO = mean(temp_C),
            RH_daily_mean_by_HOBO = mean(RH_percent),
            VPD_kPa_daily_mean_by_HOBO = mean(VPD_kPa)
            )
```


### Weather Station 

```{r}
dat_ws_means <- dat_ws_2021BNLL %>%
  # get daily means for each date, daytime and nighttime
  # I could consider this step averaging across technical replicates
  group_by(date_only, daytime
           ) %>%
  summarise(temp_C_daily_mean = mean(temp_C),
            RH_daily_mean = mean(RH_percent),
            VPD_kPa_daily_mean = mean(VPD_kPa)
            )
```



## Date Chunk Means

Now, use daily means to get means across date chunks.

First, create the date chunks:


```{r}
# capture weekend dates
cap_dates <- as.Date(c("2021-04-23", "2021-04-24", "2021-04-25", # April
                        "2021-05-07", "2021-05-08", "2021-05-09"), # May
                     format = "%Y-%m-%d")

# grouping notes by date
group_dates <- data.frame(date_only = c(seq(as.Date("2021-04-26"), 
                                            as.Date("2021-07-13"), by = 1))) %>%
  dplyr::filter(date_only %nin% cap_dates) %>%
  mutate(date_chunks = factor(c(rep("Apr 26 - May 6", 11), 
                                rep("May 10 - 20", 11), 
                                rep("May 21 - 31", 11),
                                rep("Jun 1 - 11", 11),
                                rep("Jun 12 - 22", 11),
                                rep("Jun 23 - Jul 3", 11), 
                                rep("Jul 4 - 13", 10)),
                              levels = c("Apr 26 - May 6", "May 10 - 20", 
                                         "May 21 - 31", "Jun 1 - 11", "Jun 12 - 22", 
                                         "Jun 23 - Jul 3", "Jul 4 - 13")))
head(group_dates)
```




### Burrows

Join date chunks & daily mean data, then get the mean daily temps for that date chunk:

```{r}
dat_HOBO_chunks_by_burrow <- dat_HOBO_means_by_burrow %>%
  # add date chunks
  left_join(group_dates, by = 'date_only') %>%
  # remove NA values for date chunks (data on capture days, just for consistency)
  dplyr::filter(complete.cases(date_chunks)) %>%
  # get avg across days within a chunk for each HOBO
  group_by(HOBO_ID, date_chunks#, daytime
           ) %>%
  # get the avg of the avg daily mean (not sure if this is how I want to calculate?)
  summarise(temp_C_chunk_mean_by_HOBO = mean(temp_C_daily_mean_by_HOBO),
            RH_chunk_mean_by_HOBO = mean(RH_daily_mean_by_HOBO),
            VPD_kPa_chunk_mean_by_HOBO = mean(VPD_kPa_daily_mean_by_HOBO),
            n = n()
            ) %>%
  # only use an avg for a date chunk for a HOBO with at least 3 days in that chunk
  # removes 6 values
  dplyr::filter(n >= 3) %>%
  arrange(HOBO_ID, date_chunks) 
```


### Weather Station

*NOTES* SEM might be better for the error bars after all, since this would be SD for the weather station... or would it?

Maybe I just plot these averages as single points... 

```{r}
dat_ws_chunk_means <- dat_ws_means %>%
  # add date chunks
  left_join(group_dates, by = 'date_only') %>%
  # remove NA values for date chunks (data on capture days, just for consistency)
  dplyr::filter(complete.cases(date_chunks)) %>%
  # get avg across days within a chunk for both daytime and nighttime 
  group_by(date_chunks, daytime
           ) %>%
  # get the avg of the avg daily mean (not sure if this is how I want to calculate?)
  summarise(temp_C_chunk_mean = mean(temp_C_daily_mean),
            RH_chunk_mean = mean(RH_daily_mean),
            VPD_kPa_chunk_mean = mean(VPD_kPa_daily_mean),
            n = n()
            )
```





# Statistics

My goal now is to calculate the emmeans, CI, and pairwise differences across HOBOs for each date chunk. **I need to do this for each climate variable, temperature, RH, and VPD.**

Then, I can use the emmeans +/- CI for plotting.

**NOTE** day vs night values are NOT different for burrows, so I think I should go back and remove that as a grouping variable, but that would require me also not using it as a grouping variable for the weather station data...

## HOBO Temperature

```{r}
HOBO_temp_lm <- lm(data = dat_HOBO_chunks_by_burrow,
                   temp_C_chunk_mean_by_HOBO ~ date_chunks #* daytime
                   )
#summary(HOBO_temp_lm)
HOBO_temp_emmean <- data.frame(emmeans(HOBO_temp_lm, "date_chunks")) %>%
  # add ref for plots
  mutate(type = "Burrow")
HOBO_temp_pairwise <- pairs(emmeans(HOBO_temp_lm, "date_chunks"))
HOBO_temp_pairwise
```

burrow temperature pairwise comparisons that are *not* different, so will have the same letter when I make figures:

- (May 10 - 20) - (May 21 - 31)
- (Jun 1 - 11) - (Jun 12 - 22)
- (Jun 23 - Jul 3) - (Jul 4 - 13)

burrow temperature pairwise comparison groups for when I make figures:

- Apr 26 - May 6 = A
- May 10 - 20 = B
- May 21 - 31 = B
- Jun 1 - 11 = C
- Jun 12 - 22 = C
- Jun 23 - Jul 3 = D
- Jul 4 - 13 = D


## HOBO RH

```{r}
HOBO_RH_lm <- lm(data = dat_HOBO_chunks_by_burrow,
                   RH_chunk_mean_by_HOBO ~ date_chunks #* daytime
                   )
#summary(HOBO_temp_lm)
HOBO_RH_emmean <- data.frame(emmeans(HOBO_RH_lm, "date_chunks")) %>%
  # add ref for plots
  mutate(type = "Burrow")
HOBO_RH_pairwise <- pairs(emmeans(HOBO_RH_lm, "date_chunks"))
HOBO_RH_pairwise
```

burrow humidity pairwise comparison groups for when I make figures:

- Apr 26 - May 6 = A
- May 10 - 20 = AB
- May 21 - 31 = AB
- Jun 1 - 11 = AB
- Jun 12 - 22 = AB
- Jun 23 - Jul 3 = AB
- Jul 4 - 13 = B






## HOBO VPD

```{r}
HOBO_VPD_lm <- lm(data = dat_HOBO_chunks_by_burrow,
                   VPD_kPa_chunk_mean_by_HOBO ~ date_chunks #* daytime
                   )
#summary(HOBO_temp_lm)
HOBO_VPD_emmean <- data.frame(emmeans(HOBO_VPD_lm, "date_chunks")) %>%
  # add ref for plots
  mutate(type = "Burrow")
HOBO_VPD_pairwise <- pairs(emmeans(HOBO_VPD_lm, "date_chunks"))
HOBO_VPD_pairwise
```

burrow VPD pairwise comparison groups for when I make figures:

- (Apr 26 - May 6) - (May 10 - 20) - (May 21 - 31) = A
- (May 10 - 20) - (May 21 - 31) - (Jun 1 - 11) = B
- (Jun 1 - 11) - (Jun 12 - 22) = C
- (Jun 12 - 22) - (Jun 23 - Jul 3) - (Jul 4 - 13) = D




## WS?

```{r}
ws_VPD_lm <- lm(data = dat_ws_chunk_means,
                   VPD_kPa_chunk_mean ~ date_chunks * daytime
                   )
summary(ws_VPD_lm)
ws_VPD_emmean <- data.frame(emmeans(ws_VPD_lm, "date_chunks")) %>%
  # add ref for plots
  mutate(type = "Burrow")
ws_VPD_pairwise <- pairs(emmeans(ws_VPD_lm, "date_chunks"))
ws_VPD_pairwise
```





















# Figures

## Temperature

```{r}
ggplot() +
  geom_jitter(data = dat_HOBO_chunks_by_burrow,
             aes(x = date_chunks,
                 y = temp_C_chunk_mean_by_HOBO,
                 #shape = ,
                 #color = ,
                 #fill = 
                 ),
             alpha = 0.3,
             size = 0.9,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_line(data = HOBO_temp_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 group = 1 # tell ggplot it's okay to only have 1 obs per x value
                 ),
             alpha = 0.2,
             size = 0.5) +
  geom_point(data = HOBO_temp_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 color = type
                 ),
             alpha = 1,
             size = 2) +
  geom_errorbar(data = HOBO_temp_emmean,
                aes(x = as.numeric(date_chunks)-0.1,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL
                    ),
                width = .2) +
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = temp_C_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  xlab("") + 
  ylab("Temperature (°C)") +
  # date chunk differences
  annotate(geom = "text", x = 1, y = 36, label = "A", size = 3) +
  annotate(geom = "text", x = 2, y = 36, label = "B", size = 3) +
  annotate(geom = "text", x = 3, y = 36, label = "B", size = 3) +
  annotate(geom = "text", x = 4, y = 36, label = "C", size = 3) +
  annotate(geom = "text", x = 5, y = 36, label = "C", size = 3) +
  annotate(geom = "text", x = 6, y = 36, label = "D", size = 3) +
  annotate(geom = "text", x = 7, y = 36, label = "D", size = 3) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5, #as.Date("2021-04-25"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 1.5, #as.Date("2021-05-08"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 7.5, #as.Date("2021-07-14"),
             linetype = "dashed",
             color = "slategray") +
  # these are for the weather station points
  scale_fill_manual(values = c("darkred", "darkblue"), name = "Weather Station"
                     ) +
  scale_shape_manual(values = 24:25, name = "Weather Station"
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = "Burrows", labels = ""
                     ) +
  #scale_fill_manual(values = my_colors, name = "Sex") +
  #scale_x_discrete(labels = my_labels) +
  ylim(16, 36) +
  savs_ggplot_theme -> daily_temps_fig
daily_temps_fig
```


## Relative Humidity

```{r}
ggplot() +
  geom_jitter(data = dat_HOBO_chunks_by_burrow,
             aes(x = date_chunks,
                 y = RH_chunk_mean_by_HOBO,
                 #shape = ,
                 #color = ,
                 #fill = 
                 ),
             alpha = 0.3,
             size = 0.9,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_line(data = HOBO_RH_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 group = 1 # tell ggplot it's okay to only have 1 obs per x value
                 ),
             alpha = 0.2,
             size = 0.5) +
  geom_point(data = HOBO_RH_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 color = type
                 ),
             alpha = 1,
             size = 2) +
  geom_errorbar(data = HOBO_RH_emmean,
                aes(x = as.numeric(date_chunks)-0.1,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL
                    ),
                width = .2) +
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = RH_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  xlab("") +
  ylab("Relative Humidity (%)") +
  # date chunk differences
  annotate(geom = "text", x = 1, y = 105, label = "A", size = 3) +
  annotate(geom = "text", x = 2, y = 105, label = "AB", size = 3) +
  annotate(geom = "text", x = 3, y = 105, label = "AB", size = 3) +
  annotate(geom = "text", x = 4, y = 105, label = "AB", size = 3) +
  annotate(geom = "text", x = 5, y = 105, label = "AB", size = 3) +
  annotate(geom = "text", x = 6, y = 105, label = "AB", size = 3) +
  annotate(geom = "text", x = 7, y = 105, label = "B", size = 3) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5, #as.Date("2021-04-25"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 1.5, #as.Date("2021-05-08"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 7.5, #as.Date("2021-07-14"),
             linetype = "dashed",
             color = "slategray") +
  # these are for the weather station points
  scale_fill_manual(values = c("darkred", "darkblue"), name = "Weather Station"
                     ) +
  scale_shape_manual(values = 24:25, name = "Weather Station"
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = "Burrows", labels = ""
                     ) +
  #scale_color_manual(values = my_colors, name = "Sex") +
  #scale_fill_manual(values = my_colors, name = "Sex") +
  #scale_shape_manual(values = my_shapes_open, name = "Sex") +
  #scale_x_discrete(labels = my_labels) +
  ylim(0, 105) + 
  savs_ggplot_theme -> daily_RH_fig
daily_RH_fig
```


## Vapor Pressure Deficit

```{r}
ggplot() +
  geom_jitter(data = dat_HOBO_chunks_by_burrow,
             aes(x = date_chunks,
                 y = VPD_kPa_chunk_mean_by_HOBO,
                 #shape = ,
                 #color = ,
                 #fill = 
                 ),
             alpha = 0.3,
             size = 0.9,
              position = position_jitter(height = 0, width = 0.2)) +
  geom_line(data = HOBO_VPD_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 group = 1 # tell ggplot it's okay to only have 1 obs per x value
                 ),
             alpha = 0.2,
             size = 0.5) +
  geom_point(data = HOBO_VPD_emmean,
             aes(x = as.numeric(date_chunks)-0.1,
                 y = emmean,
                 color = type
                 ),
             alpha = 1,
             size = 2) +
  geom_errorbar(data = HOBO_VPD_emmean,
                aes(x = as.numeric(date_chunks)-0.1,
                    y = emmean, 
                    ymin = lower.CL,
                    ymax = upper.CL
                    ),
                width = .2) +
  geom_point(data = dat_ws_chunk_means,
             aes(x = as.numeric(date_chunks)+0.1,
                 y = VPD_kPa_chunk_mean,
                 fill = daytime,
                 shape = daytime
                 ),
             alpha = 1,
             size = 2) +
  xlab("") +
  ylab("Vapor Pressure Deficit (kPa)") +
  # date chunk differences
  annotate(geom = "text", x = 1, y = 4.4, label = "A", size = 3) +
  annotate(geom = "text", x = 2, y = 4.4, label = "AB", size = 3) +
  annotate(geom = "text", x = 3, y = 4.4, label = "AB", size = 3) +
  annotate(geom = "text", x = 4, y = 4.4, label = "BC", size = 3) +
  annotate(geom = "text", x = 5, y = 4.4, label = "CD", size = 3) +
  annotate(geom = "text", x = 6, y = 4.4, label = "D", size = 3) +
  annotate(geom = "text", x = 7, y = 4.4, label = "D", size = 3) +
  # lines to show when we took hydric physiology measurements
  geom_vline(xintercept = 0.5, #as.Date("2021-04-25"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 1.5, #as.Date("2021-05-08"),
             linetype = "dashed",
             color = "slategray") +
  geom_vline(xintercept = 7.5, #as.Date("2021-07-14"),
             linetype = "dashed",
             color = "slategray") +
  scale_fill_manual(values = c("darkred", "darkblue"), name = "Weather Station"
                     ) +
  scale_shape_manual(values = 24:25, name = "Weather Station"
                     ) +
  # these are for the burrow emmean points
  scale_color_manual(values = "black", name = "Burrows", labels = ""
                     ) +
  #scale_color_manual(values = my_colors, name = "Sex") +
  #scale_fill_manual(values = my_colors, name = "Sex") +
  #scale_shape_manual(values = my_shapes_open, name = "Sex") +
  #scale_x_discrete(labels = my_labels) +
  #ylim(0, 4.4) + 
  savs_ggplot_theme -> daily_VPD_fig
daily_VPD_fig
```









# Export Multi-Figure

```{r}
ggarrange(daily_temps_fig, daily_RH_fig, daily_VPD_fig,
          ncol = 1, nrow = 3,
          labels = c("A", "B", "C"),
          common.legend = TRUE,
          legend = "bottom"
          ) -> multi_climate

ggsave(filename = "climate_multi_figure.pdf",
       plot = multi_climate,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 80, height = 200)
```

















# Across Years


## Prep Data

Winter is ~ Dec to March. We will look at precipitation in this time period.

BNLL active season is April - July. We will look at temp, RH, and VPD during this time period.

So, I want to add grouping variables for time period: "winter" / "active season"; and year (of active season): 2018, 2019, 2020, 2021.


```{r}
dat_ws_compare_years <- dat_ws_clean %>%
  mutate(year = case_when(date_only >= as.Date("2017-12-01") &
                            date_only < as.Date("2018-08-01") ~ 2018,
                          date_only >= as.Date("2018-12-01") &
                            date_only < as.Date("2019-08-01") ~ 2019,
                          date_only >= as.Date("2019-12-01") &
                            date_only < as.Date("2020-08-01") ~ 2020,
                          date_only >= as.Date("2020-12-01") &
                            date_only < as.Date("2021-08-01") ~ 2021),
         year = factor(year)) %>%
  dplyr::filter(complete.cases(year)) %>%
  mutate(season = case_when(month %in% c(12, 1, 2, 3) ~ "Winter",
                            month %in% c(4:7) ~ "Active Season"),
         season = factor(season))
summary(dat_ws_compare_years)
```





## Mean Precip Per Year

What was the cumulative amount of rain for each winter?

```{r}
cum_rain <- dat_ws_compare_years %>%
  dplyr::filter(season == "Winter") %>%
  group_by(year) %>%
  summarise(winter_precip_in = sum(precip_accum_one_hour_inches, na.rm = TRUE))
cum_rain
```





## Means Per Year/Season

Make a table of the (monthly?) means per year per season.

```{r}
annual_climate <- dat_ws_compare_years %>%
  # during the active season only
  dplyr::filter(season == "Active Season") %>%
  # add sunrise/sunset to calculate daytimes only
  left_join(sunsets_formatted_all_years, by = c('date_only' = 'date')) %>%
  left_join(sunrises_formatted_all_years, by = c('date_only' = 'date')) %>%
  mutate(daytime = case_when(date_time >= sunrise & date_time <= sunset ~ "day",
                             date_time < sunrise ~ "night",
                             date_time > sunset ~ "night"),
         daytime = as.factor(daytime)) %>%
  # get daily means first
  group_by(date_only, year, month, daytime) %>%
  summarise(temp_C_daily_mean = mean(temp_C),
            RH_daily_mean = mean(RH_percent),
            VPD_kPa_daily_mean = mean(VPD_kPa)) %>%
  # avg daily means per month
  group_by(year, month, daytime) %>%
  summarise(temp_C_mean = mean(temp_C_daily_mean),
            RH_mean = mean(RH_daily_mean),
            VPD_kPa_mean = mean(VPD_kPa_daily_mean),
            temp_C_sd = sd(temp_C_daily_mean),
            RH_sd = sd(RH_daily_mean),
            VPD_kPa_sd = sd(VPD_kPa_daily_mean))

summary(annual_climate)
annual_climate
```


rearrange the monthly values into cleaner format for joining:

```{r}
annual_climate_cleaned <- annual_climate %>%
  dplyr::filter(daytime == "day") %>%
  mutate(temp = paste(round(temp_C_mean, 1), 
                             round(temp_C_sd, 1),
                             sep = " ± "),
         RH = paste(round(RH_mean, 1), 
                             round(RH_sd, 1),
                             sep = " ± "),
         VPD = paste(round(VPD_kPa_mean, 1), 
                             round(VPD_kPa_sd, 1),
                             sep = " ± ")) %>%
  dplyr::select(year, month, temp, RH, VPD) %>%
  # get rid of month grouping so it lets me delete that column
  ungroup()
annual_climate_cleaned

# split for April
annual_climate_cleaned_April <- annual_climate_cleaned %>%
  dplyr::filter(month == 4) %>%
  dplyr::select(year,
                April_temp = temp,
                April_RH = RH,
                April_VPD = VPD)
# split for May
annual_climate_cleaned_May <- annual_climate_cleaned %>%
  dplyr::filter(month == 5) %>%
  dplyr::select(year,
                May_temp = temp,
                May_RH = RH,
                May_VPD = VPD)
# split for June
annual_climate_cleaned_June <- annual_climate_cleaned %>%
  dplyr::filter(month == 6) %>%
  dplyr::select(year,
                June_temp = temp,
                June_RH = RH,
                June_VPD = VPD)
# split for July
annual_climate_cleaned_July <- annual_climate_cleaned %>%
  dplyr::filter(month == 7) %>%
  dplyr::select(year,
                July_temp = temp,
                July_RH = RH,
                July_VPD = VPD)
```




## Pretty Table

Now, put all the monthly values back together with the rainfall stats and microhabitat use stats.

Rainfall and climate stats were calculated above. For the microhabitat use, I am estimating the proportion of time (out of 1) that BNLL spent belowground; I eyeball this from Kat and Nicole's figures for now, and use my average monthly values from 'analysis_2'. 2020 does not have microhabitat use data published yet...


- Kat results (2018):
    - May = 37-39% in burrows
    - June = 65% in burrows
    - July = 81% in burrows
- Nicole results (2019):
    - May = 25-26% time in burrows at Shrubbed (my site)
    - June = 31% time in burrows at Shrubbed
    - July = 43% time in burrows at Shrubbed
- my results ('analysis_2' file, 2021):
    - May = 
    - June = 
    - July = 
    

```{r}
annual_climate_rainfall <- cum_rain %>%
  left_join(annual_climate_cleaned_April, by = 'year') %>%
  left_join(annual_climate_cleaned_May, by = 'year') %>%
  left_join(annual_climate_cleaned_June, by = 'year') %>%
  left_join(annual_climate_cleaned_July, by = 'year') %>%
  # reorder by variable
  dplyr::select(year, winter_precip_in,
                April_temp, May_temp, June_temp, July_temp,
                April_RH, May_RH, June_RH, July_RH,
                April_VPD, May_VPD, June_VPD, July_VPD) %>%
  # no microhabitat use for April in any years
  # add microhabitat use for May-July
  mutate(May_prop_below = c(0.38, 0.25, NA, 0.22),
         June_prop_below = c(0.65, 0.31, NA, 0.52),
         July_prop_below = c(0.81, 0.43, NA, 0.74))
annual_climate_rainfall
annual_climate_rainfall_transposed <- data.frame(t(annual_climate_rainfall)) %>%
  mutate(X0 = rownames(.))
```




And export that pretty table! :D

```{r}
write_csv(annual_climate_rainfall_transposed, 
          "./results_statistics/climate_across_years_vertical.csv")
```







