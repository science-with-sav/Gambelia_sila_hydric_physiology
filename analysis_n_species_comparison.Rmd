---
title: "CEWL species comparison"
author: "Savannah Weaver"
output: 
  rmdformats::html_clean:
    highlight: tango
    thumbnails: FALSE
    toc: TRUE
    toc_depth: 3
---


# Packages

```{r setup, echo=T, results='hide', message=FALSE}
if (!require("tidyverse")) install.packages("tidyverse") 
library("tidyverse")# for dplyr workflow of calculations
if (!require("UsingR")) install.packages("UsingR") 
library("UsingR")
if (!require("lme4")) install.packages("lme4") 
library("lme4")
if (!require("lmerTest")) install.packages("lmerTest") 
library("lmerTest")
if (!require("broom")) install.packages("broom")
library("broom") # lmer model export
if (!require("broom.mixed")) install.packages("broom.mixed")
library("broom.mixed") # lmer model export
if (!require("ggplot2")) install.packages("ggplot2")
library("ggplot2")
if (!require("ggpubr")) install.packages("ggpubr")
library("ggpubr") # for multi-ggplot figs
if (!require("Hmisc")) install.packages("Hmisc")
library("Hmisc") # correlation matrix
if (!require("emmeans")) install.packages("emmeans")
library("emmeans") # marginal means & confints
```




# Background



look at CEWL-osml distribution for BNLL & WFL
look at CEWL diffs for BNLL, WFL, and AWL















# Load Data




## *Gambelia sila* Data

```{r load Gambelia data}
BNLL_dat <- read_rds("./data/G_sila_clean_full_dat.RDS") %>% 
  dplyr::select(date = capture_date, individual_ID, 
                CEWL_g_m2h,
                msmt_temp_C,
                msmt_RH_percent,
                osmolality_mmol_kg = osmolality_mmol_kg_mean,
                sex_M_F, mass_g, SVL_mm) %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg, msmt_temp_C)) %>%
  # add column for species
  mutate(species = "Gambelia sila",
         group = "G")
summary(BNLL_dat)
```






## *Sceloporus occidentalis* Data


```{r load Sceloporus data}
Sceloporus_study1 <- read_rds("./data/Sceloporus_2021_CURE.RDS") %>%
  dplyr::filter(region == "Dorsum") %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg)) %>% 
  dplyr::select(date, individual_ID, 
                CEWL_g_m2h = TEWL_g_m2h,
                msmt_temp_C = ambient_temp_C,
                msmt_RH_percent = ambient_RH_percent,
                osmolality_mmol_kg,
                sex_M_F, mass_g, SVL_mm) %>%
  mutate(sex_M_F = factor(sex_M_F, labels = c("Female", "Male")),
         group = "A")
Sceloporus_study2 <- read_rds("./data/Sceloporus_2021_exp.RDS") %>%
  dplyr::filter(complete.cases(osmolality_mmol_kg_mean)) %>% 
  dplyr::select(date = capture_date, individual_ID, 
                CEWL_g_m2h = CEWL_g_m2h_mean,
                msmt_temp_C,
                msmt_RH_percent,
                osmolality_mmol_kg = osmolality_mmol_kg_mean,
                mass_g, SVL_mm) %>%
  mutate(sex_M_F = factor("Male"),
         group = "B")
  
Sceloporus <- Sceloporus_study2 %>% 
  #rbind(Sceloporus_study1, Sceloporus_study2) %>%
  # add column for species
  mutate(species = "Sceloporus occidentalis")
summary(Sceloporus)
```



## *Podarcis* Data

```{r load Podarcis data}
Podarcis <- read_csv("./data/Podarcis_2022.csv") %>%
  dplyr::filter(Body == "Dorsum") %>%
  dplyr::select(date = Date, individual_ID = ID, 
                #sex_M_F = Sex, mass_g = Mass, SVL_mm = SVL,
                CEWL_g_m2h = CEWL_g_m2h_mean,
                msmt_temp_C, msmt_RH_percent) %>%
  mutate(date = as.Date(date, format = "%m/%d/%y"),
         individual_ID = factor(individual_ID),
         #sex_M_F = factor(sex_M_F),
         species = "Podarcis erhardii",
         # calculate VPD based on Campbell & Norman 1998
         e_s_kPa = 0.611 * exp((17.502*msmt_temp_C)/(msmt_temp_C + 240.97)),
         msmt_VPD_kPa = e_s_kPa*(1 - (msmt_RH_percent/100)))
summary(Podarcis)
```


## Merge S.o. and G.s.

```{r merge}
dat_all_liz <- BNLL_dat %>%
  rbind(Sceloporus) %>%
  mutate(species = factor(species),
         # calculate VPD based on Campbell & Norman 1998
         e_s_kPa = 0.611 * exp((17.502*msmt_temp_C)/(msmt_temp_C + 240.97)),
         msmt_VPD_kPa = e_s_kPa*(1 - (msmt_RH_percent/100))
         ) 
summary(dat_all_liz)
```











# Check Distributions


## Covariates

First, I need to check that the conditions measurements were taken in mostly overlapped for the two species.

```{r}
ggplot(dat_all_liz) +
  aes(x = msmt_temp_C,
      y = CEWL_g_m2h,
      color = group) +
  geom_point()
ggplot(dat_all_liz) +
  aes(x = msmt_RH_percent,
      y = CEWL_g_m2h,
      color = group) +
  geom_point()
ggplot(dat_all_liz) +
  aes(x = msmt_VPD_kPa,
      y = CEWL_g_m2h,
      color = group) +
  geom_point()
```



## Body Sizes

Also get stats on how different the two species are.

```{r}
ggplot(dat_all_liz) +
  aes(x = SVL_mm,
      y = mass_g,
      color = group) +
  geom_point()
dat_all_liz %>%
  group_by(species, sex_M_F) %>% 
  summarise(mean_SVL_mm = mean(SVL_mm),
            mean_mass = mean(mass_g))
```















# Compare Hydric Physiology


## Stats

```{r}
# osmolality
sp_lm_osml <- lm(data = dat_all_liz, osmolality_mmol_kg ~ species)
osml_emmean <- data.frame(emmeans(sp_lm_osml, "species")) %>%
  rename(osml_emmean = emmean,
         osml_lower = lower.CL,
         osml_upper = upper.CL)
pairs(emmeans(sp_lm_osml, "species"))

# CEWL
sp_lm_CEWL <- lm(data = dat_all_liz, CEWL_g_m2h ~ species)
CEWL_emmean <- data.frame(emmeans(sp_lm_CEWL, "species")) %>%
  rename(CEWL_emmean = emmean,
         CEWL_lower = lower.CL,
         CEWL_upper = upper.CL)
pairs(emmeans(sp_lm_CEWL, "species"))

# put marginal means together
both_emmeans <- osml_emmean %>%
  left_join(CEWL_emmean, by = 'species')
```



## CEWL Osml Fig



```{r}
# custom, consistent legend labels
my_labels <- c(expression(italic("Gambelia sila")),
               expression(italic("Sceloporus occidentalis")))

ggplot() +
  # all data
  geom_point(data = dat_all_liz,
             aes(x = osmolality_mmol_kg,
                  y = CEWL_g_m2h,
                  fill = species,
                 color = species,
                  shape = species),
             alpha = 0.3) + 
  # group
  stat_ellipse(data = dat_all_liz,
             aes(x = osmolality_mmol_kg,
                  y = CEWL_g_m2h,
                  color = species),
             size = 0.5,
               show.legend = FALSE) +
  # mean points
  geom_point(data = both_emmeans,
             aes(x = osml_emmean,
                 y = CEWL_emmean,
                 fill = species,
                 shape = species),
             size = 5,
             color = "black") + 
  #geom_errorbar(data = both_emmeans,
   #             aes(x = osml_emmean,
    #                y = CEWL_emmean,
     #               xmin = osml_lower,
      #              xmax = osml_upper,
       #             ymin = CEWL_lower,
        #            ymax = CEWL_upper)) +
  scale_fill_manual(values = c("Orange", "Blue"), labels = my_labels, name = NULL) +
  scale_color_manual(values = c("Orange", "Blue"), labels = my_labels, name = NULL) +
  scale_shape_manual(values = c(21:22), labels = my_labels, name = NULL) +
  xlab(bquote('Plasma Osmolality (mmol '*kg^-1*')')) +
  ylab(bquote('CEWL (g '*m^-2*' '*h^-1*')')) +
  theme_classic() +
  theme(text = element_text(color = "black", 
                                               family = "sans", 
                                               size = 12),
                           axis.text = element_text(color = "black", 
                                                    family = "sans", 
                                                    size = 8),
                           legend.text = element_text(color = "black", 
                                                      family = "sans", 
                                                      size = 8),
                           legend.text.align = 0,
                           legend.position = "bottom",
                           #plot.margin = margin(t = 6, r = 6, b = 0, l = 1, unit = "pt")
                           ) -> Scelop_BNLL_pts

ggsave(filename = "Scelop_BNLL_compare.pdf",
       plot = Scelop_BNLL_pts,
       path = "./results_figures",
       device = "pdf",
       dpi = 600,
       units = "mm",
       width = 160, height = 120)
```















# old



```{r}
sp_compare$species <- factor(sp_compare$species,
                             levels = c("S. occidentalis", "G. sila"))

sp_compare_means <- sp_compare %>%
  group_by(species) %>%
  summarise(mean_CEWL = mean(CEWL_g_m2h, na.rm = TRUE),
            sd_CEWL = sd(CEWL_g_m2h, na.rm = TRUE),
            min_CEWL = min(CEWL_g_m2h, na.rm = TRUE),
            max_CEWL = max(CEWL_g_m2h, na.rm = TRUE),
            range_CEWL = max_CEWL - min_CEWL)
sp_compare_means
```

I think I should present in the figure caption as mean ± SD (range).

So, "Mean ± SD (range) are as follows: S. occidentalis: 21.4 ± 6.6 (4.0 - 49.0); G. sila: 10.2 ± 4.0 (0.6 - 21.0)."


## Model Compare Avg CEWL

```{r model sp compare CEWL}
sp_compare_mod <- lm(data = sp_compare, CEWL_g_m2h ~ species)
summary(sp_compare_mod)
```


## Plot Compare Avg CEWL

this is the grand mean across dates and sexes

```{r compare sp CEWL}
ggplot() + 
  geom_boxplot(data = sp_compare,
               aes(x = species, 
                   y = CEWL_g_m2h, 
                color = species), 
               alpha = 1) +
  geom_point(data = sp_compare_means,
               aes(x = species, 
                   y = mean_CEWL, 
                color = species), 
               size = 6,
               alpha = 1) +
  theme_classic() + 
  xlab("") + 
  ylim(0, 55) +
  scale_y_continuous(breaks = c(0, 10, 20, 30, 40 , 50)) +
  ylab(bquote('CEWL (g/'*m^2*'h)')) + 
  annotate("text", x = 1.5, y = 50, label = "p < 0.0001", size = 6) +
  scale_color_brewer(palette = "Set2") +
  theme(text = element_text(color = "black", 
                            family = "sans", 
                            size = 18),
        axis.text = element_text(color = "black", 
                                 family = "sans", 
                                 size = 14),
        legend.text.align = 0,
        legend.position = "none"
) -> CEWL_compare_sp
CEWL_compare_sp

# export figure
ggsave(filename = "CEWL_BNLL_vs_WFL.jpeg",
       plot = CEWL_compare_sp,
       path = "./results_figures",
       device = "jpeg",
       dpi = 1200,
       width = 6, height = 4)
```

